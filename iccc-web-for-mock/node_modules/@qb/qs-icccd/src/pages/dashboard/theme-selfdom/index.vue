<template>
  <div
    class="bs-theme"
    :style="{ backgroundImage: 'url(' + (coverImgUrl ? coverImgUrl : '') + ')' }"
    :class="
      coverImgUrl
        ? ''
        : mark == 0
        ? 'indexBg0'
        : mark == 1
        ? 'indexBg1'
        : mark == 2
        ? 'indexBg2'
        : mark == 3
        ? 'indexBg3'
        : ''
    "
  >
    <!--主要内容 begin-->
    <div class="bs-theme-cont">
      <!--标题 begin-->
      <div class="bs-theme-title">
        <img src="../../../assets/images/dashboard/selfdom__logo.png" alt="" />
        <span class="skinIcon" :class="isShow ? 'hoverSkin' : ''" id="skinIcon"
          ><i class="icon iconl-skin" @click="changeBg"></i
        ></span>
        <setting
          height="66px"
          fontSize="22px"
          padding="6px 4px 5px"
          class="settingBtn"
          v-permission="['XTGL']"
        ></setting>
        <span class="logout"><i class="icon iconl-poweroff " @click="logout()"></i></span>
      </div>
      <!--标题 end-->

      <!--左侧内容 begin-->
      <div class="bs-theme-cont-left">
        <div>
          <div class="bs-home-man">
            <img src="../../../../static/icccd/images/demo/icon__default.png" alt="" />
            <div class="is-name">{{ name }}</div>
          </div>
          <backlog
            :backlogData="taskList"
            @executeFun="executeFun($event)"
            :isShowMore="taskList.length ? true : false"
          ></backlog>
        </div>
      </div>
      <!--左侧内容 end-->

      <!--右侧内容 begin-->
      <div class="bs-theme-cont-right">
        <div style="width: 100%;">
          <!--时间 begin-->
          <div class="bs-home-time__box">
            <span class="is-time">{{ currentDate() }}</span>
          </div>
          <!--时间 end-->
          <!--数据总数展示 begin-->
          <total-exhibition
            :bszs="toThousandsSpecial(countData.bszs, 'font-size:12px', 1)"
            :qkrs="toThousandsSpecial(countData.qkrs, 'font-size:12px', 1)"
            :wxsjrs="toThousandsSpecial(countData.wxsjrs, 'font-size:12px', 1)"
          ></total-exhibition>
          <!--数据总数展示 end-->
        </div>
        <!--功能模块 begin-->
        <div class="is-module">
          <home-module :data="homeModuleData[0]" style="margin-left: 12%;width: 86%;  margin-bottom: 12px; flex: 1.1;">
            <div slot="applyModule" style="margin-right: 2rem;">
              <div :class="['bs-home-apply__box', !checkPermission([homeModuleData[0].rights]) ? 'is-disabled' : '']">
                <div class="is-title">申请数</div>
                <div class="is-num" v-html="toThousandsSpecial(countData.sqzs, 'font-size:12px', 1)"></div>
                <div class="bs-home-apply">
                  <div class="is-num">
                    <el-tooltip content="通过数" placement="top" effect="dark">
                      <div>
                        <i class="icon iconf-through"></i>
                      </div>
                    </el-tooltip>
                    <span v-html="toThousandsSpecial(countData.tgrs, 'font-size:12px', 1)"></span>
                  </div>
                  <div class="is-num is-yellow">
                    <el-tooltip content="未通过数" placement="top" effect="dark">
                      <div>
                        <i class="icon iconf-fail"></i>
                      </div>
                    </el-tooltip>
                    <span v-html="toThousandsSpecial(countData.btgrs, 'font-size:12px', 1)"></span>
                  </div>
                </div>
              </div>
            </div>
          </home-module>
          <div style="display: flex;  margin-bottom: 12px; flex: 1;">
            <home-module :data="homeModuleData[1]" style=""></home-module>
            <home-module :data="homeModuleData[2]" style="margin-left: 1rem;"></home-module>
          </div>
          <div style="margin-bottom: 12px;display: flex;margin-left: 10%;width: 88%; flex: 1;">
            <home-module :data="homeModuleData[5]"></home-module>
            <div
              :data="homeModuleSecondData"
              :class="[
                'bs-home-module-second',
                !checkPermission([homeModuleSecondData.check.rights]) &&
                !checkPermission([homeModuleSecondData.recheck.rights])
                  ? 'is-disabled'
                  : ''
              ]"
            >
              <div class="bs-home-module-second__title">审核复核</div>
              <div class="bs-home-module-second__cont">
                <div
                  :class="['is-left', !checkPermission([homeModuleSecondData.check.rights]) ? 'is-disabled' : '']"
                  @click="openFun('/bs-audit', homeModuleSecondData.check)"
                >
                  <i :class="['icon', homeModuleSecondData.check.icon]"></i>
                  <div class="is-name">{{ homeModuleSecondData.check.name }}</div>
                </div>
                <div
                  :class="['is-right', !checkPermission([homeModuleSecondData.recheck.rights]) ? 'is-disabled' : '']"
                  @click="openFun('/bs-review', homeModuleSecondData.recheck)"
                >
                  <i :class="['icon', homeModuleSecondData.recheck.icon]"></i>
                  <div class="is-name">{{ homeModuleSecondData.recheck.name }}</div>
                </div>
              </div>
            </div>
          </div>
          <div style="display: flex; flex: 1;">
            <home-module :data="homeModuleData[3]" style=""></home-module>
            <home-module :data="homeModuleData[4]" style="margin-left: 1rem;"></home-module>
          </div>
        </div>
        <!--功能模块 begin-->
      </div>
      <!--右侧内容 end-->
    </div>
    <!--主要内容 end-->
    <!--换肤-->
    <change-bg
      v-if="isShow"
      ref="changebgContent"
      id="bs-setting_bg"
      @cancel="close"
      @modify="modify($event)"
      @themeManage="themeManage($event)"
      @bgManage="bgManage($event)"
      class="bs-setting_img"
      currentType="GXFG"
      :showData="myBgZtData"
    ></change-bg>
  </div>
</template>

<script>
import backlog from '../../../components/base/back-log/index';
import totalExhibition from '../../../components/base/total-exhibition/index';
import homeModule from '../../../components/base/home-module/index';
import changeBg from '../../../components/base/setting-bg/index';
import { mapActions, mapGetters } from 'vuex';
import setting from '../../../components/base/setting/index';
import checkPermission from '@icccdPath/utils/permission'; // 权限判断函数
import gztApi from '../../../api/gztApi';
export default {
  name: 'themeSelfdom',
  components: {
    backlog,
    totalExhibition,
    homeModule,
    changeBg,
    setting
  },
  data() {
    return {
      currentTime: '',
      myBgZtData: null,
      coverImgUrl: '',
      isShow: false,
      isSetting: false,
      mark: 0, // 换背景标识
      markBg: 0, // 换背景过度变量
      homeModuleData: [
        {
          bg: 'light',
          type: 'big',
          title: '快速申请',
          icon: 'iconf-kuaisushenqing',
          iconDir: 'is-top-right',
          limit: false,
          openType: 1,
          appLink: '',
          rights: 'KSSQ'
        },
        {
          bg: 'light',
          type: 'small',
          title: '背审查询',
          icon: 'iconf-beishenchaxun',
          iconDir: 'is-top-left',
          limit: false,
          openType: 2,
          appLink: '',
          rights: 'BSCX'
        },
        {
          bg: 'light',
          type: 'small',
          title: '背审统计',
          icon: 'iconf-tongjifenxi',
          iconDir: 'is-top-left',
          limit: false,
          openType: 3,
          appLink: '',
          rights: 'TJFX'
        },
        {
          bg: 'light',
          type: 'small',
          title: '待办工作',
          icon: 'iconf-daibangongzuo',
          iconDir: 'is-top-left',
          limit: false,
          openType: 4,
          appLink: '',
          rights: 'DBGZ'
        },
        {
          bg: 'light',
          type: 'small',
          title: '系统管理',
          icon: 'iconl-setting',
          iconDir: 'is-top-left',
          limit: true,
          openType: 5,
          appLink: '',
          rights: 'XTGL',
          rightsTwo: 'BSFAPZ'
        },
        {
          bg: 'black',
          type: 'small',
          title: '背审申请',
          icon: 'iconf-apply',
          iconDir: 'is-top-left',
          limit: false,
          openType: 6,
          appLink: '',
          rights: 'BSSQ'
        }
      ], // 右侧功能模块
      homeModuleSecondData: {
        // 审核复查
        check: {
          name: '背审审核',
          icon: 'iconf-beishenshenhe',
          limit: false,
          openType: 7,
          rights: 'BSSH'
        },
        recheck: {
          name: '背审复核',
          icon: 'iconf-through-',
          limit: false,
          openType: 8,
          rights: 'BSFH'
        }
      },
      countData: {
        bszs: '0',
        qkrs: '0',
        wxsjrs: '0'
      },
      taskList: [],
      detailLayer: null
    };
  },
  computed: { ...mapGetters(['getSimpleActive', 'getThemeActive', 'name']) },
  methods: {
    checkPermission,
    ...mapActions(['SubThemeActive', 'SubSelfDomActive', 'SubSimpleActive']),
    /**
     * 初始化统计数据
     *
     */
    initData() {
      // 最新消息
      gztApi.statBjsczs().then(res => {
        this.countData.bszs = res.data.bszs;
        this.countData.qkrs = res.data.qkrs;
        this.countData.wxsjrs = res.data.wxsjrs;
        this.countData.sqzs = res.data.sqzs;
        this.countData.tgrs = res.data.tgrs;
        this.countData.btgrs = res.data.btgrs;
      });
    },
    /**
     * 初始化待办工作
     *
     */
    initTask() {
      gztApi.loadLatestDbgz().then(res => {
        this.taskList = res.data;
      });
    },

    /* 待办工作查看详情*/
    executeFun(row) {
      // let detailLayer=this.$dgLayer({
      //     title: '批次详情',
      //     // 组件内容
      //     component: require('../../sys-manage/bs-apply/bs-apply-detail/index.vue'),
      //     maxmin:false,
      //     resize:false,
      //     props:{
      //         rowData:row,
      //         openType:'index-waiting'
      //     },
      //     area:["1100px","775px"],
      //     skin:'layer-multiple',
      //     close(){
      //         detailLayer.close();
      //     }
      // });
      // this.detailLayer=detailLayer;
    },

    openFun(type, param) {
      if (!this.checkPermission([param.rights])) {
        return;
      }
      if ('/bs-solution' == type) {
        this.$router.push(type);
      }
      if ('/bs-audit' == type) {
        this.$router.push(type);
      }
      if ('/bs-review' == type) {
        this.$router.push(type);
      }
    },
    changeBg() {
      this.isShow = !this.isShow;
    },
    /* 修改系统主题*/
    themeManage(themeData) {
      this.themeMark = themeData.index; // 0-简约；1-个性
    },
    /* 修改背景图片*/
    bgManage(obj) {
      if (obj.data.type != 'JYFG' && obj.data.type != 'GXFG') {
        this.coverImgUrl = obj.data.src;
        // 无效
        this.mark = -1;
      } else {
        this.coverImgUrl = null;
        this.mark = obj.data.index - 1;
      }
    },
    close() {
      this.isShow = false;
    },
    modify(obj) {
      if (obj.data.type != 'JYFG' && obj.data.type != 'GXFG') {
        this.coverImgUrl = obj.data.src;
        // 无效
        this.mark = -1;
      } else {
        this.coverImgUrl = null;
        this.mark = obj.data.index - 1;
      }
      this.isShow = false;
      // 0-简约；1-个性
      if (this.themeMark == 0) {
        this.SubSimpleActive(this.mark);
        this.SubSelfDomActive(0);
        this.$router.push('/themeSimple');
      }
      if (this.themeMark == 1) {
        this.SubSelfDomActive(this.mark);
        this.SubSimpleActive(0);
      }
      this.SubThemeActive(this.themeMark);
    },

    /* 设置*/
    handleCommand(command) {
      if (command) {
        this.isSetting = true;
      } else {
        this.isSetting = false;
      }
    },

    /* 点击空白弹窗隐藏*/
    impressClick(e) {
      if (!e.target.closest('#bs-setting_bg') && !e.target.closest('#skinIcon')) {
        if (this.$refs.changebgContent) {
          this.$refs.changebgContent.cancel();
        }
        this.isShow = false;
      }
    },
    /**
     * @MethodName: getCurrentBj
     * @Description: 获取图片地址
     * @Param:
     * @Return:
     * @Author: suqh
     * @Date: 2019/11/19 18:49
     **/
    getCurrentBj(hisArray) {
      let mydata = hisArray;
      let resMap = {
        // 封装简约风格的背景数据
        jyList: [],
        jyCurData: {
          index: -1,
          data: null
        },
        // 封装个性风格的背景数据
        gxList: [],
        gxCurData: {
          index: -1,
          data: null
        }
      };
      if (mydata && mydata.bjtpList && mydata.bjtpList.length > 0) {
        let jyList = [];
        let gxList = [];
        for (let i = 0; i < mydata.bjtpList.length; i++) {
          let hi = mydata.bjtpList[i];
          if (hi.bjtpid == mydata.dqbjtpid) {
            resMap.index = i;
            resMap.currData = hi;
          }
          if ('JYFG' == hi.type || 'GXFG' == hi.type) {
            // 获取要获取的背景图片的序号
            let bjNum = Number(hi.bjtpid.substring(hi.bjtpid.length - 2, hi.bjtpid.length));
            if ('JYFG' == hi.type) {
              jyList.push({
                src: hi.bjtpurl,
                isSystem: hi.isSystem,
                bjtpid: hi.bjtpid,
                type: hi.type,
                index: bjNum
              });
            }
            if ('GXFG' == hi.type) {
              gxList.push({
                src: hi.bjtpurl,
                isSystem: hi.isSystem,
                bjtpid: hi.bjtpid,
                type: hi.type,
                index: bjNum
              });
            }
          } else {
            jyList.push({
              src: hi.bjtpurl,
              isSystem: hi.isSystem,
              bjtpid: hi.bjtpid,
              type: hi.type,
              index: i
            });
            gxList.push({
              src: hi.bjtpurl,
              isSystem: hi.isSystem,
              bjtpid: hi.bjtpid,
              type: hi.type,
              index: i
            });
          }
          if ('JYFG' == hisArray.dqxtzt) {
            if (hi.bjtpid == mydata.dqbjtpid) {
              resMap.jyCurData.index = jyList.length - 1;
              resMap.jyCurData.data = jyList[jyList.length - 1];
            }
          }
          if ('GXFG' == hisArray.dqxtzt) {
            if (hi.bjtpid == mydata.dqbjtpid) {
              resMap.gxCurData.index = gxList.length - 1;
              resMap.gxCurData.data = gxList[gxList.length - 1];
            }
          }
        }
        resMap.jyList = jyList;
        resMap.gxList = gxList;
        if (resMap.jyCurData.index == -1) {
          resMap.jyCurData.index = 0;
          resMap.jyCurData.data = jyList[0];
        }
        if (resMap.gxCurData.index == -1) {
          resMap.gxCurData.index = 0;
          resMap.gxCurData.data = gxList[0];
        }
      } else {
        return null;
      }
      return resMap;
    }
  },
  mounted() {
    this.initTask();
    this.mark = this.getSelfDomActive;
    if (window.HOMEACCESS) {
      this.myBgZtData = window.HOMEACCESS;
      let currData = this.getCurrentBj(this.myBgZtData);
      this.bgManage(currData.gxCurData);
    } else {
      gztApi.loadUserManagerDetail().then(res => {
        let myData = res.data;
        window.HOMEACCESS = myData;
        this.myBgZtData = window.HOMEACCESS;
        let currData = this.getCurrentBj(this.myBgZtData);
        this.bgManage(currData.gxCurData);
      });
    }
    this.initData();
  },
  created() {
    document.body.addEventListener('click', this.impressClick);
  },
  destroyed() {
    document.body.removeEventListener('click', this.impressClick);
  }
};
</script>

<style scoped lang="scss">
@import 'index.scss';
</style>
