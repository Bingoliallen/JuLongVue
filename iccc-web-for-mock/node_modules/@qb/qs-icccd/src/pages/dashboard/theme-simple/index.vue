<template>
  <div
    class="bs-theme"
    :style="{ backgroundImage: 'url(' + (coverImgUrl ? coverImgUrl : '') + ')' }"
    :class="
      coverImgUrl
        ? ''
        : mark == 0
        ? 'indexBg0'
        : mark == 1
        ? 'indexBg1'
        : mark == 2
        ? 'indexBg2'
        : mark == 3
        ? 'indexBg3'
        : ''
    "
  >
    <!--主要内容 begin-->
    <div class="bs-theme-cont">
      <!--标题 begin-->
      <div class="bs-theme-title">
        <div class="logo">
          <img src="../../../assets/images/dashboard/indexTextLogo.png" /><span class="fontSizeUser">{{appName}}</span>
        </div>
        <div class="fr">
          <span><i style="cursor:default;" class="icon iconl-user"></i></span>
          <span class="txt-shadow">Hello，{{ name }}</span>
          <span class="txt-shadow">{{ currentDate() }}</span>
          <span @click="editIcon" class="edit_save">{{ iconTxt }}</span>
          <span class="skinIcon" :class="isShow ? 'hoverSkin' : ''" id="skinIcon"
            ><i class="icon iconl-skin" @click="changeBg"></i
          ></span>
          <span class="skinIcon" :class="isShow ? 'hoverSkin' : ''" v-if="isScene">
            <i class="icon iconl-scense" @click="openScenes"></i>
          </span>
          <!-- <setting fontSize="20px" v-permission="['XTGL']"></setting> -->
          <span style="margin-right: 0" class="logout"><i class="icon iconl-poweroff" @click="logout()"></i></span>
        </div>
      </div>
      <div class="bs-theme-main">
        <!--左侧部分-->
        <div class="bs-theme-left">
          <wriedraggable
            ref="draggableEl"
            :data="draggableData"
            @applicationLink="applicationLink"
            :iShowMore="iShowMore"
            :isEdit="isEdit"
          ></wriedraggable>
        </div>
        <!--右侧部分-->
        <div class="bs-theme-right">
          <div class="bs-theme-warap">
            <inforBlock
              text="温馨提示"
              :isShowMore="messageList.length ? true : false"
              @handleMore="routerToPath('/system-msg')"
            >
              <div v-if="messageList.length">
                <div
                  class="infor-content"
                  v-for="(item, index) in messageList"
                  :key="index"
                  @click="executeFun(item, 'tip')"
                >
                  <p class="xtxx">{{ item.bt }}</p>
                </div>
              </div>
              <div v-else class="bs-is-noData">暂无数据</div>
            </inforBlock>
          </div>
          <div class="bs-theme-warap">
            <inforBlock
              text="待办工作"
              :isShowMore="taskList.length ? true : false"
              @handleMore="routerToPath('/waiting-work')"
            >
              <div v-if="taskList.length">
                <div
                  class="infor-content"
                  v-for="(item, index) in taskList"
                  :key="index"
                  @click="executeFun(item, 'task')"
                >
                  <p class="dbgz">{{ item.zw }}</p>
                  <div class="time">
                    <qb-showlable
                      :values="item.sqsj"
                      type="DATE"
                      format="yyyy-MM-dd HH:mm:ss"
                      :showTitle="false"
                    ></qb-showlable>
                  </div>
                </div>
              </div>
              <div v-else class="bs-is-noData">暂无待办任务</div>
            </inforBlock>
          </div>
          <div class="bs-theme-warap">
            <calendar></calendar>
          </div>
        </div>
      </div>
    </div>
    <!--换肤-->
    <change-bg
      v-if="isShow"
      ref="changebgContent"
      id="bs-setting_bg"
      @cancel="close"
      @modify="modify($event)"
      @themeManage="themeManage($event)"
      @bgManage="bgManage($event)"
      class="bs-setting_img"
      currentType="JYFG"
      :showData="myBgZtData"
    ></change-bg>
  </div>
</template>

<script>
import calendar from '../../../components/base/calendar/index';
import inforBlock from '../../../components/base/home-block/index';
import changeBg from '../../../components/base/setting-bg/index';
import wriedraggable from '../../../components/base/draggable/index';
import gztApi from '../../../api/gztApi';
import sceneApi from '../../../api/sceneApi';
import addModule from '../../../components/base/add-module/index';
import { mapActions, mapGetters } from 'vuex';
// import setting from '../../../components/setting/index'
import checkPermission from '../../../utils/permission'; // 权限判断函数
export default {
  name: 'themeSimple',
  components: {
    inforBlock,
    changeBg,
    wriedraggable,
    calendar
  },
  data() {
    return {
      isScene:window.systemParams.IS_SCENE,
      myBgZtData: null,
      userName: '李圣杰',
      appName:window.systemParams.APP_NAME,
      mark: 0, // 换背景标识
      markBg: 0, // 换背景过度变量
      themeMark: 0,
      coverImgUrl: '',
      currentTime: '',
      isRead: true,
      isShow: false,
      messageList: [],
      taskList: [],
      draggableData: [],
      otherAppList: [],
      myAppList: [],
      // outsideAddList:[],
      bszs: '0',
      qkrs: '0',
      wxsjrs: '0',
      iShowMore: false,
      isEdit: false,
      disabledEditStatus: false,
      iconTxt: '编辑',
      detailLayer: null,
      condition: {
        TYPE_gt: 'ALL'
      }
    };
  },
  computed: { ...mapGetters(['getSimpleActive', 'getThemeActive', 'name']) },
  methods: {
    ...mapActions(['SubThemeActive', 'SubSimpleActive', 'SubSelfDomActive', 'GetUserConfig']),
    checkPermission,
    /**
     * 初始化数据
     *
     */
    init() {
      // 模块数据

      gztApi.loadMyApp().then(res => {
        this.draggableData = res.data.myAppList;
        if (this.draggableData.length == 0) {
          this.isEdit = false;
          this.editIcon();
        } else {
          this.iShowMore = false;
          this.isEdit = false;
          this.iconTxt = '编辑';
        }
        this.myAppList = res.data.myAppList;
        console.log(this.myAppList);
        this.otherAppList = res.data.otherAppList;
      });
    },
    /**
     * 初始化加载最新的系统消息（默认两条）
     *
     */
    initMessage() {
      gztApi.loadRandomCjwt().then(res => {
        this.messageList = res.data;
      });
    },

    /**
     * 初始化待办工作
     *
     */
    initTask() {
      gztApi.loadLatestDbgz().then(res => {
        this.taskList = res.data;
      });
    },

    /* 待办工作查看详情 */
    executeFun(row, type) {
      if (type == 'task') {
        // let detailLayer=this.$dgLayer({
        //     title: '批次详情',
        //     // 组件内容
        //     component: require('../../sys-manage/bs-apply/bs-apply-detail/index.vue'),
        //     maxmin:false,
        //     resize:false,
        //     props:{
        //         rowData:row,
        //         openType:'index-waiting'
        //     },
        //     area:["1100px","775px"],
        //     skin:'layer-transparent',
        //     close(){
        //         detailLayer.close();
        //     }
        // });
        // this.detailLayer=detailLayer;
      } else if (type == 'tip') {
        let tipDetail = this.$dgLayer({
          title: '温馨提示',
          // 组件内容
          component: require('./tip-content/index.vue'),
          maxmin: false,
          resize: false,
          props: {
            rowData: row
          },
          btn: ['我知道了'],
          btnAlign: 'c',
          area: ['1100px', '775px'],
          skin: 'layer-transparent',
          yes(dialogIndex) {
            tipDetail.close(dialogIndex);
          },
          close() {
            tipDetail.close();
          }
        });
      }
    },

    /**
     * 初始化统计数据
     *
     */
    initData() {
      // 最新消息
      gztApi.statBjsczs().then(res => {
        this.bszs = res.data.bszs;
        this.qkrs = res.data.qkrs;
        this.wxsjrs = res.data.wxsjrs;
      });
    },
    /**
     * 页面跳转
     * @param e
     */
    routerToPath(url) {
      if (url) {
        // 添加外部跳转
        if (url.substr(0, 7).toLowerCase() == 'http://') {
          window.open(url);
          return;
        }
        this.$router.push(url);
      }
    },

    /* 显示修改背景 */
    changeBg() {
      this.isShow = !this.isShow;
    },
    /* 修改系统主题 */
    themeManage(themeData) {
      this.themeMark = themeData.index; // 0-简约；1-个性
      if ('JYFG' == themeData.type) {
        // return;
      }
      if ('GXFG' == themeData.type) {
        // this.mark = this.getSelfDomActive;
      }
    },
    /* 修改背景图片 */
    bgManage(obj) {
      if (obj.data.type != 'JYFG' && obj.data.type != 'GXFG') {
        this.coverImgUrl = obj.data.src;
        // 无效
        // this.mark=-99;
      } else {
        this.coverImgUrl = null;
        this.mark = obj.data.index - 1;
      }
    },
    close() {
      this.isShow = false;
    },
    modify(obj) {
      if (obj.data.type != 'JYFG' && obj.data.type != 'GXFG') {
        this.coverImgUrl = obj.data.src;
        // 无效
        this.mark = -1;
      } else {
        this.coverImgUrl = null;
        this.mark = obj.data.index - 1;
      }
      this.isShow = false;
      if (this.themeMark == 0) {
        this.SubSimpleActive(this.mark);
        this.SubSelfDomActive(0);
      } else {
        this.$router.push('/themeSelfdom');
        this.SubSelfDomActive(this.mark);
        this.SubSimpleActive(0);
      }
      this.SubThemeActive(this.themeMark);
    },
    /* 编辑 */
    editIcon() {
      if (this.isEdit == false) {
        this.iShowMore = true;
        this.isEdit = true;
        this.iconTxt = '保存';
      } else {
        this.$dgConfirm('请确定是否保存设置？', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          customClass: 'confirm_user',
          cancelButtonClass: 'btn-custom-cancel',
          confirmButtonClass: 'btn-custom-submit',
          closeOnClickModal: false,
          type: 'warning'
        })
          .then(() => {
            let list = this.$refs.draggableEl.list.filter(item => {
              return !item.fill;
            });
            gztApi.saveMyAllApp(list).then(res => {
              if (list.length) {
                this.iShowMore = false;
                this.isEdit = false;
                this.iconTxt = '编辑';
              } else {
                this.iShowMore = true;
                this.isEdit = true;
                this.iconTxt = '保存';
              }
              // 关闭对应弹窗的ID
              this.$message({ type: 'success', message: '保存成功', customClass: 'msg-transparent' });
            });
          })
          .catch(() => {});
      }
    },
    /* 添加模块 */
    applicationLink(size) {
      let addModuleLayer = this.$dgLayer({
        // 标题
        title: '添加模块',
        maxmin: false,
        content: addModule,
        area: ['670px', '520px'],
        props: { myAppList: this.myAppList, otherAppList: this.otherAppList, size: size },
        btn: ['确定', '取消'],
        btnAlign: 'c',
        resize: false,
        skin: 'layer-transparent',
        yes: index => {
          if (!addModuleLayer.$children[0].tabItemShow) {
            addModuleLayer.$children[0].preData.forEach(itemOne => {
              this.draggableData.forEach((itemTwo, indexTwo) => {
                if (itemTwo.yypx == 999) {
                  this.draggableData.splice(indexTwo, 1);
                }
              });
              if (itemOne.isAdd) {
                itemOne.isAdd = false;
                this.draggableData.push(itemOne);
              }
            });
            addModuleLayer.$children[0].alData.forEach(item => {
              this.draggableData.forEach((itemOne, index) => {
                if (itemOne.sfwbyy == 0) {
                  if (item.yybh == itemOne.yybh) {
                    this.draggableData.splice(index, 1);
                  }
                }
              });
            });
            this.myAppList = addModuleLayer.$children[0].preData;
            this.otherAppList = addModuleLayer.$children[0].alData;
            save.bind(this)();
          } else {
            // 外部保存
            addModuleLayer.$children[0].$refs.addApp.validate(valid => {
              if (valid) {
                this.draggableData.push(addModuleLayer.$children[0].outModuleData);
                this.myAppList = this.draggableData;
                save.bind(this)();
              } else {
                return false;
              }
            });
          }
          /**
           * @description: 保存方法
           * @return {null} 无
           */
          function save() {
            gztApi.saveMyAllApp(this.draggableData).then(res => {
              this.iShowMore = false;
              this.isEdit = false;
              this.iconTxt = '编辑';
              // 关闭对应弹窗的ID
              layer.close(index);
              this.$message({ type: 'success', message: '模块管理修改成功', customClass: 'msg-transparent' });
            });
          }
        },
        btn2() {}
      });
    },
    /* 点击空白弹窗隐藏 */
    impressClick(e) {
      if (!e.target.closest('#bs-setting_bg') && !e.target.closest('#skinIcon')) {
        if (this.$refs.changebgContent) {
          this.$refs.changebgContent.cancel();
        }
        this.isShow = false;
      }
    },
    /**
     * @MethodName: getCurrentBj
     * @Description: 获取图片地址
     * @Param:
     * @Return:
     * @Author: suqh
     * @Date: 2019/11/19 18:49
     **/
    getCurrentBj(hisArray) {
      let mydata = hisArray;
      let resMap = {
        // 封装简约风格的背景数据
        jyList: [],
        jyCurData: {
          index: -1,
          data: null
        },
        // 封装个性风格的背景数据
        gxList: [],
        gxCurData: {
          index: -1,
          data: null
        }
      };
      if (mydata && mydata.bjtpList && mydata.bjtpList.length > 0) {
        let jyList = [];
        let gxList = [];
        for (let i = 0; i < mydata.bjtpList.length; i++) {
          let hi = mydata.bjtpList[i];
          if (hi.bjtpid == mydata.dqbjtpid) {
            resMap.index = i;
            resMap.currData = hi;
          }
          if ('JYFG' == hi.type || 'GXFG' == hi.type) {
            // 获取要获取的背景图片的序号
            let bjNum = Number(hi.bjtpid.substring(hi.bjtpid.length - 2, hi.bjtpid.length));
            if ('JYFG' == hi.type) {
              jyList.push({ src: hi.bjtpurl, isSystem: hi.isSystem, bjtpid: hi.bjtpid, type: hi.type, index: bjNum });
            }
            if ('GXFG' == hi.type) {
              gxList.push({ src: hi.bjtpurl, isSystem: hi.isSystem, bjtpid: hi.bjtpid, type: hi.type, index: bjNum });
            }
          } else {
            jyList.push({ src: hi.bjtpurl, isSystem: hi.isSystem, bjtpid: hi.bjtpid, type: hi.type, index: i });
            gxList.push({ src: hi.bjtpurl, isSystem: hi.isSystem, bjtpid: hi.bjtpid, type: hi.type, index: i });
          }
          if ('JYFG' == hisArray.dqxtzt) {
            if (hi.bjtpid == mydata.dqbjtpid) {
              resMap.jyCurData.index = jyList.length - 1;
              resMap.jyCurData.data = jyList[jyList.length - 1];
            }
          }
          if ('GXFG' == hisArray.dqxtzt) {
            if (hi.bjtpid == mydata.dqbjtpid) {
              resMap.gxCurData.index = gxList.length - 1;
              resMap.gxCurData.data = gxList[gxList.length - 1];
            }
          }
        }
        resMap.jyList = jyList;
        resMap.gxList = gxList;
        if (resMap.jyCurData.index == -1) {
          resMap.jyCurData.index = 0;
          resMap.jyCurData.data = jyList[0];
        }
        if (resMap.gxCurData.index == -1) {
          resMap.gxCurData.index = 0;
          resMap.gxCurData.data = gxList[0];
        }
      } else {
        return null;
      }
      return resMap;
    },
    /**
     * 场景切换
     */
    openScenes() {
      let that = this;
      let sceneLayer = this.$dgLayer({
        // 标题
        title: '场景切换',
        maxmin: false,
        content: require('../../../components/base/scene-change/index'),
        area: ['65.625rem', '50rem'],
        props: {},
        btn: ['确定', '取消'],
        btnAlign: 'c',
        resize: false,
        skin: 'layer-transparent',
        yes: index => {
          let curTabActiveCard = sceneLayer.$children[0].curTabActiveCard;
          console.log('curTabActiveCard', curTabActiveCard);
          if (curTabActiveCard) {
            sceneApi.saveCurrentScene(curTabActiveCard.id).then(res => {
              sceneLayer.close(index);
              that.$message.success('保存成功');
              let userConfig = JSON.parse(sessionStorage.getItem('userConfig'));
              userConfig.dqcjid = curTabActiveCard.id;
              userConfig.dqcjmc = curTabActiveCard.NAME;
              sessionStorage.userConfig = JSON.stringify(userConfig);
              window.HOMEACCESS = userConfig;
              this.GetUserConfig();
              this.init();
            });
          } else {
            sceneLayer.close(index);
          }
        },
        btn2() {}
      });
    }
  },
  mounted() {
    // 数据初始化
    this.init();
    // 最新消息初始化
    // this.initMessage();
    // 初始化待办工作
    // this.initTask();
    // 统计数据初始化
    // this.initData();
    // 获取Vuex中的主题状态
    this.mark = this.getSimpleActive;
    //
    if (window.HOMEACCESS) {
      this.myBgZtData = window.HOMEACCESS;
      let currData = this.getCurrentBj(this.myBgZtData);
      this.bgManage(currData.jyCurData);
    } else {
      gztApi.loadUserManagerDetail().then(res => {
        let myData = res.data;
        window.HOMEACCESS = myData;
        this.myBgZtData = window.HOMEACCESS;
        let currData = this.getCurrentBj(this.myBgZtData);
        this.bgManage(currData.jyCurData);
      });
    }
  },
  created() {
    document.body.addEventListener('click', this.impressClick);
  },
  destroyed() {
    document.body.removeEventListener('click', this.impressClick);
  }
};
</script>

<style scoped lang="scss">
@import 'index.scss';
</style>
