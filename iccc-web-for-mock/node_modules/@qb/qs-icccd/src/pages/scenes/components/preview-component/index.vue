<template>
  <el-form class="preview-component" :model="componentModel" label-suffix="：" label-position="top">
    <dg-scrollbar>
      <draggable
        class="preview-component_draggable"
        :options="dragOptions"
        :list="list"
        @start="dragStart"
        @end="dragEnd"
      >
        <transition-group type="transition" :name="!drag ? 'flip-list' : null">
          <el-form-item
            v-for="item in list"
            :key="item.id"
            v-bind="item.formBind"
            class="preview-component_item"
            :class="{ active: value === item }"
            @click.native="componentChange(item)"
            :data-order="item.order"
            :label="item.formBind.label || ' '"
          >
            <component v-bind="item.bind" :is="item.bind.is" v-model="componentModel[item.formBind.prop]"></component>
            <i class="iconfont iconl-delete" v-if="!item.noDelete" @click.stop="componentDelete(item)"></i>
          </el-form-item>
        </transition-group>
      </draggable>
    </dg-scrollbar>
  </el-form>
</template>

<script>
import Draggable from 'vuedraggable';
import ScenesBkdx from './../scenes-bkdx';
import YjjsrTransfer from './../yjjsr-transfer';
import QsCyclePick from '../qs-cycle-pick';
import NationwideSelection from '../nationwide-selection';
import WarningRule from './../warning-rule';
import QsTranslate from '@icccdPath/components/base/qs-translate';
import QsInput from '@icccdPath/components/base/qs-input';
export default {
  name: 'preview-component',
  components: { Draggable, ScenesBkdx, YjjsrTransfer, WarningRule, QsTranslate, QsCyclePick, NationwideSelection,QsInput },
  props: {
    // 外部执行代码
    code: String,
    list: Array,
    value: [Object, Boolean]
  },
  data() {
    return {
      dynamicFn: false,
      componentModel: {},
      drag: false,
      dragOptions: {
        sort: true,
        delay: 0,
        // 拖拽至外围
        forceFallback: false
      }
    };
  },
  watch: {
    list: {
      handler(val) {
        if (val) {
          this.componentModel = {};
          val.forEach(item => {
            // 设置默认值
            this.$set(this.componentModel, item.formBind.prop, item.bind.value);
          });
        }
      },
      immediate: true
    },
    value: {
      handler(val) {
        if (val && val.bind.value !== undefined) {
          // 默认值和中间联动
          this.$set(this.componentModel, val.formBind.prop, val.bind.value);
        }
      },
      deep: true
    },
    code: {
      handler(code) {
        this.dynamicFn && this.dynamicFn();
        this.dynamicFn = this.executeCode(code);
      },
      immediate: true
    }
  },
  methods: {
    dragStart() {
      this.drag = true;
    },
    dragEnd() {
      this.drag = false;
      this.list.forEach((item, index) => {
        this.$set(item, 'order', index);
      });
    },
    componentChange(data) {
      this.$emit('input', data);
      this.$emit('change', data);
    },
    componentDelete(data) {
      this.$emit('delete', data);
    },
    executeCode(code, ...arg) {
      return code && new Function(code).apply(this, arg);
    }
  }
};
</script>

<style lang="scss" scoped>
@import './../../variable';
.preview-component {
  &_draggable {
    /*height: 100%;*/
    /*overflow: auto;*/
    padding: 0 2rem;
  }
  &_item {
    cursor: move;
    padding: 1rem 1.5rem 1.5rem;
    background: var(--color-white);
    border: 1px solid var(--preview-component_border);
    border-left: 4px solid var(--preview-component_border);
    transition: all 150ms;
    & + .preview-component_item {
      margin-top: 12px;
    }
    .iconl-delete {
      display: none;
    }
    &:hover,
    &.active {
      border-color: var(--preview-component_border-color);
      box-shadow: $box-shadow;
      .iconl-delete {
        display: block;
        position: absolute;
        top: -2rem;
        margin-top: -3px;
        right: 0;
        &:hover {
          color: $color-primary;
          cursor: pointer;
        }
      }
    }
    &:hover {
      border-left-color: var(--preview-component_border-left-color);
    }
    &.active {
      border-left-color: $color-primary;
    }
  }
  .el-form-item {
    margin-bottom: 0;
  }
  .flip-list-move {
    transition: transform 0.5s;
  }
}
</style>
