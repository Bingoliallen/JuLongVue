<template>
  <draggable class="drag-component" ghost-class="ghost" :options="dragOptions" :list="list" @end="dragEnd">
    <template v-for="item in list">
      <span
        :key="item.id"
        class="drag-component_item"
        :class="{ moving: item.moving, selected: item.selected }"
        @mousedown="$set(item, 'moving', true)"
        @mouseup="$set(item, 'moving', false)"
      >
        {{ item.label }}
      </span>
    </template>
  </draggable>
</template>

<script>
import Draggable from 'vuedraggable';
export default {
  name: 'drag-component',
  components: { Draggable },
  props: { list: Array },
  data() {
    return {
      dragOptions: {
        sort: false,
        delay: 1,
        // 支持拖拽至外围
        forceFallback: true,
        fallbackOnBody: true
      }
    };
  },
  methods: {
    dragEnd(e) {
      // 被拖动的数据对象
      const data = this.list[e.oldIndex];
      this.$set(data, 'moving', false);
      const target = e.originalEvent.target;
      // 可接收区域
      const receivingArea = document.querySelector('.scenes-content_center');
      if (receivingArea.contains(target)) {
        if (data.type === '1') {
          this.$set(data, 'selected', true);
        }
        const i = this.queryParent(target, 'preview-component_item');
        let order;
        if (i) {
          // 拖动到组件上，在组件前面插入
          order = parseInt(i.dataset.order) - 0.1;
        } else {
          // 如果是拖动到步骤条上，添加到最前面，否则添加到最后面
          const steps = this.queryParent(target, 'el-steps');
          order = steps ? -99999 : 99999;
        }
        this.$emit('drag-add', data, order);
      }
    },
    /**
     * 用类名查找最近的满足条件的父节点，如果不存在，返回 false
     * @param {Element} el 子节点
     * @param {String} className 查找的类名
     * @return {Element} 目标节点
     */
    queryParent(el, className) {
      while (!el.classList.contains(className) && el.parentElement) {
        el = el.parentElement;
      }
      return el.classList.contains(className) ? el : false;
    }
  }
};
</script>

<style lang="scss" scoped>
@import './../../variable';
.drag-component {
  display: flex;
  flex-wrap: wrap;
  margin: -8px -8px 0;
  &_item {
    width: calc(50% - 16px);
    padding: 0 16px;
    margin: 8px;
    height: 2.5rem;
    line-height: 2.5rem;
    border: $border;
    box-shadow: $box-shadow;
    border-radius: 2px;
    cursor: move;
    background: var(--color-white);
    &.moving {
      color: $color-primary;
      border-color: $color-primary;
    }
    &.ghost {
      opacity: 0.2;
    }
    &.selected {
      cursor: not-allowed;
      pointer-events: none;
      background: var(--drag-component_background-color);
      border: 1px solid var(--drag-component_border-color);
      color: var(--drag-component_text-color);
    }
  }
}
</style>
