<template>
  <div class="scenes" v-loading.fullscreen.lock="loading">
    <div class="title-1">
      <span>{{ scenesName }}</span>
      <!--<i class="iconfont iconl-edit"></i>-->
    </div>
    <div class="scenes-content" v-if="steps.length > 0">
      <div class="scenes-content_left">
        <template v-if="leftConfigs">
          <!--组件列表-->
          <template v-if="leftConfigs.default && leftConfigs.default.length > 0">
            <div class="title-2">{{ leftConfigs.defaultName }}</div>
            <drag-component :list="leftConfigs.default" :key="leftConfigs.id" @drag-add="addComponent"></drag-component>
          </template>
          <template v-if="leftConfigs.diy && leftConfigs.diy.length > 0">
            <div class="title-2">自定义参数</div>
            <drag-component
              :list="leftConfigs.diy"
              :key="'diy' + leftConfigs.id"
              @drag-add="addComponent"
            ></drag-component>
          </template>
        </template>
      </div>
      <div class="scenes-content_center" :class="{ complete: stepActive === steps.length + 1 }">
        <el-steps :active="stepActive" align-center finish-status="success">
          <el-step v-for="item in steps" :key="item.id" :title="item.name"></el-step>
          <el-step class="el-step-wc" title="完成"></el-step>
        </el-steps>
        <template v-if="previewConfigs">
          <!--组件预览-->
          <preview-component
            class="scenes-preview"
            v-model="selectedComponent"
            @delete="removeComponent"
            :list="previewConfigs"
            :key="stepActive"
            :code="previewOutCode"
          ></preview-component>
          <div class="scenes-btn">
            <el-button v-if="stepActive !== 0" @click="changeStep(stepActive - 1)">上一步</el-button>
            <el-button type="primary" @click="changeStep(stepActive + 1)">{{
              steps.length === stepActive + 1 ? '完成' : '下一步'
            }}</el-button>
            <el-button @click="$router.go(-1)">取消</el-button>
          </div>
        </template>
        <scenes-complete v-else-if="stepActive > 0" class="scenes-preview"></scenes-complete>
      </div>
      <div class="scenes-content_right">
        <!--组件属性配置-->
        <el-form v-if="componentConfigs" class="form-attribute" label-position="top">
          <el-form-item
            v-for="(item, index) in componentConfigs"
            :key="selectedComponent.id + '-' + index"
            :prop="item.prop"
            :label="item.label"
          >
            <component
              v-bind="item.bind"
              :is="item.is"
              v-model="item.value"
              :ref="'attribute' + index"
              @change="attributeChange(item, index)"
            ></component>
          </el-form-item>
        </el-form>
      </div>
    </div>
  </div>
</template>

<script>
import {
  getSceneModelList,
  getLeftList,
  getPreview,
  getComponentOption,
  saveModelConfig,
  publishScenes
} from './data-mock.js';
import DragComponent from './../components/drag-component';
import PreviewComponent from './../components/preview-component';
import ScenesComplete from './../components/scenes-complete';

export default {
  name: 'scenes-add',
  components: { DragComponent, PreviewComponent, ScenesComplete },
  data() {
    return {
      scenesId: '',
      scenesName: '',
      loading: true,
      stepActive: -1,
      steps: [],
      previewOutCode: '',
      // 左侧组件
      leftConfigs: false,
      // 中间部分所有的组件列表
      previewConfigs: false,
      // 中间部分被选中的组件
      selectedComponent: false,
      // 被选中组件配置项
      componentConfigs: false,
      // 被选中的组件动态执行函数
      dynamicFn: false
    };
  },
  watch: {
    selectedComponent(data) {
      this.changeComponent(data);
    }
  },
  beforeRouteEnter(to, from, next) {
    const id = to.query.id;
    if (!id) {
      // id 不存在，不允许编辑
      next(false);
      return;
    }
    next(vm => vm.init());
  },
  methods: {
    init() {
      const { id, name } = this.$route.query;
      this.scenesId = id;
      this.scenesName = decodeURIComponent(name);
      getSceneModelList(this.scenesId)
        .then(data => {
          this.steps = data;
          this.stepTo(0);
        })
        .finally(() => {
          this.loading = false;
        });
    },
    // 切换步骤，调用接口保存数据
    async changeStep(index) {
      if (this.stepActive === index) {
        // 重复点击跳过
        return true;
      }

      if (this.previewConfigs) {
        await saveModelConfig(this.previewConfigs, this.scenesId);
      }

      if (this.steps.length === index) {
        // 如果是最后一步，发布并进入发布成功页面
        index++;
        await publishScenes(this.scenesId);
      }
      this.stepTo(index);
    },
    // 进入步骤，获取数据渲染页面
    async stepTo(index) {
      this.stepActive = index;
      const model = this.steps[index];
      if (model) {
        this.previewConfigs = await getPreview(model.id);
        const leftConfigs = await getLeftList(model.id);
        const leftTop = leftConfigs.filter(e => e.type === '1');
        // 标记出来已使用的组件
        this.previewConfigs.forEach(item => {
          const left = leftTop.find(e => e.componentId === item.componentId);
          if (left) {
            this.$set(left, 'selected', true);
          }
        });
        this.leftConfigs = {
          default: leftTop,
          defaultName: model.name,
          diy: leftConfigs.filter(e => e.type === '2')
        };
        //  默认选中第一个
        this.selectedComponent = this.previewConfigs[0];
        this.previewOutCode = model.code;
      } else {
        this.previewOutCode = '';
        this.previewConfigs = false;
        this.leftConfigs = false;
        this.selectedComponent = false;
      }
    },
    // 动态监视代码
    changeComponent(data) {
      // 先解除上一个组件的监听
      this.dynamicFn && this.dynamicFn();
      // 改变右侧配置项
      this.componentConfigs =
        data &&
        data.configs.map(item => {
          if (item.is === 'dg-select') {
            item.bind = { ...item.bind, onLoad: this.selectOnLoad };
          }
          return item;
        });
      // 监听选中组件的选项，让右侧默认值只能从里面选
      const key = data && data.watchKey;
      const defaultOptionKey = data && data.defaultOptionKey;
      this.dynamicFn =
        key &&
        this.$watch(
          () => {
            let r = this;
            r = r && r.selectedComponent;
            r = r && r.bind;
            r = r && r[key];
            return r;
          },
          data => {
            // data 选项
            if (data && data.length > 0) {
              const item = this.componentConfigs.find(item => item.prop === (defaultOptionKey || 'value'));
              if (!item) {
                return;
              }
              this.$set(item.bind, 'data', data);
              if (!data.some(e => e.value === item.value)) {
                this.$set(item, 'value', '');
              }
            }
          },
          { deep: true, immediate: true }
        );
    },

    async addComponent(data, order) {
      const { modelId, componentId } = data;
      const componentOption = await getComponentOption(componentId);
      const { configs } = componentOption;
      const component = {
        id: new Date().getTime() + '',
        modelId,
        componentId,
        ...componentOption
      };
      // 根据右侧配置项计算默认配置
      configs.forEach((item, index) => {
        this.$nextTick(() => {
          this.attributeChange(item, index, component);
        });
      });

      const list = this.previewConfigs;
      const index = list.findIndex(item => item.order > order);
      if (index === -1) {
        list.push(component);
      } else {
        list.splice(index, 0, component);
      }
      list.forEach((item, index) => {
        this.$set(item, 'order', index);
      });
      this.selectedComponent = component;
    },
    // 组件删除
    removeComponent(data) {
      this.$delete(data, 'order');
      this.previewConfigs.splice(this.previewConfigs.indexOf(data), 1);
      if (this.selectedComponent === data) {
        this.selectedComponent = null;
      }
      const { componentId } = data;
      const item = this.leftConfigs.default.find(e => e.componentId === componentId);
      if (item) {
        this.$set(item, 'selected', false);
      }
    },
    // 组件属性改变
    attributeChange(data, index, selectedComponent = this.selectedComponent) {
      const { use, prop, value } = data;
      switch (use) {
        case 'form-item':
          this.$set(selectedComponent.formBind, prop, value);
          break;
        case 'rules': {
          const rules = selectedComponent.formBind.rules || [];
          // 在这里写表单的3种验证规则
          switch (prop) {
            case 'required': {
              const index = rules.findIndex(e => e.required);
              if (data.value) {
                // 必填项
                if (index === -1) {
                  rules.push({ required: true, message: data.message || '不能为空！' });
                }
              } else {
                // 非必填项
                if (index !== -1) {
                  rules.splice(index, 1);
                }
              }
              break;
            }
          }
          this.$set(selectedComponent.formBind, 'rules', rules);
          break;
        }
        case 'diy': {
          this.executeCode(selectedComponent.code, data, index, this.componentConfigs);
          break;
        }
        default: {
          let val;
          const watchKey = selectedComponent.watchKey;
          if (watchKey && watchKey === prop) {
            // 选项改变，把 value 转为带文本的选项
            const instance = this.$refs['attribute' + index][0];
            val = ',' + value + ',';
            val =
              (instance &&
                instance.dataSource &&
                instance.dataSource.filter(item => val.indexOf(',' + item.value + ',') !== -1)) ||
              [];
          }
          this.$set(selectedComponent.bind, prop, val || value);
        }
      }
    },

    // 表码数据
    selectOnLoad(data) {
      if (!data) {
        return [];
      }
      if (data.data) {
        data = data.data;
      }
      return data;
    },
    executeCode(code, ...arg) {
      return code && new Function(code).apply(this, arg);
    }
  }
};
</script>

<style lang="scss">
@import './../style';
</style>
