<template>
  <div class="bs-setting_bg">
    <!--内容区域 begin-->
    <div class="bs-setting_container">
      <dg-scrollbar @scroll-event="handleScrollEvent">
        <!--系统主题管理 begin-->
        <div class="bs-setting-body">
          <div class="bs-setting-title">系统主题管理</div>
          <div class="bs-setting-content">
            <ul class="bs-setting-theme">
              <li
                v-for="(item, index) in themeList"
                @click="themeManage(index, item.disable)"
                :class="{ active: active == index }"
                :key="index"
              >
                <div class="bs-setting-theme-disable" v-if="item.disable">建设中…</div>
                <div><img :src="item.src" alt="" /></div>
                <div class="text">{{ item.text }}</div>
              </li>
            </ul>
          </div>
        </div>
        <!--系统主题管理 end-->

        <!--背景图片管理 begin-->
        <div class="bs-setting-body">
          <div class="bs-setting-title">背景图片管理</div>
          <div class="bs-setting-content">
            <ul class="bs-setting-img">
              <li
                v-for="(item, index) in bgList"
                @click="bgManage(index)"
                :class="{ bgActive: bgActive == index }"
                :key="index"
              >
                <div><img :src="item.src" alt="" class="bg-size-rule" /></div>
                <div class="text">{{ item.text }}</div>
                <span class="current" v-show="bgActive == index ? true : false"></span>
                <i
                  class="bs-setting-img_close"
                  @click.stop="del(item, index)"
                  v-if="
                    item.isSystem != '1' &&
                      bgActive != index &&
                      index != currObjData.jyCurData.index &&
                      index != currObjData.gxCurData.index
                  "
                >
                  <img src="../../../assets/images/dashboard/close.png" alt="" />
                </i>
              </li>
              <li>
                <div class="bg-size-rule is-add">
                  <qb-upload
                    server-url=""
                    :action="filter()"
                    filetype="ZP"
                    v-model="fileList"
                    :on-success="imgSuccess"
                    :show-file-list="false"
                    :before-upload="file => beforeAvatarUpload(file, false)"
                    accept=".jpg,.jpeg,.png,.JPG,.JPEG,.PNG"
                    multiple
                  >
                    <img
                      class="bg-size-rule"
                      style="width:30px;height: 28px;"
                      src="../../../assets/images/dashboard/addBj.png"
                    />
                    <p>添加图片</p>
                  </qb-upload>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <!--背景图片管理 end-->
      </dg-scrollbar>
    </div>
    <!--内容区域 end-->

    <!--底部按钮 begin-->
    <div style="text-align: center;position: absolute;width: calc(100% - 40px);bottom: 0;height: 42px;left: 20px">
      <dg-button type="primary" size="small" @click="modify">更改</dg-button>
      <dg-button size="small" @click="cancel">取消</dg-button>
    </div>
    <!--底部按钮 end-->
  </div>
</template>

<script>
import common from '@icccdPath/common';

const { getSetting } = common;
import { mapActions, mapGetters } from 'vuex';
import gztApi from '../../../api/gztApi';

export default {
  name: 'backlog',
  props: {
    currentType: {
      type: String,
      default: ''
    },
    showData: {
      type: Object,
      default: function() {
        return {};
      }
    }
  },
  data() {
    return {
      ruleForm: {
        xtzt: '',
        bjtpid: ''
      },
      currAllData: null,
      currObjData: null,
      active: 0,
      bgActive: 0,
      currActiveId: null,
      fileList: [],
      themeList: [
        {
          src: `/static/icccd/images/themeBg/bg-show/change-bg1.png`,
          text: '简约风格',
          type: 'JYFG',
          index: 0
        },
        {
          src: `/static/icccd/images/themeBg/bg-show/change-bg2.png`,
          text: '个性风格',
          type: 'GXFG',
          disable: true,
          index: 1
        }
      ],
      bgList: [],
      simpleList: [
        { src: `/static/icccd/images/themeBg/bg-show/simple/00.png` },
        { src: `/static/icccd/images/themeBg/bg-show/simple/01.png` },
        { src: `/static/icccd/images/themeBg/bg-show/simple/02.png` },
        { src: `/static/icccd/images/themeBg/bg-show/simple/03.png` },
        { src: `/static/icccd/images/themeBg/bg-show/simple/04.png` }
      ],
      selfdomList: [
        { src: `/static/icccd/images/themeBg/bg-show/selfdom/00.png` },
        { src: `/static/icccd/images/themeBg/bg-show/selfdom/01.png` },
        { src: `/static/icccd/images/themeBg/bg-show/selfdom/02.png` },
        { src: `/static/icccd/images/themeBg/bg-show/selfdom/03.png` },
        { src: `/static/icccd/images/themeBg/bg-show/selfdom/04.png` }
      ],
      currentState: 0,
      tempUrlList: []
    };
  },
  computed: { ...mapGetters(['getSimpleActive', 'getSelfDomActive', 'getThemeActive']) },
  methods: {
    ...mapActions(['GetUserConfig']),
    /**
     * @Description: 滚动条
     * @Param:
     * @Return:
     * @Author: lkh
     * @Date: 2019/12/19 14:40
     **/
    handleScrollEvent(dom) {},
    filter() {
      return getSetting('BASE_API') + '/gzt/bjtpImport';
    },
    themeManage(index, disable) {
      if (disable) {
        return;
      }
      this.active = index;
      let themeData = this.themeList[index];
      if ('JYFG' == themeData.type) {
        this.bgList = this.currObjData.jyList;
        this.bgActive = 0;
      }
      if ('GXFG' == themeData.type) {
        this.bgList = this.currObjData.gxList;
        this.bgActive = 1;
      }

      this.$emit('themeManage', themeData);
      this.ruleForm.xtzt = themeData.type;
      this.ruleForm.bjtpid = this.bgList[this.bgActive].bjtpid;
    },
    bgManage(index) {
      this.bgActive = index;
      let bjData = this.bgList[index];
      let param = {
        index: index,
        data: bjData
      };
      this.$emit('bgManage', param);
      this.ruleForm.bjtpid = bjData.bjtpid;
    },
    modify() {
      let index = this.bgActive;
      let bjData = this.bgList[index];
      gztApi.saveXtztAndBjtp(this.ruleForm).then(res => {
        let param = {
          index: index,
          data: bjData
        };
        this.$emit('modify', param);
        // 清空全局变量
        window.HOMEACCESS = null;
        // 重新保存全局变量
        gztApi.loadUserManagerDetail().then(res => {
          let soucesData = res.data;
          try {
            sessionStorage.userConfig = JSON.stringify(soucesData);
          } catch (e) {
            console.error('===set userConfig error==', sessionStorage.userConfig);
          }
        });
      });
    },
    cancel() {
      this.$emit('cancel');
      if ('JYFG' == this.currentType && this.bgActive != this.currObjData.jyCurData.index) {
        this.bgActive = this.currObjData.jyCurData.index;
      }
      if ('GXFG' == this.currentType && this.bgActive != this.currObjData.gxCurData.index) {
        this.bgActive = this.currObjData.gxCurData.index;
      }
      this.bgManage(this.bgActive);
    },
    handleData(mydata) {
      this.ruleForm.xtzt = mydata.dqxtzt;
      this.ruleForm.bjtpid = mydata.dqbjtpid;
      this.currActiveId = mydata.dqbjtpid;
    },
    /**
     * @MethodName: getPicUrl
     * @Description: 获取图片地址
     * @Param:
     * @Return:
     * @Author: suqh
     * @Date: 2019/11/19 18:49
     **/
    getCurrentBj(hisArray) {
      let mydata = hisArray;
      let resMap = {
        // 整理背景数据--备用
        index: -1,
        currData: null,
        bgList: [],
        // 封装简约风格的背景数据
        jyList: [],
        jyCurData: {
          index: -1,
          data: null
        },
        // 封装个性风格的背景数据
        gxList: [],
        gxCurData: {
          index: -1,
          data: null
        }
      };
      if (mydata && mydata.bjtpList && mydata.bjtpList.length > 0) {
        let bgList = [];
        let jyList = [];
        let gxList = [];
        for (let i = 0; i < mydata.bjtpList.length; i++) {
          let hi = mydata.bjtpList[i];
          if (hi.bjtpid == mydata.dqbjtpid) {
            resMap.index = i;
            resMap.currData = hi;
          }
          if ('JYFG' == hi.type || 'GXFG' == hi.type) {
            // 获取要获取的背景图片的序号
            let bjNum = Number(hi.bjtpid.substring(hi.bjtpid.length - 2, hi.bjtpid.length));
            if ('JYFG' == hi.type) {
              hi.bjtpurl = this.simpleList[bjNum].src;
              jyList.push({
                src: hi.bjtpurl,
                isSystem: hi.isSystem,
                bjtpid: hi.bjtpid,
                type: hi.type,
                index: bjNum
              });
            }
            if ('GXFG' == hi.type) {
              hi.bjtpurl = this.selfdomList[bjNum].src;
              gxList.push({
                src: hi.bjtpurl,
                isSystem: hi.isSystem,
                bjtpid: hi.bjtpid,
                type: hi.type,
                index: bjNum
              });
            }
          } else {
            jyList.push({
              src: hi.bjtpurl,
              isSystem: hi.isSystem,
              bjtpid: hi.bjtpid,
              type: hi.type,
              index: i
            });
            gxList.push({
              src: hi.bjtpurl,
              isSystem: hi.isSystem,
              bjtpid: hi.bjtpid,
              type: hi.type,
              index: i
            });
          }
          if ('JYFG' == hisArray.dqxtzt) {
            if (hi.bjtpid == mydata.dqbjtpid) {
              resMap.jyCurData.index = jyList.length - 1;
              resMap.jyCurData.data = jyList[jyList.length - 1];
            }
          }
          if ('GXFG' == hisArray.dqxtzt) {
            if (hi.bjtpid == mydata.dqbjtpid) {
              resMap.gxCurData.index = gxList.length - 1;
              resMap.gxCurData.data = gxList[gxList.length - 1];
            }
          }
          bgList.push({
            src: hi.bjtpurl,
            isSystem: hi.isSystem,
            bjtpid: hi.bjtpid,
            type: hi.type,
            index: i
          });
        }
        resMap.bgList = bgList;
        resMap.jyList = jyList;
        resMap.gxList = gxList;
        // 未找到当前背景图片的index默认为第一个
        if (resMap.index == -1) {
          resMap.index = 0;
          resMap.currData = bgList[0];
        }
        if (resMap.jyCurData.index == -1) {
          resMap.jyCurData.index = 0;
          resMap.jyCurData.data = jyList[0];
        }
        if (resMap.gxCurData.index == -1) {
          resMap.gxCurData.index = 0;
          resMap.gxCurData.data = gxList[0];
        }
      } else {
        return null;
      }
      return resMap;
    },
    /**
     * 文件上传限制控制
     * @param {Object} file 文件流数据
     * @param {Boolean} flag （true,false） 区分为文件和图片
     */
    beforeAvatarUpload(file, flag) {
      if (flag) {
        const isXlSX = file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        if (!isXlSX) {
          this.$message.error('上传图片只能是 XLSX 格式!');
        }
        return isXlSX;
      } else {
        const isJPG = file.type === 'image/jpeg';
        const isPNG = file.type === 'image/png';
        if (!isJPG && !isPNG) {
          this.$message.error('上传图片只能是 JPG 或 PNG 格式!');
        }
        return isJPG || isPNG;
      }
    },
    /**
     * 文件上传成功回调
     * @param {Object} response 接口返回的数据
     * @param {Object} file 单前文件流
     * @param {Array} fileList 已经上传的文件的文件列表
     */
    imgSuccess(res, file, fileList) {
      let hi = res;
      this.tempUrlList.push(res);
      let data = { src: hi.bjtpurl, isSystem: hi.isSystem, bjtpid: hi.bjtpid, type: hi.type, index: -1 };
      this.currObjData.jyList.push(data);
      this.currObjData.gxList.push(data);
      if ('JYFG' == this.ruleForm.xtzt) {
        this.bgList = this.currObjData.jyList;
      }
      if ('GXFG' == this.ruleForm.xtzt) {
        this.bgList = this.currObjData.gxList;
      }
      this.GetUserConfig();
      window.HOMEACCESS = null;
    },
    /**
     * 背景图片删除
     */
    del(item, index) {
      if ('JYFG' == this.ruleForm.xtzt) {
        this.currObjData.jyList.splice(index, 1);
        this.currObjData.jyList.forEach((itemOne, indexOne) => {
          if (itemOne.bjtpid == item.bjtpid) {
            this.currObjData.jyList.splice(indexOne, 1);
          }
        });
        this.bgList = this.currObjData.jyList;
      }
      if ('GXFG' == this.ruleForm.xtzt) {
        this.currObjData.gxList.forEach((itemOne, indexOne) => {
          if (itemOne.bjtpid == item.bjtpid) {
            this.currObjData.gxList.splice(indexOne, 1);
          }
        });
        this.bgList = this.currObjData.gxList;
      }
      gztApi.deteleBjtpById(item.bjtpid).then(res => {
        window.HOMEACCESS = null;
      });
      this.GetUserConfig();
    }
  },
  mounted() {
    if (!window.HOMEACCESS) {
      gztApi.loadUserManagerDetail().then(res => {
        let myData = res.data;
        window.HOMEACCESS = myData;
        this.currAllData = window.HOMEACCESS;
        this.handleData(this.currAllData);
        this.currObjData = this.getCurrentBj(this.currAllData);
        if ('JYFG' == this.currentType) {
          this.currentState = this.active = 0;
          this.bgList = this.currObjData.jyList;
          this.bgActive = this.currObjData.jyCurData.index;
        }
        if ('GXFG' == this.currentType) {
          this.currentState = this.active = 1;
          this.bgList = this.currObjData.gxList;
          this.bgActive = this.currObjData.gxCurData.index;
        }
      });
    } else {
      this.currAllData = window.HOMEACCESS;
      this.handleData(this.currAllData);
      this.currObjData = this.getCurrentBj(this.currAllData);
      if ('JYFG' == this.currentType) {
        this.currentState = this.active = 0;
        this.bgList = this.currObjData.jyList;
        this.bgActive = this.currObjData.jyCurData.index;
      }
      if ('GXFG' == this.currentType) {
        this.currentState = this.active = 1;
        this.bgList = this.currObjData.gxList;
        this.bgActive = this.currObjData.gxCurData.index;
      }
    }
  }
};
</script>

<style scoped lang="scss">
/*@import "index.scss";*/
</style>
