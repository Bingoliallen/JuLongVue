<!--
 * @Author: Liugh
 * @Date: 2020-10-15 09:31:43
 * @LastEditTime: 2020-11-04 09:11:05
 * @LastEditors: Do not edit
 * @Description: 桌面拖拽
-->
<template>
  <div @dragover="allowDrop" @drop="drop" class="dg-rubbishContainer" ref="dragDiv">
    <transition-group name="flip-list" tag="ul" class="dg-rubbishContainer__list" ref="dragList">
      <li
        v-for="(item, index) in list"
        :draggable="!item.fill"
        :class="['dg-rubbishContainer__list__item', !item.fill ? 'hover' : '']"
        @dragstart.self="dragstart($event, index)"
        @click="routerLink(item)"
        :key="item.yypx"
      >
        <div class="dg-rubbishContainer-app" :data-code="item.code" v-if="item.yypx !== 999">
          <div class="dg-rubbishContainer-app__box" :class="item.yybjys">
            <i class="dg-rubbishContainer-app__box--icon icon" :class="item.yytb"></i>
            <div class="dg-rubbishContainer-app__box--shadow" :class="item.yybjys"></div>
          </div>
          <p class="dg-rubbishContainer-app__box--text">{{ item.yymc }}</p>
          <div
            v-if="!item.fill"
            class="dg-rubbishContainer__list__item-edit"
            :class="isEdit ? 'del' : item.isAddToMyApp ? 'del' : 'add'"
            @click.stop="changeAppToMyApp(item, index)"
          ></div>
        </div>
        <div class="dg-rubbishContainer-app" @click.stop="applicationLink" v-else-if="iShowMore">
          <div class="dg-rubbishContainer-app__box" :class="item.yytb"></div>
          <p class="dg-rubbishContainer-app__box--text">{{ item.yymc }}</p>
        </div>
      </li>
      <!-- <li class="dg-rubbishContainer__list__item" ref="app" :key="more.yypx" v-if="iShowMore">
        <div class="dg-rubbishContainer-app" @click="applicationLink">
          <div class="dg-rubbishContainer-app__box" :class="more.yytb"></div>
          <p class="dg-rubbishContainer-app__box--text">{{ more.appName }}</p>
        </div>
      </li> -->
    </transition-group>
  </div>
</template>
<script>
import gztApi from '../../../api/gztApi';
export default {
  name: 'writeDraggable', // 组件名称
  props: {
    // 接收父组件的数据
    data: {
      type: Array,
      default() {
        return [];
      }
    },
    iShowMore: {
      type: Boolean,
      default: true
    },
    isEdit: {
      type: Boolean,
      default: false
    }
  },
  data() {
    // 组件内部参数
    return {
      // 参数名称及默认值
      more: { id: 1, appName: '添加模块', appLink: 'apps', yypx: 999, yytb: 'addModuleBtn' },
      list: [],
      listSize: 28
    };
  },
  computed: {}, // 计算属性
  watch: {
    data: {
      handler(val) {
        val.forEach((item, index) => {
          if (!(item.listIndex || item.listIndex == 0)) {
            item.listIndex = index;
          }
        });
        let list = this.createList(this.listSize);
        list.forEach(item => {
          val.forEach(itemOne => {
            if (item.listIndex == itemOne.listIndex) {
              list.splice(item.listIndex, 1, itemOne);
            }
          });
        });
        // if (this.iShowMore) {
        let metadataList = list.filter(item => {
          return !item.fill;
        });
        let listItem = [];
        metadataList.forEach(item => {
          if (item.yypx != 999) {
            listItem.push(Number(item.listIndex));
          }
        });
        for (let i = 0; i < this.listSize; i++) {
          if (!~listItem.indexOf(i)) {
            list.splice(i, 1, {
              fill: true,
              listIndex: i,
              sfwbyy: '1',
              yybh: 'TJMK',
              yybjys: 'TJMK',
              yymc: '添加模块',
              yypx: 999,
              yytb: 'addModuleBtn',
              yyurl: 'TJMK'
            });
            break;
          } else {
            if (~listItem.indexOf(i)) {
              continue;
            }
          }
        }
        // }
        this.list = list;
      },
      immediate: true
    },
    iShowMore: {
      handler(val) {
        if (val) {
          let list = this.list.filter(item => {
            return !item.fill;
          });
          // if (list.length == 0) {
          //   this.list.splice(0, 1, {
          //     fill: true,
          //     listIndex: 0,
          //     sfwbyy: '1',
          //     yybh: 'TJMK',
          //     yybjys: 'TJMK',
          //     yymc: '添加模块',
          //     yypx: 999,
          //     yytb: 'addModuleBtn',
          //     yyurl: 'TJMK'
          //   });
          // } else {
          //   let listItem = [];
          //   list.forEach(item => {
          //     if (item.yypx != 999) {
          //       listItem.push(Number(item.listIndex));
          //     }
          //   });
          //   for (let i = 0; i < this.listSize; i++) {
          //     if (!~listItem.indexOf(i)) {
          //       this.list.splice(i, 1, {
          //         fill: true,
          //         listIndex: i,
          //         sfwbyy: '1',
          //         yybh: 'TJMK',
          //         yybjys: 'TJMK',
          //         yymc: '添加模块',
          //         yypx: 999,
          //         yytb: 'addModuleBtn',
          //         yyurl: 'TJMK'
          //       });
          //       break;
          //     } else {
          //       if (~listItem.indexOf(i)) {
          //         continue;
          //       }
          //     }
          //   }
          // }
          if (list.length == this.listSize) {
            this.$message.warning('不能再添加更多了！');
          }
        }
      },
      immediate: true
    }
  }, // 侦听器（扩展的计算属性）
  components: {}, // 注册局部组件
  methods: {
    /**
     * @description: 为删除数据填充空白数据
     * @param {Array} metaList 元数据
     * @return {null} null
     */
    fillList(metaList) {
      let list = this.createList(this.listSize);
      list.forEach(item => {
        metaList.forEach(itemOne => {
          if (item.listIndex == itemOne.listIndex) {
            list.splice(item.listIndex, 1, itemOne);
          }
        });
      });
      this.list = list;
    },
    createList(len) {
      let list = [];
      for (let index = 0; index < len; index++) {
        list.push({
          sfwbyy: Number(index) + Date.now(),
          listIndex: index,
          yybh: '',
          yybjys: '',
          yymc: '',
          yypx: Number(index) + Date.now(),
          fill: true,
          yytb: '',
          yyurl: ''
        });
      }
      // return [...new Array(len).keys()];
      return list;
    },
    dragstart(e, index) {
      e.dataTransfer.setData('targetIndex', index);
    },
    drop(e) {
      let targetEl = e.target;
      if (!targetEl.classList.contains('.dg-rubbishContainer__list__item')) {
        targetEl = targetEl.closest('li.dg-rubbishContainer__list__item');
      }
      let dataIndex = e.dataTransfer.getData('targetIndex');
      let dataIndexObj = this.list[dataIndex];
      let targetIndex;

      Array.prototype.forEach.call(this.$refs.dragDiv.children[0].children, (item, index) => {
        if (targetEl == item) {
          targetIndex = index;
        }
      });
      // 保留位置
      let beforListIndex = this.list[dataIndex].listIndex;
      let targetListIndex = this.list[targetIndex] && this.list[targetIndex].listIndex;

      this.list[targetIndex].listIndex = beforListIndex;
      this.$set(this.list, dataIndex, this.list[targetIndex]);
      dataIndexObj.listIndex = targetListIndex;
      this.$set(this.list, targetIndex, dataIndexObj);
      let listSub = this.list.filter(item => {
        return !item.fill;
      });
      gztApi.saveMyAllApp(listSub).then(res => {
        if (!res.data.status) {
          this.$message({ type: 'error', message: res.data.errorMessage, customClass: 'msg-transparent' });
        }
        // this.$message({ type: 'error', message: res.data.errorMessage, customClass: 'msg-transparent' });
      });
    },
    allowDrop(e) {
      let targetEl = e.target;
      if (
        targetEl.classList.contains('.dg-rubbishContainer__list__item') ||
        targetEl.closest('li.dg-rubbishContainer__list__item')
      ) {
        e.preventDefault();
      }
    },
    // 宽度自适应
    autoAdapterWidth() {
      let X = parseInt(this.$refs.dragList.$el.offsetWidth / 160);
      let Y = parseInt(this.$refs.dragList.$el.offsetHeight / 160);
      this.listSize = parseInt(X * Y);
      console.log(this.listSize);
      // let containerWidth = this.$el.offsetWidth;
      // let appCounts = this.$refs.apps.children[0].children.length;
      // let appWidth = this.$refs.app.offsetWidth;
      // if (appCounts * appWidth > containerWidth - appWidth) {
      //   this.$refs.apps.style.width =
      //     Math.floor(containerWidth / appWidth - 1) * appWidth + "px";
      // } else {
      //   this.$refs.apps.style.width = appCounts * appWidth + "px";
      // }
    },
    // 自适应窗口调整
    autoAdapterWindow() {
      // 检测是否宽度自适应
      // if (this.iShowMore) {
      this.autoAdapterWidth();
      // 窗口变化时宽度自适应
      window.addEventListener('resize', this.autoAdapterWidth);
      // }
    },
    // 路由跳转路径
    routerLink(row) {
      if (row.fill) return;
      if ('kssq' == row.yyurl) {
        // if (!this.isEdit) {
        //   //判断权限
        //   let the = this;
        //   let dialogContent = this.$dgLayer({
        //     // 标题
        //     title: '快速申请',
        //     // 组件内容
        //     component: require('../../pages/sys-manage/bs-apply/bc-add/index.vue'),
        //     btn: ['提交', '取消'],
        //     btnAlign: 'c',
        //     maxmin: false,
        //     skin: 'layer-transparent',
        //     area: ["850px", "auto"],
        //     yes(dialogIndex) {
        //       dialogContent.$children[0].onSubmit(res => {
        //         console.log('--><--', res);
        //           layer.close(dialogIndex);
        //           the.$router.push('/bs-apply');//         }
        //       });
        //     },
        //     btn2() {
        //       //清空已经上传多余数据
        //       dialogContent.$children[0].clearImgFile();
        //     }
        //   });
        // }
      } else {
        if (!this.isEdit) {
          if (row.sfwbyy == '1') {
            let url = row.yyurl.replace('http://', '');
            window.open('http://' + url, '_blank');
          } else {
            this.$router.push(row.yyurl.trim());
          }
        } else {
          return;
        }
      }
    },
    applicationLink() {
      let list = this.list.filter(item => {
        return !item.fill;
      });
      if (list.length == this.listSize) {
        this.$message.warning('不能再添加更多了！');
        return null;
      }
      this.$emit('applicationLink', this.listSize);
    },
    // 操作当前APP与我的应用关系
    changeAppToMyApp(value, index) {
      // 获取当前ID及状态
      this.list.splice(index, 1);
      this.fillList(this.list);
      if (value.sfwbyy == 0) {
        this.$parent.myAppList.forEach((item, index) => {
          if (item.yybh == value.yybh) {
            this.$parent.myAppList.splice(index, 1);
            this.$parent.otherAppList.unshift(value);
          }
        });
        this.$parent.draggableData.forEach((item, index) => {
          if (item.yybh == value.yybh) {
            this.$parent.draggableData.splice(index, 1);
          }
        });
      }
    }
  }, // 内部方法
  beforeCreate() {}, // 组件创建前
  created() {
    // 自适应窗口调整
  }, // 组件创建完成后
  beforeMount() {}, // 组件挂载前
  mounted() {
    // this.autoAdapterWindow();
  }, // 组件挂载完成后
  beforeUpdate() {}, // 组件更新前
  updated() {
    // 自适应窗口调整
    // this.autoAdapterWindow();
  }, // 组件挂载完成后
  beforeDestroy() {}, // 组件销毁前
  destroyed() {
    window.removeEventListener('resize', this.autoAdapterWidth);
  } // 组件销毁完成后
};
</script>
<style lang="scss" scoped>
@import './index.scss';
</style>
