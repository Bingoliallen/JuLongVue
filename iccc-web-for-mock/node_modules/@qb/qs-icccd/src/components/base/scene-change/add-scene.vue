<!--
 此处填写文件描述
 @Author: lbb
 @Date: 2019-04-03
-->
<template>
  <div>
    <el-form label-width="150px" ref="addScene" :model="addData" :rules="rules">
      <el-form-item label="专项（场景）名称：" prop="cjmc">
        <el-input
          placeholder="请输入专项（场景）名称，字数不超过10字"
          v-model="addData.cjmc"
          maxlength="10"
          show-word-limit
        ></el-input>
      </el-form-item>
      <el-form-item label="专项（场景）分类：" prop="cjfl">
        <!--        :data="selectObj.personList"-->
        <dg-select
          v-model="addData.cjfl"
          placeholder="请选择专项（场景）类别"
          code="BM_ICCC_CJFL"
          :no-cache="true"
        ></dg-select>
      </el-form-item>
      <el-form-item label="专项（场景）介绍：" prop="cjjs" class="url-input">
        <el-input
          placeholder="请输入专项（场景）介绍，字数不超过50字"
          v-model="addData.cjjs"
          type="textarea"
          :rows="3"
          maxlength="50"
          show-word-limit
          clearable
        ></el-input>
      </el-form-item>

      <el-form-item label="场景封面图片：" prop="cjfm">
        <qb-upload
          :action="action"
          v-model="addData.cjfm"
          class="avatar-uploader"
          leaflet
          list-type="pictureList"
          icon-zoom
          icon-delete
          icon-plus
          :show-file-list="false"
          :on-success="imgSuccess"
          :before-upload="file => beforeAvatarUpload(file)"
          accept=".jpg,.jpeg,.png,.bmp,.JPG,.JPEG,.PNG,.BMP"
        ></qb-upload>
      </el-form-item>
      <el-form-item label="场景功能选择：" prop="qxxz">
        <div class="add-module-icon__box" :class="{ 'module-error': isError }">
          <div
            @click="handleClickChecked(item, index)"
            v-for="(item, index) in addScenwSelectData"
            :key="index"
            style=" margin: 0.5rem;"
          >
            <div :class="['is-app', item.yybjys]">
              <i :class="['icon', item.yytb]"> </i>
              <el-checkbox
                class="module-check-box"
                v-model="item.checked"
                @click.stop.native="hanleClick($event.target.tagName, item)"
              ></el-checkbox>
            </div>
            <div class="title">{{ item.yymc }}</div>
          </div>
        </div>
      </el-form-item>
    </el-form>
  </div>
</template>
<script>
import sceneApi from '../../../api/sceneApi';
import gztApi from '../../../api/gztApi';
export default {
  name: 'test',
  // 接收父页面传过来的属性
  props: {
    card: {
      type: Object
    },
    myList: {
      type: Array,
      default: function() {
        return [];
      }
    }
  },
  // 页面数据绑定
  data() {
    return {
      isError: false,
      action: window.systemParams.BASE_API + '/v1/scene/image/upload',
      download: window.systemParams.BASE_API + '/fjUploader/download/ZP-',
      bjtpList: [],
      addData: {
        id: '',
        cjmc: '',
        cjfl: '',
        cjjs: '',
        cjfm: []
      },
      rules: {
        cjmc: [{ required: true, message: '请输入专项（场景）名称', trigger: 'blur' }],
        cjfl: [{ required: true, message: '请选择专项（场景）分类', trigger: 'blur' }],
        cjfm: [{ required: true, message: '请选择场景封面图片', trigger: 'blur' }],
        qxxz: [{ required: true, trigger: 'blur', validator: this.checkQXXZ }],
        cjjs: [{ required: true, message: '请输入专项（场景）介绍', trigger: 'blur' }]
      },
      addScenwSelectData: []
    };
  },
  // 计算属性
  computed: {},
  // 方法
  methods: {
    checkQXXZ(rule, value, callback) {
      let qxxzList = [];
      this.addScenwSelectData.forEach(item => {
        if (item.checked) {
          qxxzList.push(item);
        }
      });

      if (!qxxzList || !qxxzList.length) {
        this.isError = true;
        callback(new Error('请选择场景功能'));
      } else {
        this.isError = false;
        callback();
      }
    },
    hanleClick(name, item) {
      if (name != 'INPUT') return;
      item.checked = !item.checked;
      this.$forceUpdate();
    },
    handleClickChecked(item, index) {
      this.addScenwSelectData[index].checked = !this.addScenwSelectData[index].checked;
      this.$forceUpdate();
    },
    /**
     * 初始化数据
     *
     */
    init() {
      gztApi.loadMyApp().then(res => {
        this.addScenwSelectData = res.data.allSysAppList;
        this.addScenwSelectData.forEach(item => {
          item.checked = false;
        });
        if (this.card) {
          this.loadScene(this.card.id);
        }
      });
    },
    loadScene(id) {
      let that = this;
      sceneApi.load(id).then(res => {
        let appList = res.data.appList;
        appList.forEach(item => {
          that.addScenwSelectData.forEach(add => {
            if (item.yybh == add.yybh) {
              add.checked = true;
            }
          });
        });
        that.$forceUpdate();
      });
    },
    /**
     * 文件上传限制控制
     * @param {Object} file 文件流数据
     * @param {Boolean} flag （true,false） 区分为文件和图片
     */
    beforeAvatarUpload(file) {
      const isJPG = file.type === 'image/jpeg';
      const isPNG = file.type === 'image/png';
      const isBMP = file.type === 'image/bmp';

      const isLt1M = file.size / 1024 / 1024 < 1;
      if (!isJPG && !isPNG && !isBMP) {
        this.$message.error('上传图片只能是 JPG 、 PNG 或 BMP 格式!');
      }
      if (!isLt1M) {
        this.$message.error('上传图片大小不能超过 1MB!');
      }

      return (isJPG || isPNG || isBMP) && isLt1M;
    },
    /**
     * 文件上传成功回调
     * @param {Object} response 接口返回的数据
     * @param {Object} file 单前文件流
     * @param {Array} fileList 已经上传的文件的文件列表
     */
    imgSuccess(res, file, fileList) {
      this.addData.cjfm = [];
      // let hi = res.data[0];
      let hi = res[0];
      let data = { url: this.download + hi.id, bjtpid: hi.id, type: hi.fileType };
      this.addData.cjfm.push(data);
    }
  },
  mounted() {
    // 数据初始化
    this.init();
    if (this.card) {
      this.addData.id = this.card.id;
      this.addData.cjmc = this.card.name;
      this.addData.cjfl = this.card.type;
      this.addData.cjjs = this.card.describe;
      this.addData.cjfm = [];
      if (this.card.imageId) {
        this.addData.cjfm.push({
          url: this.download + this.card.imageId,
          bjtpid: this.card.imageId,
          type: this.card.image_type
        });
      }
    }
  },
  // 组件创建时调用
  created() {}
};
</script>
<style lang="scss" scoped>
/deep/.dg-upload__list {
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  display: inline-block;
  padding: 0px;
  background: var(--disabled-fill-base);
  border: 1px dashed var(--disabled-border-base);
  border-radius: 2px;
}
/deep/ .dg-upload__shade i + i {
  margin-left: 5px;
}
/deep/ .dg-upload--text {
  margin: 24px 0;
}

/deep/.el-carousel__item.is-animating {
  height: 90px;
  width: 90px;
  -webkit-transition: -webkit-transform 0.4s ease-in-out;
  transition: -webkit-transform 0.4s ease-in-out;
  transition: transform 0.4s ease-in-out;
  transition: transform 0.4s ease-in-out, -webkit-transform 0.4s ease-in-out;
}
/deep/.dg-upload__carousel {
  position: relative;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  border-radius: 2px;
  width: 90px;
  height: 90px;
}

/deep/.el-carousel__container {
  position: relative;
  height: 90px !important;
}

/deep/.el-carousel__item.is-animating img {
  width: 100%;
  height: 100%;
  border-radius: 2px;
}

.dg-upload .avatar-uploader-icon,
/deep/.dg-upload--pictureList {
  font-variant: JIS04;
  -webkit-box-sizing: border-box;
  height: 90px;
  line-height: 90px;
  width: 90px;
}
.avatar-uploader {
  line-height: normal;
}

/deep/.add-module-icon__box .is-app {
  position: relative;
  width: 50px;
  height: 50px;
  margin: 0.5rem;
  line-height: 50px;
  border-radius: 4px;
  text-align: center;
  color: var(--color-white);
  cursor: pointer;
  .el-checkbox {
    content: '';
    position: absolute;
    top: -24px;
    left: -8px;
    width: 18px;
    height: 18px;
  }
}
/deep/.el-form-item__error {
  padding-top: 2px;
}
.module-error {
  border-color: var(--color-danger);
}
.title {
  width: 100%;
  opacity: 0.65;
  font-family: MicrosoftYaHei;
  font-size: 14px;
  color: var(--color-black);
  align-items: center;
  text-align: center;
  line-height: 20px;
}
.module-check-box /deep/ .el-checkbox__inner {
  background-color: var(--color-white);
}
.module-check-box /deep/ .el-checkbox__input.is-checked .el-checkbox__inner {
  background-color: var(--button-color-primary);
}
</style>
