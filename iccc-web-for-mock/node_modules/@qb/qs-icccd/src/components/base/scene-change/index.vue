<!--
 此处填写文件描述
 @Author: lbb
 @Date: 2019-04-03
-->
<template>
  <search-page-grid
    class="scenes-list"
    ref="line"
    :url="url"
    :condition="queryMap"
    :gridConfig="gridConfig"
    :toolConfig="toolConfig"
    :paginationProps="paginationProps"
    @active-change="itemActive"
    :activeFirst="true"
    :node-filter="nodeFilter"
  >
    <template v-slot:tool>
      <div class="about-us-tab">
        <div class="scenes-tab-list__box">
          <ul class="scenes-tab-list">
            <li v-for="(item, index) in tabList" :key="index" @click="scenesTab(item, index)">
              <a :class="{ 'is-active': index == curTabType }">{{ item.name }}</a>
            </li>
          </ul>
          <dg-button
            style="float: right;"
            type="primary"
            plain
            size="medium"
            :disabled="false"
            @click="addScenes"
            v-permission="['CJBJ00']"
            >新增场景</dg-button
          >
        </div>
      </div>
    </template>
    <template v-slot="{ data, node }">
      <scene-card
        :card="data"
        :class="{ active: data.id == dqcjid }"
        :active="data.id == dqcjid"
        :callbackFn="callbackFn"
        @scene-change="sceneChange"
      >
      </scene-card>
    </template>
  </search-page-grid>
</template>
<script>
import SceneCard from './scene-card';
import SearchPageGrid from '../search-page-grid/index';
import sceneApi from '../../../api/sceneApi';
import { mapActions } from 'vuex';
let userConfig = {};
try {
  userConfig = JSON.parse(sessionStorage.userConfig);
} catch (er) {
  userConfig = {};
}
export default {
  name: 'scene-change',
  // 接收父页面传过来的属性
  props: {
    callbackFn: {
      type: null,
      default: null
    }
  },
  components: { SceneCard, SearchPageGrid },
  // 页面数据绑定
  data() {
    return {
      url: '/v1/scene/_search',
      pageType: 'scene',
      pageSize: 8,
      dqcjid: userConfig.dqcjid,
      paginationProps: {
        currentPage: 1,
        pageSizes: [8],
        pageSize: 8,
        layout: 'total, sizes, prev, pager, next, jumper',
        total: 0
      },
      queryMap: [],
      gridConfig: {
        // 格子宽
        itemWidth: '13.75rem',
        itemHeight: '15rem',
        // 间距
        gap: '2rem'
      },
      toolConfig: {
        class: '',
        checkbox: false
      },
      curTabActiveCard: null,
      tabList: [
        {
          name: '全部场景',
          type: 'ALL'
        },
        {
          name: '涉稳',
          type: '1'
        },
        {
          name: '涉赌',
          type: '3'
        }
      ],
      curTabType: 0
    };
  },
  // 计算属性
  computed: {},
  // 方法
  methods: {
    ...mapActions(['GetUserConfig']),
    loadData() {
      this.$nextTick(() => {
        this.$refs.line && this.$refs.line.search();
      });
    },
    scenesTab(item, index) {
      this.curTabType = index;
      if (item.type === 'all') {
        this.queryMap = [];
      } else {
        this.queryMap = [{ name: 'type', value: item.type, op: '=' }];
      }
      this.loadData();
    },
    sceneChange(card) {
      this.loadData();
    },
    /**
     * 新增场景
     */
    addScenes() {
      let that = this;
      let addLayer = this.$dgLayer({
        // 标题
        title: '新增专项（场景）',
        maxmin: false,
        content: require('../../../components/base/scene-change/add-scene'),
        area: ['50.125rem', '35.875rem'],
        props: { callbackFn: that.callbackFn },
        btn: ['保存', '取消'],
        btnAlign: 'c',
        resize: false,
        skin: 'layer-transparent',
        yes: index => {
          addLayer.$children[0].$refs['addScene'].validate(valid => {
            if (valid) {
              let addScenwSelectData = addLayer.$children[0].addScenwSelectData;
              let addData = addLayer.$children[0].addData;
              let bjtpid = '';
              if (addData.cjfm && addData.cjfm.length > 0) {
                bjtpid = addData.cjfm[0].bjtpid;
              }
              let appList = [];
              addScenwSelectData.forEach(item => {
                if (item.checked) {
                  appList.push({
                    listIndex: item.listIndex,
                    sceneId: item.sceneId,
                    sfwbyy: item.sfwbyy,
                    yybh: item.yybh,
                    yybjys: item.yybjys,
                    yymc: item.yymc,
                    yypx: item.yypx,
                    yytb: item.yytb,
                    yyurl: item.yyurl
                  });
                }
              });

              let sceneVo = {
                appList: appList,
                describe: addData.cjjs,
                imageId: bjtpid,
                name: addData.cjmc,
                type: addData.cjfl
              };
              sceneApi.add(sceneVo).then(res => {
                let sceneId = res.data.id;
                let sceneName = res.data.name;
                layer.close(index);
                that.loadData();
                that
                  .$dgConfirm('您是否要修改默认参数？', '提示', {
                    confirmButtonText: '是',
                    cancelButtonText: '否',
                    customClass: 'confirm_user',
                    cancelButtonClass: 'btn-custom-cancel',
                    confirmButtonClass: 'btn-custom-submit',
                    closeOnClickModal: false,
                    type: 'warning'
                  })
                  .then(() => {
                    if (that.callbackFn) {
                      that.callbackFn(sceneVo);
                    } else {
                      layer.closeAll();
                      let userConfig = JSON.parse(sessionStorage.getItem('userConfig'));
                      userConfig.dqcjid = sceneId;
                      userConfig.dqcjmc = sceneName;
                      sessionStorage.userConfig = JSON.stringify(userConfig);
                      window.HOMEACCESS = userConfig;
                      that.$parent.$parent.init();
                      that.$router.push({
                        name: 'scenes-add',
                        query: {
                          id: sceneId,
                          name: encodeURIComponent(sceneVo.name)
                        }
                      });
                    }
                    this.GetUserConfig();
                  })
                  .catch(() => {});
              });
            } else {
              return false;
            }
          });
        },
        btn2() {}
      });
    },
    itemActive(node) {
      this.dqcjid = node.id;
      this.curTabActiveCard = node;
    },
    nodeFilter(nodeList) {
      return nodeList.map(node => {
        const { data } = node;
        // 是否禁止操作（未确认或者本节点被确认，不禁用）
        return node;
      });
    },
    init() {}
  },
  // 组件创建时调用
  created() {
    this.init();
  },
  mounted() {}
};
</script>
<style scoped lang="scss">
.about-us-tab {
  width: 100%;
  background-color: var(--scene-change_tab_background-color);
  width: 100%;
  margin: 0px auto 0px auto;

  .scenes-tab-list__box {
    background: #fff;
    display: flex;
    align-items: center;
    border-bottom: var(--border-light);
    .title {
      font-family: MicrosoftYaHei;
      font-size: 28px;
      color: var(--scene-change_title_color);
      text-align: center;
      line-height: 28px;
      padding: 40px 0 40px 0;
    }
  }

  .scenes-tab-list {
    display: flex;
    width: 100%;
    height: 56px;
    margin: 0 auto 0px;
    background: var(--scene-change_tab_background-color);

    li {
      height: 56px;
      line-height: 45px;
      list-style: none;
      text-align: center;
      width: 6.5rem;
      cursor: pointer;
    }

    a {
      display: inline-block;
      /*padding: 0 20px;*/
      font-family: MicrosoftYaHei;
      font-size: 16px;
      line-height: 56px;

      color: var(--scene-change_list_color);
      text-align: center;
    }

    a.is-active {
      border-bottom: var(--scene-change_is-active_border-light);
      font-family: MicrosoftYaHei-Bold;
      font-size: 16px;
      color: var(--scene-change_is-active_color);
      text-align: center;
      line-height: 56px;
    }
  }
}
</style>
