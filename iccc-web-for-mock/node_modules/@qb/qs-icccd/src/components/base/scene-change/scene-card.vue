<!--
 此处填写文件描述
 @Author: lbb
 @Date: 2019-04-03
-->
<template>
  <div class="scenes-card" :class="{ active }">
    <div class="scenes-image">
      <img :src="card.imageId ? download + card.imageId : errorImg" @error="handleError" alt="" ref="img" />
    </div>
    <div class="scenes-info">
      <h3 :title="card.name" class="scenes-info__title">{{ card.name }}</h3>
      <h5 class="scenes-info__num">
        <span class="scenes-info__fire"><i class="icon iconl-fire"></i>{{ card.cjsycs ? card.cjsycs : '0' }}</span>
        <span class="scenes-info__oper"
          ><i class="icon iconl-delete" @click="deleteScene" v-if="card.candel == 1" v-permission="['CJBJ00']"></i
        ></span>
        <span class="scenes-info__oper"
          ><i class="icon iconl-edit" @click="onReset" v-permission="['CJBJ00']"></i>
        </span>
      </h5>
      <p class="scenes-info__describe">{{ card.describe }}</p>
    </div>
  </div>
</template>
<script>
import { mapActions } from 'vuex';
import sceneApi from '../../../api/sceneApi';
export default {
  name: 'test',
  // 接收父页面传过来的属性
  props: {
    active: Boolean,
    card: {
      type: Object
    },
    errorImg: {
      // 场景的默认图片
      type: String,
      default: '/static/icccd/images/scene_image.png'
    },
    callbackFn: {
      type: null,
      default: null
    }
  },
  // 页面数据绑定
  data() {
    return {
      download: window.systemParams.BASE_API + '/fjUploader/download/ZP-'
    };
  },
  // 计算属性
  computed: {},
  // 方法
  methods: {
    ...mapActions(['GetUserConfig']),
    /**
     * @description:
     * @param {Object} e 事件对象
     * @return {null} null
     */
    handleError(e) {
      e.target.src = this.errorImg;
    },
    /**
     * 修改场景
     */
    onReset() {
      let the = this;
      let resetLayer = this.$dgLayer({
        // 标题
        title: '编辑专项（场景）',
        maxmin: false,
        content: require('../../../components/base/scene-change/add-scene'),
        area: ['50.125rem', '35.875rem'],
        btn: ['确认修改', '编辑参数', '取消'],
        btnAlign: 'c',
        resize: false,
        skin: 'layer-transparent',
        props: {
          card: the.card
        },
        yes: index => {
          the.saveScence(resetLayer, index);
        },
        btn2: index => {
          the.saveScence(resetLayer, index, true);
          return false;
        }
      });
    },
    saveScence(resetLayer, index, edit) {
      let the = this;
      resetLayer.$children[0].$refs['addScene'].validate(valid => {
        if (valid) {
          let addScenwSelectData = resetLayer.$children[0].addScenwSelectData;
          let addData = resetLayer.$children[0].addData;
          let bjtpid = '';
          if (addData.cjfm && addData.cjfm.length > 0) {
            bjtpid = addData.cjfm[0].bjtpid;
          }
          let appList = [];
          addScenwSelectData.forEach(item => {
            if (item.checked) {
              appList.push({
                listIndex: item.listIndex,
                sceneId: item.sceneId,
                sfwbyy: item.sfwbyy,
                yybh: item.yybh,
                yybjys: item.yybjys,
                yymc: item.yymc,
                yypx: item.yypx,
                yytb: item.yytb,
                yyurl: item.yyurl
              });
            }
          });

          let sceneVo = {
            id: addData.id,
            appList: appList,
            describe: addData.cjjs,
            imageId: bjtpid,
            name: addData.cjmc,
            type: addData.cjfl
          };
          sceneApi.update(sceneVo).then(res => {
            if (edit) {
              console.log(this);
              if (the.callbackFn) {
                the.callbackFn(sceneVo);
              } else {
                let userConfig = JSON.parse(sessionStorage.getItem('userConfig'));
                userConfig.dqcjid = sceneVo.id;
                userConfig.dqcjmc = sceneVo.name;
                sessionStorage.userConfig = JSON.stringify(userConfig);
                window.HOMEACCESS = userConfig;
                the.$parent.$parent.$parent.$parent.init();
                the.$router.push({
                  name: 'scenes-add',
                  query: {
                    id: sceneVo.id,
                    name: encodeURIComponent(sceneVo.name)
                  }
                });
                window.layer.closeAll();
              }
              the.GetUserConfig();
            } else {
              the.$message({
                message: '修改成功！',
                type: 'success'
              });
              window.layer.close(index);
              the.$emit('scene-change', the.card);
            }
          });
        } else {
          return false;
        }
      });
    },
    deleteScene() {
      let that = this;
      this.$dgConfirm('确定删除' + this.card.name + '？', '提示', {
        confirmButtonText: '确认',
        cancelButtonText: '取消',
        customClass: 'confirm_user',
        cancelButtonClass: 'btn-custom-cancel',
        confirmButtonClass: 'btn-custom-submit',
        closeOnClickModal: false,
        type: 'warning'
      })
        .then(() => {
          sceneApi.delete(that.card.id).then(res => {
            that.$message.success('删除成功');
            that.$emit('scene-change', that.card);
          });
        })
        .catch(() => {});
    }
  },
  // 组件创建时调用
  created() {}
};
</script>
<style lang="scss" scoped>
@mixin multi-ellipsis($line) {
  display: -webkit-box;
  -webkit-line-clamp: $line;
  /* autoprefixer: ignore next */
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.scenes {
  &-card {
    position: relative;
    height: 100%;
    cursor: pointer;
    text-align: left;
    max-height: 15rem;
    min-height: 15rem;
    overflow: hidden;
    box-shadow: 0 2px 4px 0 var(--border-shadow-color);
    &:hover {
      .scenes-image {
        height: 6rem;
        transition: 0.4s;
      }
    }
    &.active {
      border: 1px solid #1890ff;
      box-shadow: 0 3px 10px 0 var(--scene-card_container-active_box-shadow);
      .scenes-info__title {
        color: #1890ff;
      }
    }
  }
  &-image {
    height: 10.5rem;
    overflow: hidden;
    width: 100%;
    transition: 0.4s;
    display: inline-block;
    float: none;
    vertical-align: middle;
    img {
      width: 100%;
      vertical-align: bottom;
    }
  }
  &-info {
    transition: 0.4s;
    padding: 0.5rem 1rem;
    &__title {
      font-weight: bold;
      line-height: 1.75rem;
      font-size: 0.875em;
      color: var(--color-text-secondary);
      @include multi-ellipsis(1);
    }
    &__fire {
      font-size: 0.875em;
      color: var(--color-text-secondary);
      .icon {
        font-size: 0.75em;
        padding-right: 0.5rem;
      }
    }
    &__oper {
      font-size: 1em;
      color: var(--color-text-regular);
      float: right;
      .iconl-edit {
        margin-right: 0.5rem;
      }
      .icon {
        &:hover {
          color: var(--button-color-primary);
        }
      }
    }
    &__num {
      line-height: 1.75rem;
      @include multi-ellipsis(1);
    }
    &__describe {
      font-size: 0.875em;
      color: var(--color-text-secondary);
      text-align: justify;
      @include multi-ellipsis(3);
    }
  }
}
</style>
