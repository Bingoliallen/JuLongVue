<template>
  <div class="search-page-line" :class="{ scroll }" v-loading="loadding">
    <div class="search-page-line__tool" v-if="toolConfig" :class="toolConfig.class">
      <el-checkbox
        v-if="toolConfig.checkbox"
        :indeterminate="isIndeterminate"
        v-model="checkAll"
        @change="handleCheckAllChange('all')"
        >全选</el-checkbox
      >
      <slot name="tool" :selectedData="selectedData"></slot>
      <div class="sort-list" v-if="sortConfig">
        <sort-button
          v-for="item in sortConfig"
          :key="item.property"
          :class="{ active: sortColumn === item }"
          v-model="item.order"
          @change="sortBy(item)"
          >{{ item.label }}</sort-button
        >
      </div>
    </div>
    <no-record
      class="search-page-line__content"
      :class="{ scroll__content: scroll }"
      v-if="nodeList.length === 0"
    ></no-record>
    <div
      class="search-page-line__content"
      v-show="nodeList.length !== 0"
      :class="{ scroll__content: scroll, 'use-checkbox': toolConfig.checkbox, grid: gridConfig }"
      :style="getGridStyle()"
    >
      <div class="search-page-line__item" v-for="node in nodeList" :key="node.key" @click="handleActiveChange(node)">
        <el-checkbox
          v-if="toolConfig.checkbox && !node.disabled"
          v-model="node.checked"
          @change="handleCheckAllChange('one', node)"
        ></el-checkbox>
        <slot :node="node" :data="node.data"></slot>
      </div>
    </div>
    <el-pagination
      class="search-page-line__pagination"
      v-bind="paginationOptions"
      :current-page.sync="paginationOptions.currentPage"
      @size-change="handleSizeChange"
      @current-change="propHandleCurrentChange"
      @prev-click="handlePrevClick"
      @next-click="handleNextClick"
    ></el-pagination>
  </div>
</template>

<script>
import DgTable from '@srcPath/components/jz-base/table';
import DataOp from '@srcPath/utils/zt-data';

export default {
  name: 'search-page-line',
  props: {
    toolConfig: Object,
    // [{label,order,property}]
    sortConfig: Array,
    // 表格内部是否滚动；对应两种页面布局，滚动的话会固定表格高度且固定分页在页面底部；
    scroll: {
      type: Boolean,
      default: true
    },
    //  网格布局配置
    gridConfig: {
      type: Object,
      default() {
        return {
          // 格子宽
          itemWidth: 'var(--w, 448px)',
          // 格子高
          itemHeight: '120px',
          // 间距
          gap: '1rem'
        };
      }
    },
    pageSize: {
      type: Number,
      default: 10
    },
    // 分页参数配置
    paginationProps: {
      type: Object,
      default() {
        return {
          currentPage: 1,
          pageSizes: [6, 12, 24, 48, 96],
          pageSize: 12,
          layout: 'total, sizes, prev, pager, next, jumper',
          total: this.paginationTotal
        };
      }
    },
    nodeFilter: Function,
    // 分页限制
    pageLimit: Boolean,
    activeFirst: {
      type: Boolean,
      default() {
        return false;
      }
    },
    // 懒加载
    lazyLoad: {
      type: Boolean,
      default: true
    }
  },
  data() {
    return {
      currentPageLimit: null,
      // 缓存表格数据
      tempNodeList: [],
      // 被选中项
      selectedData: [],
      isIndeterminate: false,
      checkAll: false
    };
  },
  watch: {
    renderData: {
      handler(val) {
        const tempNodeList =
          (val &&
            val.map(data => {
              return {
                data,
                key: this.$tool.generateKey(),
                active: false,
                checked: false
              };
            })) ||
          [];
        this.gridReset(tempNodeList);
        this.tempNodeList = tempNodeList;
      }
    }
  },
  computed: {
    nodeList() {
      const nodeList = this.tempNodeList;
      return this.nodeFilter ? this.nodeFilter(nodeList) : nodeList;
    }
  },
  methods: {
    search(refresh) {
      if (!refresh) {
        // 回到第一页
        this.paginationOptions.currentPage = 1;
      }
      this.$tool.debounce(() => {
        this.loadData();
      })();
    },
    /**
     * 加载数据
     * TODO：替换组件的方法，待组件修复BUG后去掉
     * @param params 请求参数
     */
    loadData(params) {
      if (
        'client' === this.pagingType &&
        this.orignData &&
        this.orignData.length > 0 &&
        (!params || (!params.isInit && !params.url))
      ) {
        this._filterData();
        this.$emit('loaded', this.dataClient);
        return Promise.resolve();
      }

      this.loadding = true;

      if (params && params.url) {
        this.url = params.url;
      }
      let searchCondition = this.getReqSearchCondition();
      if (this.url.indexOf('faceGj/_search') != -1) {
        let sort = eval('(' + searchCondition.sort + ')');
        sort['pssj'] = 'desc';
        searchCondition.sort = JSON.stringify(sort);
      }
      return DataOp.reqTableData(this.$props, searchCondition).then(({ data }) => {
        setTimeout(() => {
          this.loadding = false;
        }, 200);

        const isArray = param => Object.prototype.toString.call(param) === '[object Array]';
        let total = 0;
        if (this.pagingType === 'client' && isArray(data)) {
          this.dataClient = data;
          this.orignData = data;
          total = data.length;
        } else {
          this.dataSource = data.content ? data.content : data;
          // TODO:下面一行是修改的代码
          total = data.totalElements || 0;
        }
        this.paginationOptions.total = total;
        this.$emit('loaded', data);
      });
    },
    /**
     * 每页记录数改变方法
     * TODO：替换组件的方法，待组件修复BUG后去掉
     * @param val 每页记录数
     */
    handleSizeChange(val) {
      this.paginationOptions.pageSize = val;
      this.search();
      this.$emit('change-size', val);
    },
    getDefaultSort() {
      if (this.defaultSort && this.sortConfig) {
        this.sortColumn = this.sortConfig.find(e => e.order) || {};
      }
    },
    sortBy(data) {
      this.sortColumn = data;
      this.sortConfig.forEach(item => {
        if (item !== data) {
          item.order = '';
        }
      });
      this.search();
    },
    getGridStyle(gridConfig = this.gridConfig) {
      return gridConfig
        ? `grid-template-columns: repeat(auto-fill, ${gridConfig.itemWidth || ''});
          grid-template-rows: repeat(auto-fill, ${gridConfig.itemHeight || ''});
          grid-gap: ${gridConfig.gap || ''};
          gap: ${gridConfig.gap || ''};`
        : '';
    },
    // 多选框的改变
    handleCheckAllChange(type, node) {
      if (type === 'all') {
        const checked = this.checkAll;
        this.nodeList.forEach(node => {
          node.checked = checked;
        });
        this.selectedData = checked ? this.nodeList.map(node => node.data) : [];
        this.isIndeterminate = false;
      }
      if (type === 'one') {
        if (node.checked) {
          this.selectedData.push(node.data);
        } else {
          this.selectedData.splice(this.selectedData.indexOf(node.data), 1);
        }
        let checkAll = this.nodeList.every(node => node.checked);
        this.checkAll = checkAll;
        this.isIndeterminate = !checkAll && this.selectedData.length > 0;
      }
    },
    // 单选
    handleActiveChange(node) {
      this.nodeList.forEach(node => {
        this.$set(node, 'active', false);
      });
      this.$set(node, 'active', true);
      this.$emit('active-change', node.data, node);
    },
    // 清空多选
    clearSelection() {
      this.checkAll = false;
      this.handleCheckAllChange('all');
    },
    propHandleCurrentChange(currentPage) {
      if (this.pageLimit && currentPage > this.currentPageLimit.num) {
        this.$tool.alert(this.currentPageLimit.tip);
        return;
      }
      this.handleCurrentChange(currentPage);
    },
    gridReset(nodeList) {
      this.selectedData = [];
      this.checkAll = false;
      this.isIndeterminate = false;
      if (this.activeFirst) {
        const node = nodeList[0];
        if (node) {
          this.$set(node, 'active', true);
          this.$emit('active-change', node.data, node);
        }
      }
    }
  },
  mixins: [DgTable],
  created() {
    let paginationProps;
    if (this.pageLimit) {
      this.currentPageLimit = {
        num: 2,
        tip: '仅支持查看最多 2 页数据，如需查看更多，请向上级发起申请进行扩容。'
      };
      paginationProps = {
        currentPage: 1,
        pageSizes: [this.pageSize, this.pageSize * 2],
        pageSize: this.pageSize,
        layout: 'total, sizes, prev, pager, next, jumper',
        total: this.paginationTotal
      };
    } else {
      paginationProps = this.paginationProps;
    }
    this.paginationOptions = { ...paginationProps };
    this.getDefaultSort();
  }
};
</script>

<style lang="scss" scoped>
.search-page-line {
  @include mq($large) {
    --w: 448px;
  }
  @include mq($medium) {
    --w: 431px;
  }
  @include mq($small) {
    --w: 398px;
  }
  &__tool {
    display: flex;
    align-items: center;
    > .el-checkbox {
      margin-right: 1rem;
    }
    .sort-list {
      flex: 1;
      text-align: right;
      .sort-button:not(.active) {
        color: rgba(0, 0, 0, 0.25);
      }
    }
  }
  &__content {
    &.use-checkbox {
      padding-left: 2rem;
      position: relative;
      .search-page-line__item {
        position: relative;
        > .el-checkbox {
          position: absolute;
          margin-left: -2rem;
        }
      }
      &.grid {
        .el-checkbox {
          top: 12px;
          right: 12px;
          line-height: 1;
          margin: 0;
        }
      }
    }
    &.grid {
      margin: 1.5rem 0 1rem;
      display: grid;
      justify-content: space-between;
      padding-left: 0;
    }
  }
  &__pagination {
    text-align: right;
  }
}

@include flex-dc('.scroll', true) {
  height: 100%;
}
</style>
