<!--
 * @Author: Liugh
 * @Date: 2020-01-10 09:46:17
 * @LastEditTime: 2020-11-04 11:05:35
 * @LastEditors: Do not edit
 * @Description:
 -->
<template>
  <div class="calendar xm_calendar">
    <div class="calendar-header">
      <!-- <div @click="handleToday()"> 今天</div> -->
      <ul class="calendar-header_ul">
        <li>
          <span @click="handlePrevYear()">
            <i><img src="../../../assets/images/calender/left.png" alt=""/></i> </span
          >&nbsp;&nbsp;
          <span @click="handlePrevMonth()">
            <i><img src="../../../assets/images/calender/xiangzuo.png" alt=""/></i
          ></span>
        </li>
        <li class="title">{{ nowTime }}</li>
        <li>
          <span @click="handleNextMonth()">
            <i><img src="../../../assets/images/calender/xiangyou.png" alt=""/></i></span
          >&nbsp;&nbsp;
          <span @click="handleNextYear()">
            <i><img src="../../../assets/images/calender/right.png" alt=""/></i
          ></span>
        </li>
      </ul>
    </div>
    <div class="calendar-weekheader">
      <ul class="calendar-weekheader_ul">
        <li v-for="(item, index) in week" :key="index">{{ item }}</li>
      </ul>
    </div>
    <div class="calendar-body">
      <ul class="calendar-body_ul">
        <li
          v-for="(item, index) in visibleCalendar"
          :class="{ nohover: filterState(item) }"
          :key="index"
          @click="handleClickDay(item, visibleCalendar)"
        >
          <el-popover
            v-if="item.isSigninCheck"
            :class="[
              { no: !isCurrentMonth(item.date) },
              { active: isCurrentDay(item.date) },
              { activeEv: item.isSigninCheck },
              { clickItem: item.clickDay }
            ]"
            placement="bottom"
            width="260"
            trigger="hover"
          >
            <div style="font-size:12px;">
              <ul>
                <li>
                  值班领导：<span>{{ hoverObj.name }}</span> <span>{{ hoverObj.phone }}</span>
                </li>
              </ul>
              <ul>
                <li v-for="(item, index) in hoverList" :key="index">
                  <span :class="{ 'color-with': index > 0 }">值班民警：</span><span>{{ item.name }}</span>
                  <span>{{ item.phone }}</span>
                </li>
              </ul>
            </div>
            <!-- <el-button slot="reference" @click="visible = !visible">手动激活</el-button> -->
            <span slot="reference" @mouseover="moushover(item)">{{ item.day }}</span>
          </el-popover>
          <span
            v-else
            :class="[
              { no: !isCurrentMonth(item.date) },
              { active: isCurrentDay(item.date) },
              { activeEv: item.isSigninCheck },
              { clickItem: item.clickDay }
            ]"
            >{{ item.day }}</span
          >
        </li>
      </ul>
    </div>
    <div class="calendar-footer">
      <!-- <dg-button @click="openSignin"  type="primary">值班签到</dg-button> -->
      <dg-button @click="openSignin" :disabled="isSingin == 2 || isSingin == 3" type="primary">{{
        { 1: '值班签到', 2: '已签到' }[isSingin] || '未签到'
      }}</dg-button>
    </div>
  </div>
</template>

<script>
import * as utils from './utils';
export default {
  name: 'calendar', // 组件名称
  props: {
    // 接收父组件的数据
  },
  data() {
    // 组件内部参数
    return {
      nowTime: utils.getNewDate(new Date()),
      time: utils.getNewDate(new Date()),
      week: ['一', '二', '三', '四', '五', '六', '日'],
      calendarList: [],
      signinDateList: [],
      isSingin: 1, // 1，值班签到，2已经签到，3未签到
      hoverList: [],
      hoverObj: {}
    };
  },
  computed: {
    /**
     * 计算显示的日期
     */
    visibleCalendar() {
      let calendatArr = [];
      let signinDateList = this.signinDateList;
      let { year, month, day } = utils.getNewDate(utils.getDate(this.time.year, this.time.month, 1));
      let currentFirstDay = utils.getDate(year, month, 1);
      // 获取当前月第一天星期几
      let weekDay = currentFirstDay.getDay();
      let startTime = currentFirstDay - (weekDay - 1) * 24 * 60 * 60 * 1000;
      let monthDayNum = 35;
      // let monthDayNum;
      // if (weekDay == 5 || weekDay == 6){monthDayNum = 42}else {monthDayNum = 35};
      for (let i = 0; i < monthDayNum; i++) {
        calendatArr.push({
          date: new Date(startTime + i * 24 * 60 * 60 * 1000),
          year: year,
          month: month + 1,
          day: new Date(startTime + i * 24 * 60 * 60 * 1000).getDate(),
          clickDay: false,
          isSigninCheck: signinDateList.some(item => {
            // if(this.isSingin==1){
            //     let date = utils.getDate(this.time.year,this.time.month,this.time.day);
            //     if(date.format('yyyyMMdd') == item){
            //         this.isSingin=2;
            //     }
            //     // this.isSingin = (date.format('yyyyMMdd') == item);
            // }
            return new Date(startTime + i * 24 * 60 * 60 * 1000).format('yyyyMMdd') == item;
          })
        });
      }
      return calendatArr;
    }
  }, // 计算属性
  watch: {}, // 侦听器（扩展的计算属性）
  components: {}, // 注册局部组件
  methods: {
    /**
     * 是否是当前月
     * @param {Object} date 传入判断的对象
     */
    isCurrentMonth(date) {
      let { year: currentYear, month: currentMonth } = utils.getNewDate(
        utils.getDate(this.time.year, this.time.month, 1)
      );
      let { year, month } = utils.getNewDate(date);
      return currentYear == year && currentMonth == month;
    },
    /**
     * 是否是今天
     * @param {Object} date 传入判断的对象
     */
    isCurrentDay(date) {
      let { year: currentYear, month: currentMonth, day: currentDay } = utils.getNewDate(new Date());
      let { year, month, day } = utils.getNewDate(date);
      return currentYear == year && currentMonth == month && currentDay == day;
    },
    /**
     * 上一年
     */
    handlePrevYear() {
      let prevYear = utils.getDate(this.time.year, this.time.month, 1);
      prevYear.setFullYear(prevYear.getFullYear() - 1);
      this.time = utils.getNewDate(prevYear);
      this.nowTime = prevYear.format('yyyy年MM月');
      this.signinSearch(prevYear.format('yyyyMM'));
      // this.markDate();
      // this.headOptions.date = `${utils.englishMonth(this.time.month)} ${this.time.year}`;
      // this.$emit('handlePrevMonth');
    },
    /**
     * 下一年
     */
    handleNextYear() {
      let nextYear = utils.getDate(this.time.year, this.time.month, 1);
      nextYear.setFullYear(nextYear.getFullYear() + 1);
      this.time = utils.getNewDate(nextYear);
      this.nowTime = nextYear.format('yyyy年MM月');
      this.signinSearch(nextYear.format('yyyyMM'));
      // this.markDate();
      // this.headOptions.date = `${utils.englishMonth(this.time.month)} ${this.time.year}`;
      // this.$emit('handleNextYear');
    },
    /**
     * 上一个月
     */
    handlePrevMonth() {
      let prevMonth = utils.getDate(this.time.year, this.time.month, 1);
      prevMonth.setMonth(prevMonth.getMonth() - 1);
      this.time = utils.getNewDate(prevMonth);
      this.nowTime = prevMonth.format('yyyy年MM月');
      this.signinSearch(prevMonth.format('yyyyMM'));
      // this.markDate();
      // this.headOptions.date = `${utils.englishMonth(this.time.month)} ${this.time.year}`;
      // this.$emit('handlePrevMonth');
    },
    /**
     * 下一个月
     */
    handleNextMonth() {
      let nextMonth = utils.getDate(this.time.year, this.time.month, 1);
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      this.time = utils.getNewDate(nextMonth);
      this.nowTime = nextMonth.format('yyyy年MM月');
      this.signinSearch(nextMonth.format('yyyyMM'));
      // this.markDate();
      // this.headOptions.date = `${utils.englishMonth(this.time.month)} ${this.time.year}`;
      // this.$emit('handleNextMonth');
    },
    /**
     * 点击回到今天
     */
    handleToday() {
      this.time = utils.getNewDate(new Date());
      // this.returnDate();
      // this.$emit('handleToday');
    },
    /**
     *  点击某一天
     * @param {Object} item 点击传入的对象
     */
    handleClickDay(item, allData) {
      this.$forceUpdate();
      let curDay = utils.getCurDate();
      let itemDay = new Date(item.date);
      // 如果大于当前日期就不选中
      if (itemDay.getTime() > curDay.getTime()) {
        return;
      }
      this.calendarList.map(x => {
        x.clickDay = false;
      });
      allData.map(x => {
        x.clickDay = false;
      });
      this.$set(item, 'clickDay', true);
      if (item.isSigninCheck) {
        this.isSingin = 2;
      } else {
        if (curDay.getTime() == itemDay.getTime()) {
          this.isSingin = 1;
          return;
        }
        this.isSingin = 3;
      }
    },
    /**
     * 过滤可点击状态
     */
    filterState(item) {
      let curDay = utils.getCurDate();
      let itemDay = new Date(item.date);
      return itemDay.getTime() > curDay.getTime();
    },
    /**
     * 签到时间查询
     */
    signinSearch(date) {
      this.$apiCore.loadZbqdOfMonth(date).then(res => {
        this.signinDateList = res.data;
        res.data.forEach(item => {
          if (this.isSingin == 1) {
            let date = utils.getDate(this.time.year, this.time.month, this.time.day);
            if (date.format('yyyyMMdd') == item) {
              this.isSingin = 2;
            }
            // this.isSingin = (date.format('yyyyMMdd') == item);
          }
        });
      });
    },
    /**
     * 签到
     */
    openSignin() {
      let userLayer = this.$dgLayer({
        title: '值班签到',
        // 组件内容
        component: require('./modules/signin/index'),
        btn: ['确定', '取消'],
        maxmin: false,
        resize: false,
        btnAlign: 'c',
        props: {},
        area: ['820px', '450px'],
        skin: '',
        yes: index => {
          userLayer.$children[0].oldSelectMap = {};
          userLayer.$children[0].$refs['ruleForm'].validate(valid => {
            if (valid) {
              let obj = {
                leader: userLayer.$children[0].formData.itemData[0],
                personList: userLayer.$children[0].formData.itemData.filter((item, index) => {
                  return index != 0;
                })
              };
              this.$apiCore.signInToday(obj).then(res => {
                let resData = JSON.parse(res.data);
                // this.isSingin = 2;
                if (resData.people) {
                  this.$message.warning(resData.people + '已经签到过了');
                }
                let date = utils.getDate(this.time.year, this.time.month, this.time.day);
                // 获取每月签到时间
                this.signinSearch(date.format('yyyyMM'));
                // this.$message.success('签到成功');
                layer.close(index);
              });
            } else {
              return false;
            }
          });
        },
        btn2() {}
        // close(){
        //     detailLayer.close();
        // }
      });
    },
    /**
     * 鼠标悬浮事件()
     */
    moushover(item) {
      this.$apiCore.loadSignDataWithDate(item.date.format('yyyyMMdd')).then(res => {
        this.hoverObj = res.data.leader;
        this.hoverList = res.data.polices;
      });
    },
    /**
     * 标记是否已经签到(暂时不用)
     */
    markDate() {
      this.$forceUpdate();
      this.calendarList.forEach((item, index) => {
        this.signinDateList.forEach(itemOne => {
          if (this.isSingin == 1) {
            let date = new Date().format('yyyyMMdd');
            if (date == itemOne) {
              this.isSingin = 2;
            }
          }
          // console.log(item.date.format('yyyyMMdd')=== itemOne)
          this.$set(this.calendarList[index], 'isSigninCheck', item.date.format('yyyyMMdd') === itemOne);
          //    item.isSigninCheck = item.date.format('yyyyMMdd')=== itemOne;
        });
      });
    }
  }, // 内部方法
  beforeCreate: function() {}, // 组件创建前
  created: function() {
    // 保存显示的日期
    // this.calendarList = this.visibleCalendar;
  }, // 组件创建完成后
  beforeMount: function() {}, // 组件挂载前
  mounted: function() {
    let date = utils.getDate(this.time.year, this.time.month, this.time.day);
    // 获取每月签到时间
    // this.signinSearch(date.format("yyyyMM"));
    // 保存显示的日期
    this.calendarList = this.visibleCalendar;

    // 获取当前年月
    this.nowTime = date.format('yyyy年MM月');
  }, // 组件挂载完成后
  beforeUpdate: function() {}, // 组件更新前
  updated: function() {}, // 组件挂载完成后
  beforeDestroy: function() {}, // 组件销毁前
  destroyed: function() {} // 组件销毁完成后
};
</script>
<style lang="scss" scoped>
.calendar {
  color: var(--calendar_calendar_color);
  // padding: 25px 0;
  // margin: 0 auto;
  // width: 400px;
  .calendar-header {
    padding: 25px 0 15px 0;
    &_ul {
      display: flex;
      justify-content: space-between;
      & > li {
        // border:1px solid red;
        // padding:50px 0;
        &.title {
          // font-family: MicrosoftYaHei;
          // font-size: 12px;
          font-weight: bold;
          font-stretch: normal;
          letter-spacing: 0px;
          // color: #333333;
        }
        & > span {
          cursor: pointer;
        }
      }
    }
  }
  .calendar-weekheader {
    padding: 13px 0;
    border-bottom: 1px solid var(--border-color-base);
    &_ul {
      justify-content: space-evenly;
      display: flex;
      & > li {
        //   border:1px solid red;
        // flex: 30% 1 1;
        text-align: center;
        // height: 40px;
        // line-height: 40px;
        width: 13%;
      }
    }
  }
  .calendar-body {
    &_ul {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-evenly;
      & > li {
        // border:1px solid red;
        // padding: 5px 0;
        text-align: center;
        // height: 40px;
        // line-height: 40px;
        width: 13%;
        margin: 2px 0;
        // display: flex;
        // align-items: center;
        // border:1px solid red;
        & > span {
          width: 35px;
          height: 35px;
          display: inline-block;
          border-radius: 17.5px;
          // border:1px solid red;
          line-height: 35px;
          // border: 1px solid red;
          &.no {
            // color: rgba(1, 1, 1, .6);
            color: var(--color-text-dark);
          }
          &.activeEv {
            // position: relative;
            background-color: var(--calendar_activeEv_background);
            // &::before{
            //     left: 5px;
            //     top: 5px;
            //     border-radius: 50%;
            //     position: absolute;
            //     width: 4px;
            //     height: 4px;
            //     content:'';
            //     display: block;
            //     background: #1890ff;
            // }
          }
          &.clickItem {
            // border: 1px solid red;

            border: solid 1px var(--calendar_clickItem_border) !important;
            background-color: var(--calendar_clickItem_background) !important;
            color: var(--calendar_clickItem_color);
            // color: rgba(0, 0, 0, 1) !important;
          }
          &.active {
            background-color: var(--calendar_active_background);
            // border-radius: 2px;
            color: var(--calendar_active_color);
          }
        }
        &:hover {
          color: var(--calendar_li_hover);
          cursor: pointer;
        }
      }
    }
  }
  .calendar-footer {
    text-align: center;
    // padding: 15px 0;
    padding: 10px 0;
    .el-button {
      width: 100px;
      height: 32px;
      // background-color: #1890ff;
      border-radius: 2px;
      color: var(--color-text-dark);
      border: 1px solid var(--border-color-base);
    }
  }
}
</style>
