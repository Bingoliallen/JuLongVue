<!--
 * @Author: Liugh
 * @Date: 2020-01-10 16:54:02
 * @LastEditTime : 2020-02-11 13:30:49
 * @LastEditors  : Do not edit
 * @Description: 
 -->
<template>
  <div>
    <el-form class="addSignin" ref="ruleForm" :model="formData" label-width="90px" :inline="true">
      <!-- <transition-group name="list" tag="div"> -->
      <div v-for="(item, index) in formData.itemData" :key="item.name + index" class="addSignin_item list-item">
        <el-form-item
          :label="index == 0 ? '值班领导' : '值班民警' + index"
          :key="item.key"
          :prop="'itemData.' + index + '.id'"
          :rules="[{ required: true, trigger: 'change', validator: validateName }]"
        >
          <dg-select v-model="item.id" :data="selectObj.personList" label-name="NAME" value-name="USER_NO"></dg-select>
        </el-form-item>
        <el-form-item
          :label="index == 0 ? '领导手机' : '民警' + index + '手机'"
          :key="item.key"
          :prop="'itemData.' + index + '.phone'"
          :rules="[{ required: false, validator: validatePhone, trigger: 'blur' }]"
        >
          <el-input v-model="item.phone"></el-input>
        </el-form-item>

        <el-form-item class="addSignin_item_button">
          <!-- <i class="icon iconl-plus"></i>
                    <i class="icon iconl-minus "></i> -->
          <el-button type="text" @click="addItem" v-show="formData.itemData.length - 1 == index"
            ><i class="icon iconl-plus"></i
          ></el-button>
          <el-button type="text" @click.prevent="removeDomain(item)" v-show="item.showFlag"
            ><i class="icon iconl-minus "></i
          ></el-button>
          <!-- <el-button @click="resetForm('dynamicValidateForm')">重置</el-button> -->
        </el-form-item>
      </div>
      <!-- </transition-group> -->
    </el-form>
  </div>
</template>

<script>
export default {
  name: 'signin', // 组件名称
  props: {
    // 接收父组件的数据
  },
  data() {
    // 组件内部参数
    return {
      formData: {
        itemData: [
          { id: '', name: '', phone: '', number: '', showFlag: false },
          { id: '', name: '', phone: '', number: '', showFlag: false }
        ]
      },
      selectObj: [],
      oldSelectMap: {},
      selectObjMap: {}
    };
  },
  computed: {}, // 计算属性
  watch: {}, // 侦听器（扩展的计算属性）
  components: {}, // 注册局部组件
  methods: {
    /**
     * 表单校验
     */
    validateName(rule, value, callback) {
      let fullField = rule.fullField;
      let index = fullField.replace(/[^0-9]/gi, '');
      if (value === '') {
        let title = index == '0' ? '请选择值班领导' : '请选择值班民警';
        callback(new Error(title));
      } else {
        let result = true;
        if (JSON.stringify(this.oldSelectMap) != '{}' && index != 0) {
          Object.keys(this.oldSelectMap).map(item => {
            let itemData = this.oldSelectMap[item];
            if (itemData.id == value && itemData.key != index) {
              result = false;
            }
          });
        }
        if (!result) {
          callback('该民警已被选中');
        } else {
          if (index != 0) {
            this.oldSelectMap[index] = {
              id: value,
              key: index
            };
          }
          this.formData.itemData[index].phone = this.selectObjMap[value].phone;
          this.formData.itemData[index].name = this.selectObjMap[value].name;
          this.formData.itemData[index].number = this.selectObjMap[value].phone;
          callback();
        }
      }
    },
    /**
     * 手机校验
     */
    validatePhone(rule, value, callback) {
      let fullField = rule.fullField;
      let index = fullField.replace(/[^0-9]/gi, '');
      if (value == '' || value == null) {
        callback();
      } else {
        let reg = /^[1][3,4,5,7,8][0-9]{9}$/;
        if (!reg.test(value)) {
          callback('请输入正确的手机号码');
        } else {
          let user_no = this.formData.itemData[index].id;
          this.selectObjMap[user_no].phone = value;
          callback();
        }
      }
    },

    /**
     * 动态添加表单
     */
    addItem() {
      // this.$set(this.formData.itemData[1],'showFlag',false)
      this.formData.itemData[1].showFlag = true;
      this.formData.itemData.push({
        id: '',
        name: '',
        phone: '',
        showFlag: true
        // key: Date.now()
      });
    },

    /**
     * 移除动态添加的表单
     * @param {Object} item 被删除的对象
     */
    removeDomain(item) {
      if (this.formData.itemData.length > 2) {
        var index = this.formData.itemData.indexOf(item);
        if (index !== -1) {
          this.formData.itemData.splice(index, 1);
        }
        if (this.formData.itemData.length == 2) {
          this.formData.itemData[1].showFlag = false;
        }
      }
    }
  }, // 内部方法
  mounted: function() {
    this.$apiCore.loadSignInitialData().then(res => {
      this.selectObj = res.data;
      res.data.personList.map(p => {
        this.selectObjMap[p.USER_NO] = {
          phone: p.MOBILE,
          name: p.NAME,
          number: p.NUMBER
        };
      });

      console.log('data', this.selectObjMap);
      this.formData.itemData[0].id = this.selectObj.personList[0].USER_NO;
      this.formData.itemData[1].id = this.selectObj.user.userId;
    });
  }
};
</script>
<style lang="scss" scoped>
.addSignin {
  .addSignin_item {
    /deep/ .el-form-item__content {
      width: 240px;
    }
    .addSignin_item_button {
      width: 50px;
      /deep/ .el-form-item__content {
        width: 100%;
      }
      .el-button.el-button--text {
        margin-left: 0px;
      }
      i {
        width: 19px;
        height: 19px;
        background-color: rgba(229, 240, 255, 1);
        border: solid 1px rgba(179, 216, 255, 1);
        border-radius: 9.5px;
      }
    }
  }
}
.list-item {
  // display: inline-block;
  // margin-right: 10px;
}
.list-enter-active,
.list-leave-active {
  transition: all 0.3s;
}
.list-enter, .list-leave-to
        /* .list-leave-active for below version 2.1.8 */ {
  opacity: 0;
  transform: translateY(30px);
}
</style>
