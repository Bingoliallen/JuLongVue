/**
 * dcuc,dids,dssoac登录
 * @Author: huangjq
 * @Date:   2019-10-16
 * @Project jz
 */
import Login from './abstract/AbsLoginApi';
import store from '@icccdPath/store';

class DCISLogin extends Login {
  constructor() {
    super();
  }

  judgeIsLogin() {}

  logout(pageObj) {
    pageObj.$store.dispatch('Logout').then(() => {
      pageObj.$router.push(`/login?redirect=${pageObj.$route.fullPath}`);
      location.reload(); // In order to re-instantiate the vue-router object to avoid bugs
    });
    console.log(234);
  }

  beforeRequest(config) {
    return config;
  }

  afterResponseSuccess(response) {
    const res = response.data;
    if (res.statusCode === '401') {
      window.location.href = res.link;
    }
    if (this.NO_LOGIN_STATUS[res.statusCode]) {
      if (res.link) {
        // alert(JSON.stringify(response, null, 2));
        if (res.loginType === 'dids') {
          let reqUrl = response.request.responseURL;
          res.link = res.link.replace(
            'forwardUrl=' + reqUrl,
            'forwardUrl=' + encodeURIComponent(encodeURIComponent(window.location.href))
          );
        } else if (res.loginType === 'dcuc') {
          res.link = res.link.replace(
            'forwardUrl=' + response.request.responseURL,
            'forwardUrl=' + encodeURIComponent(window.location.href)
          );
        }
        window.location.href = res.link;
        return Promise.reject({ link: res.link });
      } else {
        // dssoac登录方式
        store.dispatch('FedLogout').then(() => {
          if (!response.config.url.endsWith('/api/user/info')) {
            location.reload(); // 为了重新实例化vue-router对象 避免bug
          }
        });
      }
    } else {
      return response;
    }
  }

  afterResponseFailed(error) {
    console.log(22222);
    return error;
  }
}

export default DCISLogin;
