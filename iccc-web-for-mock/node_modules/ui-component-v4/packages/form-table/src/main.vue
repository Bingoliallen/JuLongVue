<script>
import _ from 'lodash';
import DgTable from 'packages/table';

export default {
    name: 'DgFormTable',

    componentName: 'DgFormTable',

    mixins: [DgTable],

    model: {
        prop: 'data'
    },

    provide() {
        return {
            overflow: this.overflow,
            formTable: this
        };
    },

    props: {
        // form表单数据的字段名称
        prop: {
            type: String,
            default() {
                let propsData = this.$options.propsData;
                return propsData['data-name'];
            },
            validator: function(val) {
                return val || this.$options.propsData['data-name'];
            }
        },

        // 新增数据的位置,是否加在首条
        first: {
            type: Boolean,
            default() {
                let propsData = this.$options.propsData;
                let first = false;
                if (propsData.hasOwnProperty('pagination') && propsData['pagination'] != 'false') {
                    first = true;
                }
                return first;
            }
        },
        // 新增数据模板
        dataTemplate: {
            type: [Object, Function],
            default() {
                return {};
            }
        },
        // 全局警用
        disabled: {
            type: Boolean,
            default: false
        },
        // 默认客户端分页（覆盖）
        pagingType: {
            type: String,
            default: 'client',
            validator: function(val) {
                return ['client', 'server'].indexOf(val) !== -1;
            }
        },
        // 默认原始的方式，换行（覆盖）
        overflow: {
            // “tooltip，wrap，origin”
            type: String,
            default: 'origin'
        },
        // 是否开启分页
        pagination: {
            type: Boolean,
            default: false
        }
    },

    created() {
        this.$on('handleAddClick', this.handleAddClick);
        this.$on('handleDeleteClick', this.handleDeleteClick);
    },

    methods: {
        /**
         * 新增行数据
         */
        handleAddClick() {
            let index = this.dataClient.length;
            let row = {};
            if (this.first) {
                index = 0;
            }
            if (_.isFunction(this.dataTemplate)) {
                row = _.clone(this.dataTemplate(this.dataClient));
            } else {
                row = _.clone(this.dataTemplate);
            }
            this.dataClient.splice(index, 0, row);
            this.$emit('add', [row, index]);
            this.$emit('input', this.dataClient);
        },
        /**
         * 删除行数据
         * @param index
         */
        handleDeleteClick(index) {
            let row = this.dataClient[index];
            this.dataClient.splice(index, 1);
            this.$emit('del', [row, index]);
            this.$emit('input', this.dataClient);
        }
    }
};
</script>
