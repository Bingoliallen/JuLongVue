<!--
    表单列：
    1、继承表格列
    2、新增和删除，双向绑定
    3、表单验证
    @Author: luoc
    @Date: 2019-03-07

    @Update: yangjy
    @Date: 2019-06-13
-->
<template>
  <!-- 1、type为'selection','index','expand' -->
  <el-table-column
    v-bind="attrs"
    v-if="isOriginalType"
  >
    <!-- 头部作用域插槽 -->
    <template
      v-slot:header="scope"
      v-if="isHeaderSlot"
    >
      <slot
        name="header"
        v-bind="scope"
      >{{ scope.column.label }}</slot>
    </template>

    <!-- expand为作用域插槽 -->
    <template
      v-slot="scope"
      v-if="'expand' == attrs.type"
    >
      <slot v-bind="scope"></slot>
    </template>
  </el-table-column>

  <!--2、type为操作列 -->
  <el-table-column
    v-else-if="cmpType === 'opt'"
    v-bind="attrs"
    width="80px"
    align="center"
  >
    <template
      slot="header"
      slot-scope="scope"
    >
      <i
        class="el-icon-circle-plus dg-form-column__button"
        :style="formTable.disabled ? { cursor: 'not-allowed' } : {}"
        @click="addItem(scope)"
      ></i>
    </template>
    <template slot-scope="scope">
      <i
        class="el-icon-delete dg-form-column__button"
        :style="formTable.disabled ? { cursor: 'not-allowed' } : {}"
        @click="deleteItem(scope)"
      ></i>
    </template>
  </el-table-column>

  <!--2、type为其他模板组件列 -->
  <el-table-column
    v-bind="attrs"
    v-else
  >
    <!-- 头部作用域插槽 -->
    <template
      v-slot:header="scope"
      v-if="isHeaderSlot"
    >
      <slot
        name="header"
        v-bind="scope"
      >{{ scope.column.label }}</slot>
    </template>
    <!-- 组件作用域插槽 -->
    <template v-slot="scope">
      <dg-form-item
        v-bind="formItemProps"
        :prop="getFormItemProp(scope)"
        :class="['dg-form-column__form-item--wrap']"
        :rules="formItemRules"
      >
        <component
          :is="cmpType"
          v-bind="getCmpProps(scope)"
          v-on="getCmpEvents(scope)"
          v-model="scope.row[scope.column.property]"
          :disabled="formTable.disabled"
        >
          <template v-for="(val, key) in $scopedSlots">
            <slot
              :name="key"
              v-bind="scope"
              v-if="key != 'header'"
            ></slot>
          </template>
        </component>
      </dg-form-item>
    </template>
  </el-table-column>
</template>

<script>
import TableColumn from 'packages/table-column';
import DgFormItem from 'packages/form-item/src/main.vue';
import Emitter from 'main/mixins/emitter';
import { getCmpProps } from 'main/dg-utils/shear.js';

export default {
    name: 'DgFormColumn',

    mixins: [Emitter, TableColumn],

    inject: ['formTable'],

    components: { DgFormItem },

    props: {
        // options 默认操作列表
        del: Function,
        add: Function,
        prop: String
    },

    computed: {
        // 表单项的props参数
        formItemProps() {
            let props = getCmpProps(DgFormItem, this, {
                labelWidth: '0',
                label: undefined,
                tlabel: props => props['label']
            });
            return props;
        },
        // 获取最近的表单
        form() {
            let parent = this.$parent;
            let parentName = parent.$options.componentName;
            while (parentName !== 'ElForm') {
                if (parentName === 'ElFormItem') {
                    this.isNested = true;
                }
                parent = parent.$parent;
                parentName = parent.$options.componentName;
            }
            return parent;
        },
        // 合并获取校验规则，从form获取对应的字段的规则，和列设置的规则，优先列设置的规则
        formItemRules() {
            const prop = this.formTable.prop;
            return this.rules || (prop && this.form.rules && this.form.rules[prop][this.prop]) || {};
        }
    },

    methods: {
        /**
         * 获取formItem的prop属性，获取table的prop，拼成'formData.0.age'或者‘0.age'的字符串
         * @param scope
         * @returns {string}
         */
        getFormItemProp(scope) {
            return this.formTable.prop
                ? `${this.formTable.prop}.${scope.$index}.${scope.column.property}`
                : `${scope.$index}.${scope.column.property}`;
        },
        addItem(scope) {
            if (this.formTable.disabled) {
                return;
            }
            if (this.add) {
                this.add(scope.row, scope.$index);
            } else {
                this.dispatch('DgFormTable', 'handleAddClick', scope.$index);
            }
        },
        deleteItem(scope) {
            if (this.formTable.disabled) {
                return;
            }

            if (this.del) {
                this.del(scope.row, scope.$index);
            } else {
                this.dispatch('DgFormTable', 'handleDeleteClick', scope.$index);
            }
        }
    }
};
</script>
