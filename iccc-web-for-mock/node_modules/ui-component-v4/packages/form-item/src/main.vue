<script>
import AsyncValidator from 'async-validator';
import { FormItem } from 'element-ui';
import { noop, getPropByPath } from 'main/utils/util';
import mgs from './message-CN.js'; // async-validator 的一个中文翻译文件
import { ruleChange } from 'main/dg-utils/rules-convert.js';

export default {
    name: 'DgFormItem',

    mixins: [FormItem],

    props: {
        rules: [Object, Array, String],
        // label 如果为空的时候使用
        tlabel: String
    },

    methods: {
        // update author:lutz
        validate(trigger, callback = noop) {
            this.validateDisabled = false;
            const rules = this.getFilteredRule(trigger);
            if ((!rules || rules.length === 0) && this.required === undefined) {
                callback();
                return true;
            }
            this.validateState = 'validating';
            const descriptor = {};

            // update-start author:lutz
            // 过滤空值 [{}] || [0] || [''] || [null] || [void 0] || [NaN] 这种情况
            // const filer = _.isArray(rules) ? rules.filter(item => item && Object.keys(item).length) : [];
            if (rules && rules.length /* && filer.length */) {
                rules.forEach((rule, i) => {
                    if (!rule.message) {
                        /**
                         * BUG修复
                         * 描述:
                         *      const rules = [{ required: true }, { type: 'number', message: '年龄必须为数字值'}]
                         * 在下列条件同时满足时会触发：
                         *      1. rules[0].message === void 0
                         *      2. rules[0].required === true
                         *
                         * 原因：
                         *      async-validator 默认 type: 'string'
                         */
                        if (Object.keys(rule).length === 1 && rule.required) {
                            rule.message = `${this.label || this.tlable || ''}是必须字段`;
                        } else {
                            rule.fullField = this.label || this.tlable || ''; // 请慎用fullField, 特别是在rules是array的时候
                        }
                    }
                    delete rule.trigger;
                    // form-table 中获取 index, parseInt(fullField.split('.')[1]);
                });
            }
            /* [code]
                if (rules && rules.length > 0) {
                    rules.forEach(rule => {
                        delete rule.trigger;
                    });
                }
            */
            // update-end

            descriptor[this.prop] = rules;
            const validator = new AsyncValidator(descriptor);

            // create author:lutz
            validator.messages(mgs); // 使用中文版本

            const model = {};
            model[this.prop] = this.fieldValue;
            validator.validate(model, { firstFields: true }, (errors, invalidFields) => {
                this.validateState = !errors ? 'success' : 'error';
                this.validateMessage = errors ? this.changeMsg(errors[0].message) : '';
                callback(this.validateMessage, invalidFields);
                this.elForm && this.elForm.$emit('validate', this.prop, !errors, this.validateMessage || null);
            });
        },

        // creat author:lutz 修改 message; async-validator 会自带(string)、(function)这样的类型
        changeMsg(msg = '') {
            const reg = /\([a-z]+\)/;
            return msg.replace(reg, '');
        },

        // update author:lutz
        getRules() {
            // update-start author:lutz
            let formRules = ruleChange(this.form.rules, 'form');
            const selfRules = ruleChange(this.rules, 'formItem');
            /* [code]
                let formRules = this.form.rules;
                const selfRules = this.rules;
            */
            // update-end

            const requiredRule = this.required !== undefined ? { required: !!this.required } : [];
            const prop = getPropByPath(formRules, this.prop || '');
            formRules = formRules ? prop.o[this.prop || ''] || prop.v : [];
            return [].concat(selfRules || formRules || []).concat(requiredRule);
        }
    }
};
</script>
