<template>
  <div class="dg-table-select">
    <l-select
      :scrollbar-class="scrollbarCls"
      v-model="model"
      v-bind="selectProp"
      v-on="selectOn"
      v-loadmore="loadMore"
    >
      <l-table
        class="dg-table-select__table"
        :border="border"
        :pagination="false"
        :data="itemsWithDisabled"
        :prop="defaultProp"
        v-bind="tableBind"
      >
        <slot></slot>
      </l-table>
    </l-select>
  </div>
</template>

<script>
import DgTableBody from './table-body';
import DgTable from 'packages/table';
import LSelect from 'packages/base/select.vue';
import objectAssign from 'main/utils/merge';
import ItemsWithDisabled from 'main/dg-mixins/itemsWithDisabled.js';
import { complex, complexObj, getCmpProps } from 'main/dg-utils/shear.js';
import loadmore from './loadmore.js';

// 替换组件 DgTable > ELTable > TableBody // complex 深拷贝
const LTable = complex(DgTable);
LTable.components.ElTable.components.TableBody = DgTableBody;

export default {
    name: 'DgTableSelect',

    mixins: [ItemsWithDisabled],

    directives: {
        loadmore
    },

    components: {
        LSelect,
        LTable
    },

    props: {
        // 表格属性
        tableProps: {
            type: Object,
            default() {
                return {};
            }
        },
        scrollbarClass: String,
        pagination: Boolean,
        border: Boolean,
        multiple: Boolean,
        value: {
            required: true
        }
    },

    computed: {
        model: {
            set(val) {
                this.$emit('input', val);
            },
            get() {
                return this.value;
            }
        },

        // 下拉框是脱离DOM包含关系，用class来渲染样式
        scrollbarCls() {
            return 'dg-table-select__scrollbar' + (this.multiple ? ' multiple' : '') + ' ' + this.scrollbarClass;
        },

        // l-select props
        selectProp() {
            return getCmpProps(LSelect, this);
        },

        selectOn() {
            return complexObj(this.$listeners, ['scroll-bottom']);
        },

        // dg-table props
        tableBind() {
            return objectAssign(
                {
                    overflow: 'wrap'
                },
                this.tableProps
            );
        }
    },

    methods: {
        loadMore() {
            if (this.pagination) {
                this.$emit('scroll-bottom');
            }
        }
    }
};
</script>
