<template>
    <div class="dg-checkbox-group">
        <div v-if="showQuick" :class="{
                'dg-checkbox-group__row': row,
                'dg-checkbox-group__margin': row,
                'dg-checkbox-group__quick': !row
            }">
            <el-checkbox v-if="checkAll" v-model="isCheckedAll" :size="size" :indeterminate="isIndeterminate"
                :disabled="checkAllDisabled || disabled">
                {{ checkAllText }}
            </el-checkbox>

            <el-checkbox v-if="inverse" v-model="isInverse" :disabled="disabled" :size="size">反选</el-checkbox>
        </div>
        <el-checkbox-group v-bind="$attrs" v-model="valueArray" :disabled="disabled" :size="size" :class="{
                'dg-checkbox-group__row': row && !vertical
            }">
            <component :is="com" v-for="(item, key) in itemsWithDisabled" :key="key" :class="{
                    'dg-checkbox-group__vertical': vertical,
                    'dg-checkbox-group__quick': vertical,
                    'is-lace': isLace && !disabled
                }" :label="item[defaultProp.value]" :disabled="item[defaultProp.disabled]"
                :border="border && type != 'button' && !vertical">{{ item[defaultProp.label] }}</component>
        </el-checkbox-group>
    </div>
</template>

<script>
    import _ from 'lodash';
    import {
        Checkbox as ElCheckbox,
        CheckboxButton as ElCheckboxButton,
        CheckboxGroup as ElCheckboxGroup
    } from 'element-ui';
    import {
        str2arr,
        data2type,
        uniqArr
    } from 'main/dg-utils/data-convert.js';
    import itemsWithDisabled from 'main/dg-mixins/itemsWithDisabled.js';

    export default {
        name: 'DgCheckboxGroup',

        mixins: [itemsWithDisabled],

        components: {
            ElCheckboxGroup,
            ElCheckboxButton,
            ElCheckbox
        },

        props: {
            disabled: Boolean,
            value: {
                required: true
            },
            // 全选
            checkAll: Boolean,
            // 全选文字
            checkAllText: {
                type: String,
                default: '全选'
            },
            // 全选禁用
            checkAllDisabled: {
                type: Boolean,
                default: false
            },
            // 反选
            inverse: Boolean,
            // 渲染组件类型
            type: {
                type: String,
                default: ''
            },
            /* 以下属性仅在 type !== button 时生效 */
            // 全选、反选 是否同行显示
            row: Boolean,
            // 带有边框
            border: Boolean,
            // 垂直排列
            vertical: Boolean,
            // 尺寸大小
            size: {
                type: String,
                default: ''
            },
            // 是否花边展示
            isLace: {
                type: Boolean,
                default: false
            }
        },

        data: () => ({
            valueArray: []
        }),

        watch: {
            value: {
                immediate: true,
                deep: true,
                handler(val) {
                    const {
                        value,
                        seq,
                        dataSource,
                        defaultProp
                    } = this;
                    this.valueArray = str2arr(value, seq, true, dataSource, defaultProp.value);
                }
            },
            valueArray(newVal, oldVal) {
                if (newVal.length !== oldVal.length || newVal.toString() !== oldVal.toString()) {
                    this.returnsVal(newVal);
                }
            },
            dataSource(newDataSource, oldDataSource) {
                const {
                    value,
                    seq,
                    dataSource,
                    defaultProp
                } = this;
                if (this.valueArray.length > 0) {
                    this.valueArray = str2arr(value, seq, true, newDataSource, defaultProp.value, true);
                }
            }
        },

        computed: {
            // 是否显示全选或反选
            showQuick() {
                return this.checkAll || this.inverse;
            },

            // 需要渲染组件 PS:PC端没问题,在移动端或微信渲染这种写法有问题
            com() {
                return this.type == 'button' ? ElCheckboxButton : ElCheckbox;
            },

            // 对数据进行处理
            valueArr: {
                get() {
                    const {
                        value,
                        seq,
                        dataSource,
                        defaultProp
                    } = this;
                    return str2arr(value, seq, true, dataSource, defaultProp.value);
                },
                set(val) {
                    this.returnsVal(val);
                }
            },

            // 反选的监听事件
            isInverse: {
                get() {
                    return false;
                },
                set(val) {
                    const {
                        valueArr,
                        filterVal
                    } = this;
                    const selectArr = _.difference(filterVal(), valueArr);
                    this.valueArray = selectArr;
                }
            },

            // 监听全选状态 全选的勾选状态
            isCheckedAll: {
                get() {
                    const {
                        valueArr,
                        filterVal
                    } = this;
                    return valueArr.length && valueArr.length === filterVal().length;
                },
                set(val) {
                    const {
                        filterVal,
                        lockDisabledVal
                    } = this;
                    const data = val ? uniqArr(lockDisabledVal(), filterVal()) : lockDisabledVal();
                    this.valueArray = data;
                }
            },

            // 全选的状态 @return {boolean} element-ui>el-checkbox 的 indeterminate状态
            isIndeterminate() {
                const {
                    valueArr,
                    filterVal
                } = this;
                return valueArr.length > 0 && valueArr.length < filterVal().length;
            }
        },

        methods: {
            // 过滤禁选选项后的值 @return {array<string|number>}
            filterVal() {
                const {
                    itemsWithDisabled
                } = this;
                const {
                    value,
                    disabled
                } = this.defaultProp;
                return itemsWithDisabled.filter(item => !item[disabled]).map(item => item[value]);
            },

            // 选中且禁用属性的值 @return {array<string|number>}
            lockDisabledVal() {
                const {
                    valueArr,
                    itemsWithDisabled
                } = this;
                const {
                    value,
                    disabled
                } = this.defaultProp;
                const data = [];
                itemsWithDisabled.forEach(item => {
                    if (item[disabled] && valueArr.indexOf(item[value]) !== -1) {
                        data.push(item[value]);
                    }
                });
                return data;
            },

            // input、change事件触发
            returnsVal(val) {
                const {
                    outputFormat,
                    seq
                } = this;
                const data = data2type(val, outputFormat, seq);
                this.$emit('input', data);
                this.$emit('change', data);
            }
        }
    };
</script>