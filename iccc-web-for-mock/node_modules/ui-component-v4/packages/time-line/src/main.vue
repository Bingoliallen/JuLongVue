<template>
  <div class="dg-time-line">
    <div
      :class="{
        'dg-time-line__inner': true,
        'is-pagination': $slots.pagination || pagination,
        'dg-time-line__both': isBoth,
        'dg-time-line__label': showLabel
      }"
    >
      <!--主体-->
      <dg-scrollbar wrap-class="dg-time-line__scrollbar" @scroll-bottom="scrollBottom">
        <ul :class="[ 'dg-time-line__content', isIconFlag ? 'dg-time-line__content-icon' : '' ]">
          <li
            v-for="(item, index) in renderData"
            :key="index"
            :class="isIconClass(item)"
            :style="{ height: (item.height ? item.height : interval || -1) + 'px' }"
          >
            <div v-if="showLabel" class="dg-time-line--label">{{ item[timeName] }}</div>

            <span class="dg-time-line__line"
              v-if="index + 1 !== renderData.length"
              :class="[ lineBackground ? '' : 'line-background-color' ]"
              :style="{
                height: (item.height ? item.height : interval ? interval : '') + 'px',
                backgroundColor: lineBackground || 'none'
              }"
            ></span>

            <!-- 时间节点 -->
            <span
                class="dg-time-line__dot"
                :style="{
                  borderColor: (item[iconColorName] ? item[iconColorName] : roundBackground),
                  color: (item[iconColorName] ? item[iconColorName] : roundBackground),
                  marginLeft: item.noBorder ? '-1px' : '0',
                  borderWidth: item.noBorder ? '0' : '2px'
                }"
            >
              <i :class="item[iconName]"></i>
            </span>

            <!-- 消息内容 -->
            <div class="dg-time-line__document">
              <template v-if="!userDefined">
                <div class="dg-time-line__box" v-if="textType !== 'box'">
                  <span class="dg-time-line__box-base dg-time-line__box-title">
                    {{ item[labelName] }}
                  </span>
                  <span class="dg-time-line__box-base dg-time-line__box-time">
                    {{ item[valueName] }}
                  </span>
                </div>
                <div v-else class="dg-time-line__message">
                  <span class="dg-time-line__message-title">{{ item[labelName] }}</span>
                  <div class="dg-time-line__message-info">
                    <span>{{ item[valueName] }}</span>
                    <span>{{ item[detailName] }}</span>
                  </div>
                </div>
              </template>

              <!--自定义模板-->
              <template v-else>
                <slot :data="item"></slot>
              </template>
            </div>
          </li>
        </ul>
      </dg-scrollbar>
    </div>

    <!--分页-->
    <div class="dg-time-line__pagination" v-if="$slots.pagination || pagination">
      <template v-if="pagination">
        <el-pagination
          class="dg-table__pagination"
          v-bind="paginationOptions"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          @prev-click="handlePrevClick"
          @next-click="handleNextClick"
        ></el-pagination>
      </template>
      <template v-else>
        <slot name="pagination"></slot>
      </template>
    </div>
  </div>
</template>

<script>
import objectAssign from "main/utils/merge";

export default {
    name: "DgTimeLine",

    props: {
        // 目标数据
        data: {
            type: Array,
            default: []
        },
        showLabel: {
          type: Boolean,
          default: false
        },
        timeName: {
          type: String,
          default: 'time'
        },
        // 时间的字段名称
        valueName: {
            type: String,
            default: 'value'
        },
        // 标题的字段名称
        labelName: {
            type: String,
            default: 'label'
        },
        // 详情的字段名称
        detailName: {
            type: String,
            default: 'detail'
        },
        // 图标的字段名称
        iconName: {
            type: String,
            default: 'icon'
        },
        // 图标的颜色名称
        iconColorName: {
            type: String,
            default: 'iconColor'
        },
        // 圆节点背景
        roundBackground: {
            type: String,
            default: ""
        },
        // 线条背景
        lineBackground: {
            type: String,
            default: ""
        },
        // 间距
        interval: {
            type: Number,
            default: 0
        },
        // 文本类型
        textType: {
          type: String,
          default: "",
          validator: function(val) {
            return ["box", ""].indexOf(val) !== -1;
            }
          },
        // 用户自定义文本
        userDefined: {
            type: Boolean,
            default: false
        },
        // 是否开启模板分页
        pagination: {
            type: Boolean,
            default: false
        },
        // 分页配置参数
        paginationProps: {
            type: Object,
            default: () => {}
        },
        // 分页类型 client | server
        pagingType: {
            type: String,
            default: "server",
            validator: function(val) {
                return ["client", "server"].indexOf(val) !== -1;
            }
        },
        // 是否两侧摆放
        isBoth: {
          type: Boolean,
          default: false
        }
    },
    data() {
        return {
            // 数据源
            dataSource: this.data,
            dataClient: this.data,
            // 分页参数配置
            paginationOptions: objectAssign({ pageSize: 10, currentPage: 1 }, this.paginationProps),
            // 是否有自定义标签
            isIconFlag: false
        };
    },
    computed: {
        renderData() {
            if (this.pagination == true && this.pagingType === "client") {
                const { pageSize, currentPage } = this.paginationOptions;
                const start = (currentPage - 1) * pageSize;
                this.dataSource = this.dataClient.slice(start, start + pageSize);
            }
            return this.dataSource;
        },
        // 自定义图标样式
        isIconClass() {
          return function(item) {
            if (item.icon) {
              this.isIconFlag = true;
              let carr = [ 'dg-time-line__item', 'dg-time-line__item-icon'];
              if (item.noBorder) {
                carr.push('dg-time-line__no-border');
              }
              return carr.join(' ');
            }
            return 'dg-time-line__item';
          };
        }
    },
    watch: {
        /**
         * 监听数据源改变
         *
         */
        data: {
            immediate: true,
            handler(data) {
                if (this.pagingType == "client") {
                    this.dataClient = data;
                    this.paginationOptions.total = data.length;
                } else {
                    this.dataSource = data;
                }
            }
        }
    },
    methods: {
        /**
         * 分页切换
         *
         * @param val 当前页码
         */
        currentPage(val) {
            this.$emit("current-page", val);
        },
        /**
         * 监听滚动条到底部
         *
         */
        scrollBottom() {
            this.$emit("loading-data");
        },
        /**
         * 页数值改变方法
         *
         * @param evt
         */
        handleSizeChange(val) {
            this.paginationOptions.pageSize = val;
            this.$emit("change-size", val);
        },
        /**
         * 当前页改变方法
         *
         * @param evt
         */
        handleCurrentChange(val) {
            this.paginationOptions.currentPage = val;
            this.$emit("change-current", val);
        },
        /**
         * 点击上一页
         *
         * @param evt
         */
        handlePrevClick(val) {
            this.$emit("click-prev", val);
        },
        /**
         * 点击下一页
         *
         * @param evt
         */
        handleNextClick(val) {
            this.$emit("click-next", val);
        }
    },
    created() {
        // 分页配置
        if (!this.pagination) {
            return;
        }
    }
};
</script>
