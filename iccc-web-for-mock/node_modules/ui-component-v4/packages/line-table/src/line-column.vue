<!--
    表单列：
    1、继承表格列
    2、基础dg-form-item
    3、支持组件、修改组件、模板
    @Author: luoc
    @Date: 2019-03-07

    @Update: yangjy
    @Date: 2019-06-13
-->
<template>
    <!-- 1、type为'selection','index','expand' -->
    <el-table-column v-bind="attrs" v-if="isOriginalType">
        <!-- 头部作用域插槽 -->
        <template v-slot:header="scope" v-if="isHeaderSlot">
            <slot name="header" v-bind="scope">{{ scope.column.label }}</slot>
        </template>

        <!-- expand为作用域插槽 -->
        <template v-slot="scope" v-if="'expand' == attrs.type">
            <slot v-bind="scope"></slot>
        </template>
    </el-table-column>

    <!--2、type为其他模板组件列 -->
    <el-table-column v-bind="attrs" v-else>
        <!-- 头部作用域插槽 -->
        <template v-slot:header="scope" v-if="isHeaderSlot">
            <slot name="header" v-bind="scope">{{ scope.column.label }}</slot>
        </template>
        <!-- 组件作插槽 -->
        <template v-if="$slots.default">
            <slot></slot>
        </template>
        <!-- 组件作作用域插槽 -->
        <template v-slot="scope" v-if="!$slots.default">
            <!-- 未编辑状态，组件展示 -->
            <component
                v-if="!isEdit(scope)"
                :is="cmpType"
                v-bind="getCmpProps(scope)"
                v-on="getCmpEvents(scope)"
                :value="formatValue(scope)"
                :table-column-overflow="overflow"
                @input="val => handleCmpInput(val, scope)"
                :disabled="formTable.disabled"
            >
                <template v-for="(val, key) in $scopedSlots">
                    <slot :name="key" v-bind="scope" v-if="key != 'header' && key != 'edit'"></slot>
                </template>
            </component>

            <!-- 编辑状态，组件展示 -->
            <dg-form-item
                v-else
                v-bind="formItemProps"
                :prop="getFormItemProp(scope)"
                :class="['dg-form-column__form-item--wrap']"
                :rules="formItemRules"
            >
                <slot name="edit" v-bind="scope"></slot>
                <component
                    :is="editType"
                    v-bind="getCmpProps(scope, /^edit-props-/)"
                    v-on="getCmpEvents(scope, /^edit-events-/)"
                    :value="getValue(scope)"
                    @input="val => handleCmpInput(val, scope)"
                    :data="codeData"
                    :disabled="formTable.disabled"
                >
                    <template v-for="(val, key) in $scopedSlots">
                        <slot :name="key" v-bind="scope" v-if="key != 'header' && key != 'edit'"></slot>
                    </template>
                </component>
            </dg-form-item>
        </template>
    </el-table-column>
</template>

<script>
import _ from 'lodash';
import TableColumn from 'packages/table-column';
import DgFormItem from 'packages/form-item';
import Emitter from 'main/mixins/emitter';
import { getCmpProps, getCmpType } from 'main/dg-utils/shear.js';
export default {
    name: 'DgLineColumn',

    mixins: [Emitter, TableColumn],

    inject: ['formTable', 'elForm'],

    components: { DgFormItem },

    props: {
        // options 默认操作列表
        prop: String
    },

    computed: {
        // 默认数据来源为表码翻译数据
        codeData() {
            let data = [];
            _.forOwn(this.codeObj, (val, key) => {
                data.push({ label: val, value: key });
            });
            return data;
        },
        // 编辑类型
        editType() {
            let editType = getCmpType(this.$attrs['edit-type']);
            let type = getCmpType(this.$attrs['type']);
            // 修改组件类型不存在，且修改插槽不存在，则用type，type不存在就默认
            if (!editType && !this.$scopedSlots['edit']) {
                editType = type || 'default-tpl';
            }
            return editType;
        },
        // 表单项的props参数
        formItemProps() {
            let props = getCmpProps(DgFormItem, this, {
                labelWidth: '0',
                prop: undefined,
                label: undefined,
                tlabel: props => props['label']
            });
            return props;
        },
        // 合并获取校验规则，从form获取对应的字段的规则，和列设置的规则，优先列设置的规则
        formItemRules() {
            let rules = this.rules || (this.elForm.rules && this.elForm.rules[this.prop]) || {};
            return rules;
        }
    },

    methods: {
        /**
         * 获取formItem的prop属性，获取table的prop，拼成'formData.0.age'或者‘0.age'的字符串
         * @param scope
         * @returns {string}
         */
        getFormItemProp(scope) {
            let prop = this.elForm.$attrs['prop'];
            return `${prop}.${scope.$index}.${scope.column.property}`;
        },
        /**
         * 是否编辑，（1）行模式：修改行等于当前行 （2）列模式：修改列id等于当前列
         * @param row
         * @param column
         * @returns {boolean}
         */
        isEdit({ row, column }) {
            let isRow = this.formTable.editRow === row;
            let isCell = column.id === this.formTable.editColumn.id;
            let isCellMode = this.formTable.mode == 'cell';
            return isCellMode ? isRow && isCell : isRow;
        }
    }
};
</script>
