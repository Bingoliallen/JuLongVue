<template>
  <div class="dg-table">
    <!-- 表格区域 -->
    <div class="dg-table__content">
      <el-form
        ref="form"
        prop="form"
        :model="{ form: renderData }"
        :rules="formRules"
        label-position="right"
      >
        <el-table
          v-clickoutside="handleOutsideClick"
          @header-click="handleHeaderClick"
          v-loading="loadding"
          :data="renderData"
          :row-key="rowKey"
          ref="grid"
          :border="border"
          @selection-change="handleSelectItem"
          @sort-change="handleSortChange"
          v-bind="attrs"
          v-on="$listeners"
        >
          <slot></slot>
          <slot name="append"></slot>
        </el-table>
      </el-form>
    </div>

    <!-- 分页区域 -->
    <template v-if="pagination">
      <el-pagination
        class="dg-table__pagination"
        v-bind="paginationOptions"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        @prev-click="handlePrevClick"
        @next-click="handleNextClick"
      ></el-pagination>
    </template>
    <template v-else>
      <slot name="pagination"></slot>
    </template>
  </div>
</template>
<script>
import _ from 'lodash';
import AsyncValidator from 'async-validator';
import runQueue from './async-queue';
import DgTable from 'packages/table';
import clickoutside from 'main/dg-directives/clickoutside';
import Emitter from 'main/mixins/emitter';
import { ruleChange } from 'main/dg-utils/rules-convert';

export default {
    name: 'DgLineTable',

    componentName: 'DgLineTable',

    mixins: [Emitter, DgTable],

    model: {
        prop: 'data'
    },

    directives: {
        clickoutside
    },

    provide() {
        return {
            overflow: this.overflow,
            formTable: this
        };
    },

    props: {
        // form表单数据的字段名称
        prop: {
            type: String,
            default: 'form'
        },
        // 模式，行，列,row,cell
        mode: {
            type: String,
            default: 'row'
        },
        // 验证规则
        rules: Object,
        // 文本超出，模式
        overflow: {
            type: String,
            default: 'wrap'
        },
        // 全局禁用用
        disabled: {
            type: Boolean,
            default: false
        }
    },

    data() {
        return {
            editRow: {}, // 编辑行
            editColumn: {}, // 编辑列
            oldRowMap: {},
            oldColumnMap: {}
        };
    },

    computed: {
        parentForm() {
            let parent = this.$parent;
            let parentName = parent.$options.componentName;
            while (parentName !== 'ElForm') {
                parent = parent.$parent;
                parentName = parent.$options.componentName;
            }
            return parent;
        },
        formRules() {
            const prop = this.prop;
            let rules = this.rules || (prop && this.parentForm.rules && this.parentForm.rules[prop]) || {};
            return ruleChange(rules, 'form');
        }
    },

    methods: {
        /**
         * 插入行
         * @param index
         * @param row
         */
        insertAt(index, row = {}) {
            // 初始化行数据
            this.$refs.grid.columns.forEach(item => {
                if (item.property) {
                    row[item.property] = row[item.property];
                }
            });
            // -1，追加最后，>=0 指定位置
            if (index < 0) {
                this.dataClient.push(row);
            } else {
                this.dataClient.splice(index, 0, row);
            }
            return row;
        },
        /**
         * 是否焦点编辑行或列
         * @param row
         * @param column
         * @returns {boolean}
         */
        isActive(row, column = this.editColumn) {
            if (_.isEmpty(row)) {
                return !_.isEmpty(this.editRow);
            }
            return !_.isEmpty(this.editRow) && row === this.editRow && column === this.editColumn;
        },
        /**
         * 设置焦点编辑行列
         * @param row
         * @param column
         */
        setActive(row = {}, column = {}) {
            // 不在本页，先切换页
            if (this.pagingType == 'client') {
                let { currentPage, pageSize } = this.paginationOptions;
                let index = _.findIndex(this.dataClient, row);
                let pageNumber = Math.floor(index / pageSize) + 1;
                if (pageNumber != currentPage) {
                    this.paginationOptions.currentPage = pageNumber;
                }
            }

            this.editRow = row;
            this.editColumn = column;
            this.oldRowMap[row] = _.clone(row);
            this.oldColumnMap[column] = column;
        },
        /**
         * 清除焦点编辑行列
         * @param row
         * @param column
         */
        clearActive() {
            this.editRow = {};
            this.editColumn = {};
        },

        _validateActive(cb) {
            this.validator.validate(this.editRow, (errors, fields) => {
                if (!errors) {
                    cb(true, errors);
                    return;
                }
                this.$refs['form'].validate((valid, error) => {
                    if (valid) {
                        this.setActive();
                        this.$emit('clear-active', this.editRow, this.editColumn);
                    }
                    cb(valid, errors);
                });
            });
        },
        /**
         * 还原焦点编辑行或列数据
         */
        resetActive() {
            this.reset(this.editRow, this.mode == 'cell' ? this.editColumn : {});
            this.setActive(this.editRow, this.editColumn);
        },
        /**
         * 还原行或列数据
         */
        reset(row, column) {
            if (column && column.property) {
                row[column.property] = this.oldRowMap[row][column.property];
            } else {
                _.assign(row, this.oldRowMap[row]);
            }
        },

        handleHeaderClick(column, e) {
            this.$emit('outside-click', undefined, column, e);
        },

        handleOutsideClick(e) {
            this.$emit('outside-click', undefined, undefined, e);
        },
        /**
         * 验证api，供外部调用和表单调用
         * @param str 为字符串时，为表单调用
         * @param cb
         */
        validate(str, cb) {
            if (_.isFunction(str)) {
                this._validateActive(str);
                return;
            }

            let { currentPage, pageSize } = this.paginationOptions;
            let recordNumberStart = (currentPage - 1) * pageSize;
            let recordNumberEnd = currentPage * pageSize;
            let validateData = [];
            this.renderData.forEach(row => {
                validateData.push({
                    pageNumber: currentPage,
                    row: row,
                    isActivePage: true
                });
            });

            if (this.pagingType == 'client') {
                for (let i = 0; i < this.dataClient.length; i++) {
                    if (i >= recordNumberStart && i < recordNumberEnd) {
                        continue;
                    }
                    validateData.push({
                        pageNumber: Math.floor(i / pageSize) + 1,
                        row: this.dataClient[i]
                    });
                }
            }

            runQueue(
                validateData,
                ({ pageNumber, row, isActivePage }, next) => {
                    this.validator.validate(row, (errors, fields) => {
                        if (!errors) {
                            next();
                            return;
                        }

                        if (!isActivePage) {
                            this.paginationOptions.currentPage = pageNumber;
                        }
                        this.setActive(row);
                        this.$nextTick(() => {
                            this.$refs['form'].validate();
                        });
                        cb(errors);
                    });
                },
                () => cb('')
            );
        },

        validateChangeActive(row, column, cb) {
            if (_.isFunction(column)) {
                cb = column;
                column = undefined;
            }

            // 本列已经是编辑行，点击不做任何事
            let isActiveColumn = this.isActive(row, column);
            if (isActiveColumn) {
                return;
            }

            // 没有编辑状态，切换行
            let isActive = this.isActive();
            if (!isActive) {
                return this.setActive(row, column);
            }

            // 本列已经不是编辑行，验证保存切换行
            this.validate((valid, error) => {
                if (valid) {
                    cb(true, error);
                    this.setActive(row, column);
                } else {
                    cb(false, error);
                }
            });
        },
        validateClearActive(cb) {
            // 存在编辑状态，则验证，通过后保存数据
            let isActive = this.isActive();
            if (!isActive) {
                return;
            }
            this.validate((valid, error) => {
                if (valid) {
                    // 保存数据
                    cb(true, error);
                    this.clearActive();
                } else {
                    cb(false, error);
                }
            });
        }
    },

    created() {
        this.validator = new AsyncValidator(this.formRules);
        this.dispatch('ElForm', 'el.form.addField', [this]);
    }
};
</script>
