<!--
    author: lutz
    1. 封装快捷模版
        a) 图片(list-type default: [text、picture、picture-card])
            头像框  list-type === 'avatar'
            头像多图片 list-type === 'pictureList'
            预览 list-type === 'viewer'
        b) 文件 list-type === 'button'
        c) 自定义上传 list-type
    2. list-type === 'button'
        a) tip 自动添加提示
        b) 点击文件下载
    3. 限制文件大小 size, 支持数字(默认单位：B)和字符串(比如：0.5M)
    4. 需要 fileList 插槽修改文件列表
-->

<template>
    <div class="dg-upload">
        <template v-if="listType === 'button'">
            <upload
                :class="{ 'dg-upload--button': !disabled }"
                v-bind="_attrs"
                v-on="$listeners"
                :list-slot="$scopedSlots.fileList"
            >
                <!-- update author: tangdm descript: change button's size -->
                <el-button icon="el-icon-upload2" :disabled="disabled">文件上传</el-button>
                <div v-if="tipMsg !== false && (tipMsg  || message)" slot="tip" class="el-upload__tip">{{ tipMsg || message }}</div>
            </upload>
        </template>

        <template v-else-if="listType === 'avatar'">
            <upload class="dg-upload__image avatar-uploader" v-bind="_attrs" v-on="$listeners">
                <img
                    v-if="imageUrl"
                    class="avatar"
                    :src="getImg(imageUrl)"
                    :onerror="error"
                />
                <div v-else>
                    <i :class="['el-icon-plus', 'avatar-uploader-icon', disabled ? 'dg-upload--content is-disabled' : '']"
                    ></i>
                    <p class="dg-upload--text">上传</p>
                </div>
            </upload>
        </template>

        <template v-else-if="listType === 'viewer' && !showOne">
            <upload style="display:inline-block" v-bind="_attrs" v-on="$listeners">
                <div :class="['el-upload el-upload--text', disabled ? 'dg-upload--content is-disabled' : '']">
                    <i class="el-icon-plus avatar-uploader-icon"></i>
                    <p class="dg-upload--text" style="margin: 0;">上传</p>
                </div>
            </upload>

            <!--<el-dialog v-if="dialogVisible" :visible.sync="dialogVisible" append-to-body>-->
            <!--<el-carousel indicator-position="outside" :autoplay="false" :initial-index="index">-->
            <!--<el-carousel-item v-for="(img, key) in imgList" :key="key">-->
            <!--<img-->
            <!--:src="serverUrl + img._url"-->
            <!--style="max-width: 100%;max-height: 100%;display: block; margin: 0 auto;"-->
            <!--/>-->
            <!--</el-carousel-item>-->
            <!--</el-carousel>-->
            <!--</el-dialog>-->
            <!-- update author: tangdm descript: update picture's details -->
            <ul ref="imageUrl" v-show="false">
                <li v-for="(img, key) in imgList" :key="key">
                    <img class="dg-upload__img" :src="getImg(img._url)" :onerror="error" />
                </li>
            </ul>
        </template>

        <template v-else-if="listType === 'viewer' && showOne">
            <upload v-bind="_attrs" v-on="$listeners">
                <div :class="['dg-upload-div', disabled ? 'dg-upload--content is-disabled' : '']">
                    <i class="el-icon-plus"></i>
                    <p class="dg-upload--text">上传</p>
                </div>
            </upload>
            <!--<el-dialog v-if="dialogVisible" :visible.sync="dialogVisible" append-to-body>-->
            <!--<dg-viewer :images="imgList"></dg-viewer>-->
            <!--</el-dialog>-->
            <!-- update author: tangdm descript: update picture's details -->
            <ul ref="imageUrl" v-show="false">
                <li v-for="(img, key) in imgList" :key="key">
                    <img class="dg-upload__img" :src="getImg(img._url)" :onerror="error" />
                </li>
            </ul>
        </template>

        <template v-else-if="listType === 'pictureList'">
            <upload v-bind="_attrs" v-on="$listeners" :class="{ 'dg-upload__list': fileLength }">
                <div class="dg-upload--pictureList" v-if="fileLength < 1">
                    <i class="el-icon-plus"></i>
                    <p class="dg-upload--text">上传</p>
                </div>

                <div v-else class="dg-upload__carousel" slot="uploadList">
                    <!-- update author: tangdm [code] height="118px" -->
                    <el-carousel ref="hrl" :height="carouselHeight" v-bind="carousel" :initial-index="index">
                        <el-carousel-item v-for="(item, key) in imgList" :key="key" :name="key + ''">
                            <img :src="getImg(getUrl(item))" :onerror="error" />
                        </el-carousel-item>
                    </el-carousel>

                    <span class="dg-upload__shade">
                        <i class="el-icon-zoom-in" v-if="iconZoom" @click.stop="handleZoomIn"></i>
                        <i class="el-icon-delete" v-if="iconDelete" @click.stop="handleDelete"></i>
                        <i class="el-icon-plus" v-if="iconPlus" @click.stop="handlePlus"></i>
                    </span>
                </div>
                <div v-if="fileLength" ref="uploadBtn" slot="trigger"></div>
            </upload>

            <!-- 2或3张的时候显示 -->
            <ul class="dg-upload__indicator" v-if="fileLength > 1 && fileLength <= showbottom">
                <li
                    v-for="(item, key) in fileLength"
                    :key="key"
                    :class="[
                        'el-carousel__indicator',
                        'el-carousel__indicator--horizontal',
                        { 'is-active': index === key }
                    ]"
                    @mouseenter="handleIndicator('hover', key)"
                    @click.stop="handleIndicator('click', key)"
                >
                    <button class="el-carousel__button"></button>
                </li>
            </ul>

            <!-- 以上的时候显示 -->
            <div class="dg-upload__indicator-more" v-if="fileLength > showbottom">
                <i class="el-icon-caret-left" @click.stop="pageturning('prev')"></i>
                <span class="is-active">{{ index + 1 }}</span>
                <span>/{{ fileLength }}</span>
                <i class="el-icon-caret-right" @click.stop="pageturning('next')"></i>
            </div>

            <!--<el-dialog class="dg-upload__dialog" :visible.sync="dialogVisible" append-to-body>-->
            <!--<img class="dg-upload__img" :src="serverUrl + dialogImageUrl" />-->
            <!--</el-dialog>-->
            <!-- update author: tangdm descript: update picture's details -->
            <ul ref="imageUrl" v-show="false">
                <li v-for="(item, key) in imgList" :key="key">
                    <img class="dg-upload__img" :src="getImg(getUrl(item))" :onerror="error" />
                </li>
            </ul>
        </template>

        <template v-else>
            <upload v-bind="_attrs" v-on="$listeners" :list-slot="$scopedSlots.fileList">
                <slot></slot>
                <slot name="trigger" slot="trigger"></slot>
                <slot name="tip" slot="tip"></slot>
            </upload>
        </template>
    </div>
</template>

<script>
import _ from 'lodash';
import { str2arr } from 'main/dg-utils/data-convert.js';
import Upload from './upload-main.vue';
import emitter from 'main/mixins/emitter';
import { sizeType, fileSize, linkDown } from './unit.js';
import PopupManager from 'element-ui/lib/utils/popup/popup-manager';
import Viewer from 'viewerjs';
import {
    Button as ElButton, Carousel as ElCarousel,
    CarouselItem as ElCarouselItem,
    Dialog as ElDialog
} from 'element-ui';

export default {
    name: 'DgUpload',

    mixins: [emitter],

    inject: {
        elForm: {
            default: ""
        },
        elFormItem: {
            default: ""
        }
    },

    components: {
        Upload,
        ElDialog,
        ElButton,
        ElCarousel,
        ElCarouselItem
    },

    props: {
        // form
        validateEvent: {
            type: Boolean,
            default: true
        },
        action: String,
        value: [String, Array],
        leaflet: Boolean,
        showOne: Boolean,
        disabled: Boolean,
        tipMsg: [String, Boolean],
        accept: String,
        size: [String, Number],
        limit: Number,
        fileList: Array,
        listType: {
            type: String,
            default: 'text'
        },
        seq: {
            type: String,
            default: ','
        },
        outputFormat: {
            type: String,
            default: 'String',
            validator: function(val) {
                return ['String', 'Array'].indexOf(val) !== -1;
            }
        },
        // 请求数据处理
        reqFunction: Function,
        // 响应的数据类型
        resFunction: Function,
        // 资源服务器前缀
        serverUrl: {
            type: String,
            default: ''
        },
        props: Object,
        valueName: String,
        labelName: String,
        // 是否展示缩放图标
        iconZoom: {
            type: Boolean,
            default: false
        },
        // 是否展示删除图标
        iconDelete: {
            type: Boolean,
            default: false
        },
        // 是否展示增加图标
        iconPlus: {
            type: Boolean,
            default: false
        },
        carouselHeight: {
            type: String,
            default: '120px'
        },
        onExceed: Function,
        onPreview: Function,
        onRemove: Function,
        onSuccess: Function,
        onProgress: Function,
        errorImg: String
    },

    data() {
        return {
            index: 0,
            showbottom: 3,
            dialogImageUrl: '',
            // dialogVisible: false,
            imageUrlViewer: null
        };
    },

    computed: {
        carousel() {
            return {
                autoplay: false,
                'indicator-position': 'none',
                arrow: 'never'
            };
        },

        error() {
            const { errorImg } = this;
            return errorImg ? `this.src="${errorImg}"; this.onerror=null;` : '';
        },

        defaultOpt() {
            const { props = {}, labelName, valueName } = this;

            return {
                name: labelName || props.name || 'name',
                url: valueName || props.url || 'url'
            };
        },

        message() {
            const { tipMsg, size, accept, limit } = this;

            if (tipMsg) {
                return tipMsg;
            }

            if (tipMsg === false) {
                return false;
            }

            let arr = [];

            if (accept) {
                arr.push(`限制类型${accept}`);
            }

            if (limit) {
                arr.push(`限制选择${limit}个`);
            }

            if (size) {
                const sType = sizeType(size);

                if (sType === '[object String]') {
                    arr.push(`限制大小${size}`);
                } else if (sType === '[object Number]') {
                    arr.push(`限制大小${fileSize(size)}`);
                }
            }

            return `文件${arr.join('、')}`;
        },

        // 对数据进行处理
        imgList() {
            const { value, fileList } = this;
            const arr = this.fileValue(value || fileList);
            return arr.map(item => {
                item._url = this.getUrl(item);
                return item;
            });
        },

        fileLength() {
            const { value, fileList } = this;
            const arr = this.fileValue(value || fileList);
            return arr.length;
        },

        // 获取文件中列表的URL
        imageUrl() {
            const { value, fileList } = this;
            const arr = this.fileValue(value || fileList);
            if (arr.length) {
                return this.getUrl(arr[arr.length - 1]);
            }
            return '';
        },

        _attrs() {
            const { listType, $attrs, $props } = this;
            let attr = { ...$attrs, ...$props };
            attr['errorImg'] = this.errorImg;
            attr.ref = 'upload';
            attr['onProgress'] = this._handleProgress;
            attr['onRemove'] = this._handleRemove;
            attr['onSuccess'] = this._handleSuccess;
            attr['onExceed'] = this._handleExceed;
            attr['onPreview'] = this._handlePreview;
            attr.action = this.action;
            attr['server-url'] = this.serverUrl;
            attr['fileList'] = this.fileValue(this.value || this.fileList);
            attr.defaultOpt = this.defaultOpt;

            if (['avatar', 'button', 'viewer', 'pictureList'].indexOf(listType) !== -1) {
                attr['listType'] = 'text';

                switch (listType) {
                    case 'button':
                        break;
                    case 'avatar':
                        attr['showFileList'] = false;
                        break;
                    case 'pictureList':
                        attr['showFileList'] = false;
                        break;
                    case 'viewer':
                        attr['listType'] = 'picture-card';
                        attr['onPreview'] = this._handleViewerPreview;
                        break;
                }
            }

            return attr;
        }
    },

    watch: {
        value(val) {
            if (this.validateEvent) {
                this.dispatch('ElFormItem', 'el.form.change', [val]);
            }
        }
    },

    methods: {
        submit() {
            this.$nextTick(() => {
                this.$refs.upload.submit();
            });
        },

        abort(file) {
            this.$nextTick(() => {
                this.$refs.upload.abort(file);
            });
        },

        clearFiles() {
            this.$nextTick(() => {
                this.$refs.upload.clearFiles();
            });
        },

        getImg(url) {
            const { serverUrl } = this;
            return /^\//.test(url) ? serverUrl + url : url;
        },

        getUrl(item) {
            const isFile = Object.prototype.toString.call(item.raw) === '[object File]';
            return item[this.defaultOpt.url] || (isFile && URL.createObjectURL(item.raw)) || '';
        },

        // value 或 fileList 的数据转换
        fileValue(val) {
            // 对象解构简化写法 const { name, url } = defaultOpt
            const {
                defaultOpt: { name, url },
                reqFunction,
                seq
            } = this;
            /*
				  [BUG]
				  描述
					  如果没有更新 Upload (比如插入,删除等)，更新 Upload 父组件中的 $data 会造成 upload-list 重新渲
				  原因
					  这里不能深度拷贝，upload-list 中有 map 更新 fileList 数据
				*/
            let arr = str2arr(val, seq, false);
            if (_.isString(val)) {
                arr.forEach(item => ({
                    [name]: null,
                    [url]: item,
                    _url: item
                }));
            } else {
                arr.forEach(item => {
                    if (!item[url]) {
                        const _url = this.getUrl(item);
                        item[url] = _url;
                        item._url = _url;
                    }
                });
            }
            return reqFunction ? reqFunction(arr) : arr;
        },

        // pictureList-start
        // 翻页
        pageturning(type) {
            const { index, fileLength } = this;
            if (type === 'next') {
                this.index = index < fileLength - 1 ? index + 1 : fileLength - 1;
            } else {
                this.index = index > 0 ? index - 1 : 0;
            }
            this.handleIndicator(type, this.index);
        },

        // 查看
        handleZoomIn() {
            const { index, imgList, getUrl } = this;
            this.dialogImageUrl = getUrl(imgList[index]);
            // this.dialogVisible = true;
            this._handleViewerShow(index);
        },

        // 删除
        handleDelete() {
            const { index, imgList } = this;
            const fileList = _.cloneDeep(imgList);
            const file = fileList.splice(index, 1);
            this.index = index > 0 ? index - 1 : 0;
            this.$refs.hrl.setActiveItem(this.index);
            this._handleRemove(file, fileList);
        },

        // 上传事件
        handlePlus() {
            this.$refs.uploadBtn.click();
        },
        // pictureList-end

        handleIndicator(type, index) {
            const hrl = this.$refs.hrl;
            this.index = index;
            hrl.setActiveItem(index);
        },

        // 进度条控制
        _handleProgress(event, file, fileList) {
            this._handleChangeData(fileList);
            this.onProgress && this.onProgress(event, file, fileList);
        },

        _handleChangeData(fileList) {
            const { listType, resFunction } = this;

            if (_.isArray(fileList) && fileList.length > 1) {
                if (listType === 'avatar') {
                    fileList = [fileList.pop()];
                }

                if (listType === 'pictureList' && this.leaflet) {
                    fileList = [fileList.pop()];
                }
            }
            this.$emit('input', resFunction ? this.resFunction(fileList) : fileList);
        },

        _handleSuccess(res, file, fileList) {
            this._handleChangeData(fileList);
            this.onSuccess && this.onSuccess(res, file, fileList);
        },

        _handleRemove(file, fileList, sizeBool) {
            this._handleChangeData(fileList);
            this.onRemove && this.onRemove(file, fileList, sizeBool);
        },

        _handleExceed(files, fileList) {
            if (this.limit && !this.onExceed) {
                this.$message.warning(
                    `当前限制选择 ${this.limit} 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length +
                        fileList.length} 个文件`
                );
                return;
            }
            this.onExceed && this.onExceed(files, fileList);
        },

        _handlePreview(file) {
            const { listType, defaultOpt, serverUrl } = this;
            const { name, url } = defaultOpt;

            if (file[url] && !this.onPreview && (listType && listType.indexOf('picture-card') === -1)) {
                linkDown(serverUrl + file[url], file[name]);
                return;
            }

            this.onPreview && this.onPreview(file);
        },

        _handleViewerPreview(file, index) {
            // this.dialogVisible = true;
            this._handleViewerShow(index);
            this.index = index;
            this.onPreview && this.onPreview(file);
        },
        /**
         * 图片预览方法
         *
         * @param index
         * @return {boolean}
         * @private
         */
        _handleViewerShow(index) {
            // 检测是否存在图片文件
            if (!this.imageUrlViewer) return false;

            // 刷新图片数据
            this.imageUrlViewer.update();

            if (index === 'underfined') {
                this.imageUrlViewer.show();
            } else {
                this.imageUrlViewer.view(index);
            }
        }
    },

    mounted() {
        this.$nextTick(() => {
            if (this.$refs.imageUrl) {
                this.imageUrlViewer = new Viewer(this.$refs.imageUrl, {
                    zIndex: PopupManager.nextZIndex(),
                    zIndexInline: PopupManager.nextZIndex()
                });
            }
        });
    }
};
</script>
