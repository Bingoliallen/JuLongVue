<script>
import _ from 'lodash';
import { str2date, any2date } from './analysis-date';
import { isArray } from 'main/dg-utils/types';
import { formatDate } from 'main/dg-utils/date';
import DgSelect from 'packages/select';
import DgRadioGroup from 'packages/radio-group';
import { DatePicker as ElDatePicker } from 'element-ui';

// element-ui Date 值是否相等判断
const valueEquals = function(a, b) {
    // considers Date object and string
    const dateEquals = function(a, b) {
        const aIsDate = a instanceof Date;
        const bIsDate = b instanceof Date;
        if (aIsDate && bIsDate) {
            return a.getTime() === b.getTime();
        }
        if (!aIsDate && !bIsDate) {
            return a === b;
        }
        return false;
    };

    const aIsArray = a instanceof Array;
    const bIsArray = b instanceof Array;
    if (aIsArray && bIsArray) {
        if (a.length !== b.length) {
            return false;
        }
        return a.every((item, index) => dateEquals(item, b[index]));
    }
    if (!aIsArray && !bIsArray) {
        return dateEquals(a, b);
    }
    return false;
};

export default {
    name: 'DgDatePicker',

    /*  inheritAttrs: false 组件将不会把未被注册的props呈现为普通的HTML属性,并赋值到子组件的根元素
        具体表现： (inheritAttrs 等于 true 和 false 都会有1,3)
            1. 未被注册的props -> $attrs
            2. 未被注册的props不会呈现HTML属性
            3. 剔除 class、style
        详见文档：
            https://cn.vuejs.org/v2/api/index.html#inheritAttrs
            https://www.jianshu.com/p/ce8ca875c337
    */
    inheritAttrs: false,

    inject: {
        elForm: {
            default: ''
        },
        elFormItem: {
            default: ''
        }
    },

    components: {
        DgSelect,
        DgRadioGroup,
        ElDatePicker
    },

    props: {
        type: {
            type: String,
            required: true
        },
        isSelect: Boolean,
        callOff: Boolean,
        shortBtns: {
            type: Array,
            default: () => []
        },
        size: {
            type: String,
            default: 'small'
        },
        startValue: [String, Date],
        endValue: [String, Date],
        props: {
            type: Object,
            default() {
                return { label: 'text', value: 'time' };
            }
        },
        checkValue: {
            default: ''
        },
        value: {
            type: [Array, String, Number],
            default: ''
        }
    },

    // 需要深度监听，因为可能数据类型为数组
    watch: {
        value: {
            immediate: true,
            handler(val) {
                const { dgRanged } = this;
                if (dgRanged) {
                    if (isArray(val)) {
                        this.startDate = val[0];
                        this.endDate = val[1];
                    } else {
                        this.singleDate = val;
                    }
                } else {
                    this.singleDate = val;
                }

                // 清空选中的值
                if (!val) {
                    this.selectValue = '';
                    this.activeShortBtn = '';
                }
            }
        },

        startValue: {
            immediate: true,
            handler(val, oldVal) {
                const changeVal = this.formatToValue(val);
                this.startDate = changeVal;
                this.$emit('update:startValue', changeVal);
            }
        },

        endValue: {
            immediate: true,
            handler(val, oldVal) {
                const changeVal = this.formatToValue(val);
                this.endDate = changeVal;
                this.$emit('update:endValue', changeVal);
            }
        },

        size(val) {
            // 下拉框只有单选状态，且是快捷方式
            this.$nextTick(() => {
                document.querySelector('.dg-date-picker .el-input>.el-input__inner').style.height = '';
            });
        }
    },

    data() {
        return {
            // 下拉框选中值
            selectValue: '',
            // 单选框选中值
            activeShortBtn: '',
            // 单个输入框日期
            singleDate: '',
            // 开始时间
            startDate: '',
            // 结束时间
            endDate: ''
        };
    },

    render(h) {
        let select, radioGroup, dataTime;

        if (this.isSelect) {
            const dataS = {
                class: 'dg-date-picker-select',
                props: {
                    data: this.validataList,
                    value: this.selectValue,
                    'value-name': this.props.value || 'time',
                    'label-name': this.props.label || 'text'
                },
                attrs: {
                    // size: this.inputSize,
                    disabled: this.$attrs.disabled
                },
                on: {
                    change: this.changeSelect,
                    input: val => {
                        this.selectValue = val;
                    }
                }
            };
            select = <dg-select {...dataS}></dg-select>;
        }

        if (!this.isSelect && this.shortBtnVisible) {
            const dataB = {
                props: {
                    data: this.validataList,
                    value: this.activeShortBtn,
                    type: this.$attrs['radio-type'] || 'button',
                    'call-off': this.callOff,
                    'value-name': this.props.value || 'time',
                    'label-name': this.props.label || 'text'
                },
                attrs: {
                    disabled: this.$attrs.disabled
                    // type: this.$attrs.radioType
                    // size: this.inputSize
                },
                on: {
                    change: this.changeSelect,
                    input: val => {
                        this.activeShortBtn = val;
                    }
                }
            };
            radioGroup = <dg-radio-group {...dataB}></dg-radio-group>;
        }

        if (!this.dgRanged) {
            const data = {
                ref: 'picker',
                props: {
                    ...this.$attrs,
                    // size: this.inputSize,
                    type: this.dgType,
                    value: this.singleDate
                },
                on: {
                    ...this.$listeners,
                    pick: this.emitInput,
                    change: this.singleChange,
                    input: val => {
                        this.singleDate = val;
                    }
                }
            };
            dataTime = <el-date-picker {...data}></el-date-picker>;
        } else {
            const { 'default-time': defaultTime } = this.$attrs;
            const bool = isArray(defaultTime) && defaultTime.length > 1;
            // 两个框分开
            const data1 = {
                ref: 'picker',
                props: {
                    ...this.$attrs,
                    // size: this.inputSize,
                    value: this.startDate,
                    type: this.dgType,
                    placeholder: this.$attrs['start-placeholder'],
                    'default-time': bool ? [defaultTime[0]] : defaultTime,
                    'picker-options': {
                        disabledDate: time => {
                            if (this.endDate) {
                                return (new Date(this.endDate).getTime() - 24 * 60 * 60 * 1000) < time.getTime();
                            }
                            return false;
                        },
                        ...this['picker-options']
                    }
                },
                on: {
                    pick: this.emitInput,
                    change: this.pickChange,
                    input: val => {
                        this.startDate = val;
                    }
                }
            };
            const data2 = {
                ref: 'picker2',
                props: {
                    ...this.$attrs,
                    // size: this.inputSize,
                    value: this.endDate,
                    type: this.dgType,
                    placeholder: this.$attrs['end-placeholder'],
                    'default-time': bool && defaultTime[1] ? [defaultTime[1]] : defaultTime,
                    'picker-options': {
                        disabledDate: time => {
                            if (this.startDate) {
                                return new Date(this.startDate).getTime() - 24 * 60 * 60 * 1000 > time.getTime();
                            }
                            return false;
                        },
                        ...this['picker-options']
                    }
                },
                on: {
                    pick: this.emitInput,
                    change: this.pick2Change,
                    input: val => {
                        this.endDate = val;
                    }
                }
            };

            // 默认分割元素
            const separator = <span class="el-range-separator">{this.$attrs['range-separator']}</span>;

            dataTime = (
                <div class="el-date-editor dg-range-editor">
                    <el-date-picker {...data1}></el-date-picker>
                    {this.$slots['range-separator'] || separator}
                    <el-date-picker {...data2}></el-date-picker>
                </div>
            );
        }

        return (
            <div class={{ 'dg-date-picker': true, 'dg-date-picker__short-btn': this.shortBtnVisible }}>
                {select}
                {radioGroup}
                {dataTime}
            </div>
        );
    },

    computed: {
        _elFormItemSize() {
            return (this.elFormItem || {}).elFormItemSize;
        },
        inputSize() {
            return this.size || this._elFormItemSize || (this.$ELEMENT || {}).size;
        },
        shortBtnVisible() {
            return this.shortBtns.length > 0;
        },
        dgRanged() {
            /*
                if type.lastIndexOf('range2')
                针对范围型控件，拆分成两个独立控件，通过模板拆分渲染，不采用 elment-ui 自带渲染方式
            */
            return this.type.lastIndexOf('range2') > -1;
        },
        dgType() {
            // if type === 'datetimerange2'|'daterange2'|'monthrange2' => 'datetime'|'date'|'month'
            return this.type.replace(/range2/, '');
        },

        /*  创建原因
         1. props.value 可能是数组。radio-button 不能识别这种 value
         2. props.value 可能不存在，而是使用 onClick 方法
        */
        validataList() {
            const { props, shortBtns } = this;
            return (_.cloneDeep(shortBtns) || []).map(item => {
                const val = item[props.value];
                item._time = val || ''; // 保留原始数据及类型
                item[props.value] = val ? _.toString(val) : item[props.label];
                return item;
            });
        }
    },

    methods: {
        changeSelect(val) {
            // 兼容反选状况
            if (val) {
                const { props, validataList } = this;
                const shortbtn = validataList.find(o => o[props.value] === val);
                const picker = this.$refs.picker;

                // 用户自定义传值情况
                if (shortbtn.onClick) {
                    shortbtn.onClick(picker);
                } else {
                    const shortVal = shortbtn._time; // 处理原始类型
                    let single = isArray(shortVal)
                        ? shortVal.map(item => formatDate(str2date(item), true))
                        : formatDate(str2date(shortVal), true);
                    if ((this.dgType.lastIndexOf('range') !== -1 || this.dgRanged) && !isArray(shortVal)) {
                        single = shortVal.slice(0, 1) === '-' ? [single, formatDate()] : [formatDate(), single];
                        this.startDate = single[0];
                        this.endDate = single[1] || single[0];
                        this.singleDate = single;
                    } else {
                        this.startDate = single;
                        this.endDate = single;
                        this.singleDate = single;
                    }
                }
            } else {
                this.startDate = '';
                this.endDate = '';
                this.singleDate = '';
            }
            this.changeDate();
        },

        // 将数据按 value-format 传入格式输出
        formatToValue(value) {
            const { 'value-format': format, 'default-time': defaultTime } = this.$attrs;
            if (!value) {
                return null;
            }

            // fix:修复定义default-time快捷选择无效
            if (isArray(value) && isArray(defaultTime) && defaultTime.length > 1) {
                if (value.length > 0) {
                    value[0] = value[0].split(" ")[0] + " " + defaultTime[0];
                }
                if (value.length > 1) {
                    value[1] = value[1].split(" ")[0] + " " + defaultTime[1];
                }
            }

            // 'timestamp' 显示数值类型
            if (format && format !== 'timestamp') {
                value = isArray(value)
                    ? value.map(date => formatDate(format, new Date(date)))
                    : formatDate(format, new Date(value));
            }
            if (format === 'timestamp') {
                value = isArray(value) ? value.map(date => new Date(date).getTime()) : new Date(value).getTime();
            }

            return value;
        },

        // 改变 value、endValue、startValue 触发 emit
        changeDate() {
            const { dgType, dgRanged, singleDate, startDate, endDate, formatToValue } = this;
            if (dgRanged) {
                const sVal = formatToValue(startDate);
                const eVal = formatToValue(endDate);
                const seVal = sVal || eVal ? [sVal, eVal] : '';
                this.$emit('input', seVal);
                this.$emit('change', seVal);
                this.$emit('update:startValue', sVal);
                this.$emit('update:endValue', eVal);
            } else {
                const val = formatToValue(singleDate);
                this.$emit('input', val);
                this.$emit('change', val);
                if (isArray(val) && (dgRanged || dgType.lastIndexOf('range') !== -1)) {
                    this.$emit('update:startValue', val[0]);
                    this.$emit('update:endValue', val[1]);
                }
            }
        },

        // element-ui  onPick 选中日期后会执行的回调，只有当 daterange 或 datetimerange 中生效
        emitInput(value) {
            const formatted = isArray(value) ? value.map(item => formatDate(item, true)) : formatDate(value, true);
            const { dgRanged, dgType } = this;
            if (dgRanged || dgType.lastIndexOf('range') !== -1) {
                if (isArray(value)) {
                    this.singleDate = formatted;
                    this.startDate = formatted[0];
                    this.endDate = formatted[1];
                } else {
                    this.singleDate = formatted;
                    this.startDate = formatted;
                    this.endDate = formatted;
                }
            } else {
                this.singleDate = formatted;
                this.startDate = null;
                this.endDate = null;
            }
        },

        singleChange(val) {
            const vl = this.toDate(val);
            this.changeTime();
            this.singleDate = vl;
            this.startDate = isArray(val) ? vl[0] : vl;
            this.endDate = isArray(val) ? vl[1] : vl;
            this.changeDate();
        },

        pickChange(val) {
            this.changeTime();
            this.startDate = this.toDate(val);
            this.changeDate();
        },

        pick2Change(val) {
            this.changeTime();
            this.endDate = this.toDate(val);
            this.changeDate();
        },

        // 当时间值被改变时应该置空快捷选中
        changeTime() {
            this.activeShortBtn = '';
            this.selectValue = '';
        },

        // 将 String, Date, Number 转换成日期
        toDate(val) {
            // 若进入 formatDate 方法，null || '' 条件下则会自动添加当前日期和时间
            if (!val) {
                return '';
            }
            return isArray(val) ? val.map(item => formatDate(any2date(item))) : formatDate(any2date(val));
        }
    },

    created() {
        const { startValue, endValue, checkValue, type, value } = this;
        if (startValue) {
            this.startDate = startValue;
        }

        if (endValue) {
            this.endDate = endValue;
        }

        if (startValue || endValue) {
            this.changeDate();
        }

        if ((type === 'datetimerange2' || type === 'daterange2') && value) {
            if (isArray(value) && value.length > 0) {
                this.startDate = value[0];
                this.endDate = value[value.length === 1 ? 0 : 1];
                this.changeDate();
            }
        }

        if (checkValue) {
            const {
                isSelect,
                shortBtnVisible,
                validataList,
                props: { label }
            } = this;
            const findItem = _.find(validataList, item => item[label] === checkValue && item.onClick);
            // 如果是 onClick 触发的
            if (findItem) {
                this.selectValue = this.activeShortBtn = checkValue;
                this.$nextTick(() => {
                    const picker = this.$refs.picker;
                    findItem.onClick(picker);
                    this.changeDate();
                });
                return;
            }

            // 下拉框
            if (isSelect) {
                this.selectValue = checkValue;
                this.changeSelect(checkValue);
            }
            // 按钮
            if (!isSelect && shortBtnVisible) {
                this.activeShortBtn = _.isArray(checkValue) ? checkValue.join(',') : checkValue;
                this.changeSelect(checkValue);
            }
        }
    }
};
</script>
