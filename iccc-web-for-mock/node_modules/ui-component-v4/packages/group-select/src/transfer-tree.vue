<template>
    <div class="dg-transfer dg-tree-transfer dg-group-select-transfer">
        <!-- 左侧穿梭框 -->
        <div class="el-transfer-panel">
            <p class="el-transfer-panel__header">
                <el-checkbox
                    :indeterminate="sourceIsIndeterminate"
                    v-model="sourceCheckAll"
                    @change="sourceAllBoxCheck"
                >
                    <template v-if="titles[0] !== undefined">{{ titles[0] }}</template>
                </el-checkbox>
                <slot name="title-left"></slot>
            </p>
            <!-- 内容区 -->
            <div class="el-transfer-panel__body">
                <div class="el-transfer-panel__list" style="padding: 0;">
                    <el-input
                        v-if="filterable"
                        class="el-transfer-panel__filter"
                        :placeholder="placeholder"
                        v-model="filterFrom"
                        size="small"
                        :clearable="clearable"
                    >
                        <i slot="suffix" :class="['el-input__icon', 'el-icon-search']"></i>
                    </el-input>
                    <el-tree
                        ref="from-tree"
                        v-bind="allTreeProps"
                        :class="[filterable ? `is-filterable` : '']"
                        :data="sourceData"
                        show-checkbox
                        :node-key="valueName"
                        @check="sourceTreeChecked"
                        :default-expanded-keys="sourceExpandedKeys"
                        :filter-node-method="filterNodeFrom"
                        :default-expand-all="openAll"
                        :render-content="renderContent"
                        :default-checked-keys="sourceCheckKeys"
                    ></el-tree>
                </div>
            </div>
            <p class="el-transfer-panel__footer" v-if="$slots['left-footer']">
                <slot name="left-footer"></slot>
            </p>
        </div>

        <!-- 穿梭区 按钮框 -->
        <div class="el-transfer__buttons">
            <el-button
                type="primary"
                :class="['el-transfer__button', hasButtonTexts ? 'is-with-texts' : '']"
                @click.native="addToTarget"
                :disabled="sourceDisabled"
            >
                <span v-if="buttonTexts[1] !== undefined">{{ buttonTexts[1] }}</span>
                <i class="el-icon-arrow-right"></i>
            </el-button>
        </div>

        <!-- 右侧穿梭框 -->
        <div class="el-transfer-panel">
            <p class="el-transfer-panel__header group-header">
                <el-checkbox
                    :indeterminate="targetIsIndeterminate"
                    v-model="targetCheckAll"
                    @change="targetAllBoxCheck"
                >
                    <template v-if="titles[1] !== undefined">{{ titles[1] }}</template>
                </el-checkbox>
                <span class="header-btn-wrap">
                    <el-button type="text" @click="handleAddGroup(data)">添加</el-button>
                    <el-button type="text" @click="handleBatchDel">删除</el-button>
                </span>
                <slot name="title-right"></slot>
            </p>
            <!-- 内容区 -->
            <div class="el-transfer-panel__body">
                <div class="el-transfer-panel__list" style="padding: 0;">
                    <el-input
                        v-if="filterable"
                        class="el-transfer-panel__filter"
                        :clearable="clearable"
                        :placeholder="placeholder"
                        v-model="filterTo"
                        size="small"
                    >
                        <i slot="suffix" :class="['el-input__icon', 'el-icon-search']"></i>
                    </el-input>
                    <el-tree
                        :class="[filterable ? `is-filterable` : '']"
                        draggable
                        ref="to-tree"
                        show-checkbox
                        :props="treeProps"
                        :data="innerGroupData"
                        :node-key="valueName"
                        :allow-drop="judgAllowDrop"
                        :allow-drag="handleBeforeDrag"
                        :default-expand-all="openAll"
                        :filter-node-method="filterNodeTo"
                        :default-checked-keys="targetCheckKeys"
                        :default-expanded-keys="targetExpandedKeys"
                        @check="toTreeChecked"
                        @node-expand="handleToNodeExpend"
                        @node-collapse="handleToNodeCollapse"
                        @node-drop="handleAfterNodeDrop"
                    >
                        <div
                            slot-scope="{ node, data }"
                            @mouseenter="handleMouseenter(node, $event)"
                            @mouseleave="handleMouseleave(node, $event)"
                            @dblclick.stop="handleDbclick(node, data, $event)"
                            class="custom-tree-node el-tree-node__label"
                        >
                            <template v-if="!data.isEditing">
                                <span class="label-wrap" :title="data[labelName]">{{ data[labelName] }}</span>
                                <span class="button-wrap">
                                    <!-- 编辑按钮 -->
                                    <el-button
                                        type="text"
                                        class="edit-btn"
                                        icon="el-icon-edit"
                                        @click="handleDbclick(node, data, $event)"
                                    ></el-button>
                                    <!-- 删除按钮   -->
                                    <el-button
                                        type="text"
                                        class="del-btn"
                                        icon="el-icon-delete"
                                        @click="handleDeleteNodeClick(node, data)"
                                    ></el-button>
                                </span>
                            </template>
                            <template v-else>
                                <el-input
                                    size="mini"
                                    v-focus="data.isEditing"
                                    :data-cur="data.isEditing"
                                    v-model="data[labelName]"
                                    :maxlength="10"
                                    @click.stop.native="$event.stopPropagation()"
                                    @blur="handleInputBlur(data, $event)"
                                >
                                    <i
                                        slot="suffix"
                                        class="el-input__icon el-icon-check"
                                        @click="handleInputBlur(data, $event)"
                                    ></i>
                                </el-input>
                            </template>
                        </div>
                    </el-tree>
                </div>
            </div>
            <p class="el-transfer-panel__footer" v-if="$slots['right-footer']">
                <slot name="right-footer"></slot>
            </p>
        </div>
    </div>
</template>

<script>
import _ from 'lodash';
import { Transfer } from 'element-ui';

export default {
    name: 'TransferTree',
    props: {
        leftDefaultChecked: {
            type: Array,
            default() {
                return [];
            }
        },
        allTreeProps: {
            type: Object,
            default: () => ({})
        },
        rightDefaultChecked: {
            type: Array,
            default() {
                return [];
            }
        },
        // 默认选中值
        value: {
            type: Array,
            default() {
                return [];
            }
        },
        // 选项配置数据
        data: {
            type: Array,
            default: []
        },
        // 分组数据
        groupData: {
            type: Array,
            default: []
        },
        // 值的字段名称
        valueName: {
            type: String,
            default: 'value'
        },
        // 显示的字段名称
        labelName: {
            type: String,
            default: 'label'
        },
        // 禁用值的名称
        disabledName: {
            type: String,
            default: 'disabled'
        },
        // 子节点数组的名称
        childrenName: {
            type: String,
            default: 'children'
        },
        // 父级节点名称
        pidName: {
            type: String,
            default: 'pid'
        },
        // 标题配置
        titles: {
            type: Array,
            default: () => ['源列表', '目标列表']
        },
        // 按钮文本配置
        buttonTexts: {
            type: Array,
            default: () => []
        },
        // 穿梭后是否展开节点
        transferOpenNode: {
            type: Boolean,
            default: false
        },
        // 筛选 placeholder
        placeholder: {
            type: String,
            default: '输入关键字进行过滤'
        },
        // 是否展开所有节点
        openAll: {
            type: Boolean,
            default: false
        },
        // 自定义树节点
        renderContent: Function,
        // 是否启用筛选
        filterable: {
            type: Boolean,
            default: false
        },
        clearable: {
            type: Boolean,
            default: true
        }
    },
    data() {
        return {
            // 内部数据配置项
            dataSource: this.data,
            // props 的字段别名
            treeProps: {
                label: this.labelName,
                children: this.childrenName,
                disabled: this.disabledName,
                ...this.allTreeProps
            },
            // 是否半选源列表数据状态
            sourceIsIndeterminate: false,
            // 是否半选源列表数据状态
            sourceCheckAll: false,
            // 是否半选目标列表数据状态
            targetIsIndeterminate: false,
            // 是否半选目标列表数据状态
            targetCheckAll: false,
            // 源数据选中key数组 以此属性关联穿梭按钮，总全选、半选状态
            sourceCheckKeys: [],
            // 目标数据选中key数组 以此属性关联穿梭按钮，总全选、半选状态
            targetCheckKeys: [],
            // 源数据展开节点
            sourceExpandedKeys: [],
            // 目标数据展开节点
            targetExpandedKeys: [],
            // 添加按钮是否禁用
            sourceDisabled: true,
            // 移除按钮是否禁用
            targetDisabled: true,
            // 源数据筛选
            filterFrom: '',
            // 目标数据筛选
            filterTo: '',
            // 目标列表数据勾选
            acceptCheckedKeys: [],
            innerGroupData: [],
            //是否有分组编辑框正在编辑
            hasGroupEditing: false,
            initOver: false,
            // 分组名重复提示消息防抖
            errorMessageHandle: false,
            // 目标树展开的节点
            toTreeExpendNodes: {}
        };
    },
    computed: {
        //分组名集合，用于新增分组时重名判断
        groupNames() {
            return this.innerGroupData
                .filter(item => {
                    return item.isParentNode;
                })
                .map(item => item[this.labelName]);
        },

        /**
         * 源列表数据监听
         *
         * @return {Array}
         */
        sourceData() {
            // 初始化数据
            let _treeData = _.cloneDeep(this.dataSource);

            // 对于顶级节点加入父级 ID 值
            _treeData.forEach(item => {
                item[this.pidName] = 0;
            });

            // 构造除去选中值 `this.selectedKeyValue` 的源数据
            return this.constructTreeBox(this.selectedKeyValue, _treeData);
        },

        /**
         * 目标列表数据监听
         *
         */
        targetData() {
            // 初始化数据
            let tmpData = _.cloneDeep(this.innerGroupData);
            let _treeData = tmpData.filter(item => !item.disabled);

            // 对于顶级节点加入父级 ID 值
            _treeData.forEach(item => {
                item[this.pidName] = 0;
            });

            // 构造除去反向选中值 `this.unselectedKeyValue` 的目标树数据
            return this.constructTreeBox(this.unselectedKeyValue, _treeData);
        },

        /**
         * 接收列表数据
         *
         * @return {Array}
         */
        acceptData() {
            // 初始化数据
            let _treeData = _.cloneDeep(this.dataSource);

            // 目标列表数据
            let _selectedList = [];

            // 获取选中值列表选项数据
            this.constructListBox(this.value, _treeData, _selectedList);

            return _selectedList;
        },

        /**
         * 查找所有选中的 key 值
         *
         * @return {Array}
         */
        selectedKeyValue() {
            // 初始化
            let _treeData = _.cloneDeep(this.dataSource);
            let _selectedKey = _.cloneDeep(this.value);
            let self = this;

            // 递归获取选中的 key 值（包含父级的）
            function getSelectedKeyValue(data, key) {
                // 初始化数据
                let _treeData = _.cloneDeep(data);

                _treeData.map(base => {
                    // 检测子节点数据是否存在
                    if (base[self.childrenName] && base[self.childrenName].length > 0) {
                        // 若存在，则进行递归，获取子节点
                        getSelectedKeyValue(base[self.childrenName], base[self.valueName]);
                    }

                    return base;
                });

                // 计算同级的数量
                let _count = 0;
                _selectedKey.forEach(item => {
                    data.forEach(child => {
                        if (child[self.valueName] === item) {
                            _count++;
                        }
                    });
                });

                // 加入父级 key 值
                if (_count === data.length && key) {
                    _selectedKey.push(key);
                }
            }

            // 执行方法
            getSelectedKeyValue(_treeData, undefined);

            return _selectedKey;
        },

        /**
         * 查找所有未选中的 key 值
         *
         * @return {Array}
         */
        unselectedKeyValue() {
            // 初始化
            let _treeData = _.cloneDeep(this.dataSource);
            let _selectedKey = _.difference(this.allKeyValue(true), this.selectedKeyValue);
            let self = this;

            // 递归获取选中的 key 值（包含父级的）
            function getSelectedKeyValue(data, key) {
                // 初始化数据
                let _treeData = _.cloneDeep(data);

                _treeData.map(base => {
                    // 检测子节点数据是否存在
                    if (base[self.childrenName] && base[self.childrenName].length > 0) {
                        // 若存在，则进行递归，获取子节点
                        getSelectedKeyValue(base[self.childrenName], base[self.valueName]);
                    }

                    return base;
                });

                // 计算同级的数量
                let _count = 0;
                _selectedKey.forEach(item => {
                    data.forEach(child => {
                        if (child[self.valueName] === item) {
                            _count++;
                        }
                    });
                });

                // 加入父级 key 值
                if (_count === data.length && key) {
                    _selectedKey.push(key);
                }
            }

            // 执行方法
            getSelectedKeyValue(_treeData, undefined);

            return _selectedKey;
        },

        /**
         * 检测按钮文本值
         *
         */
        hasButtonTexts() {
            return this.buttonTexts.length === 2;
        },

        returnGroupData() {
            let { labelName, valueName } = this;
            return this.innerGroupData.map(group => {
                let result = {
                    id: group.id,
                    [valueName]: group[valueName],
                    [labelName]: group[labelName],
                    order: group.order,
                    disabled: group.originDisabled,
                    children:
                        group.children &&
                        group.children.map(child => {
                            return {
                                [valueName]: child[valueName].split('---')[1],
                                [labelName]: child[labelName],
                                disabled: child.disabledBak
                            };
                        })
                };
                return result;
            });
        }
    },

    watch: {
        groupData: {
            deep: true,
            handler(val) {
                if (!this.hasGroupEditing) {
                    this.initOver = false;
                    this._initInnerGroupData(val);
                }
            }
        },
        innerGroupData: {
            deep: true,
            immediate: false,
            handler(val) {
                this.innerGroupTree = val;
                this.initOver && this.$emit('group-tree-change', this.returnGroupData);
            }
        },
        // 监听数据
        data: {
            deep: true,
            immediate: true,
            handler(val) {
                this.dataSource = val;
            }
        },
        // 目标列表数据 状态检测
        acceptCheckedKeys(val) {
            if (val.length > 0) {
                // 穿梭按钮是否禁用
                this.targetDisabled = false;
                // 总半选是否开启
                this.targetIsIndeterminate = true;

                // 总全选是否开启 - 根据选中节点中为根节点的数量是否和源数据长度相等
                let allCheck = val;
                if (allCheck.length == this.acceptData.length) {
                    // 关闭半选 开启全选
                    this.targetIsIndeterminate = false;
                    this.targetCheckAll = true;
                } else {
                    this.targetIsIndeterminate = true;
                    this.targetCheckAll = false;
                }
            } else {
                this.targetDisabled = true;
                this.targetIsIndeterminate = false;
                this.targetCheckAll = false;
            }
        },
        // 源数据 状态监测
        sourceCheckKeys(val) {
            if (val.length > 0) {
                if (this.targetCheckKeys.length > 0) {
                    // 穿梭按钮是否禁用
                    this.sourceDisabled = false;
                }
                // 总半选是否开启
                this.sourceIsIndeterminate = true;

                // 默认数据个数
                let data = this.allKeyValue(true, this.sourceData);
                if (this.allTreeProps.lazy) {
                    data = Object.keys(this.$refs['from-tree'].store.nodesMap);
                }

                if (val.length == data.length) {
                    // 关闭半选 开启全选
                    this.sourceIsIndeterminate = false;
                    this.sourceCheckAll = true;
                } else {
                    this.sourceIsIndeterminate = true;
                    this.sourceCheckAll = false;
                }
            } else {
                this.sourceDisabled = true;
                this.sourceIsIndeterminate = false;
                this.sourceCheckAll = false;
            }
        },
        // 目标树数据 状态监测
        targetCheckKeys(val) {
            if (this.sourceCheckKeys.length > 0) {
                // 穿梭按钮是否禁用
                this.sourceDisabled = false;
            }
            // 穿梭按钮是否禁用
            this.targetDisabled = false;
            // 总半选是否开启
            this.targetIsIndeterminate = true;

            // 不选中时， 全部关闭
            if (val.length <= 0) {
                this.sourceDisabled = true;
                this.targetDisabled = true;
                this.targetIsIndeterminate = false;
                this.targetCheckAll = false;
                return;
            }

            // 树形类型
            // 总全选是否开启 - 根据选中节点中为根节点的数量是否和源数据长度相等
            let allCheck = val.filter(item => !item.disabled && item.isParentNode);
            if (allCheck.length == this.targetData.length) {
                // 关闭半选 开启全选
                this.targetIsIndeterminate = false;
                this.targetCheckAll = true;
            } else {
                this.targetIsIndeterminate = true;
                this.targetCheckAll = false;
            }
        },
        // 左侧 数据筛选
        filterFrom(val) {
            this.$refs['from-tree'].filter(val);
        },
        // 右侧 数据筛选（目前未对目标列表数据做筛选）
        filterTo(val) {
            this.$refs['to-tree'].filter(val);
        }
    },
    directives: {
        focus: {
            inserted: function(el, { expression }, vnode) {
                setTimeout(() => {
                    el.getElementsByTagName('input')[0].focus();
                }, 200);
            }
        }
    },

    components: {
        ElTransfer: Transfer
    },

    methods: {
        /**
         * 分组名称编辑状态下阻止拖动事件
         */
        handleBeforeDrag() {
            return !this.hasGroupEditing;
        },
        handleToNodeCollapse(data, node) {
            delete this.toTreeExpendNodes[data.id];
        },
        handleToNodeExpend(data, node) {
            this.toTreeExpendNodes[data.id] = true;
        },
        /**
         *
         */
        handleChangeNodeId(groupData) {
            this._initInnerGroupData(groupData);
        },
        /**
         * 拖拽完成事件
         */
        handleAfterNodeDrop() {
            this._sortNode();
        },
        /**
         * 分组树排序
         */
        _sortNode() {
            let result = [];
            this.$refs['to-tree'].data.map((group, index) => {
                group.order = index;
            });
            result = JSON.parse(JSON.stringify(this.returnGroupData));
            this.$emit('after-drag', result);
        },
        /**
         * 生成uuid
         */
        guid2() {
            function S4() {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            }
            return S4() + S4() + S4() + S4() + S4() + S4() + S4() + S4();
        },
        /**
         * 新增分组
         */
        handleAddGroup(data) {
            if (!this.hasGroupEditing) {
                const { valueName, labelName } = this;
                this.nodeStatus = '1';
                data.isEditing = true;
                this.hasGroupEditing = true;
                const newNode = {
                    [valueName]: this.guid2(),
                    isEditing: true,
                    isParentNode: true,
                    pid: 0,
                    [labelName]: '新增分组',
                    children: []
                };
                this.innerGroupData.push(newNode);
                this.$emit('add-group', newNode);
            }
        },

        /**
         * 将父节点数据转为待保存的格式
         */
        _getGroupData(parent, op) {
            const { valueName, labelName } = this;
            return {
                [valueName]: parent[valueName],
                [labelName]: parent[labelName],
                op: op,
                order: parent.order == undefined ? '0' : parent.order,
                disabled: parent.disabled || false,
                children: parent.children.map(child => {
                    let id = child[valueName];
                    if (id.includes('---')) {
                        id = id.split('---')[1];
                    }

                    return {
                        [valueName]: id,
                        [labelName]: child[labelName]
                    };
                })
            };
        },

        /**
         * 批量删除分组
         */
        handleBatchDel() {
            this.targetCheckAll = false;
            const delNodes = this.$refs['to-tree'].getCheckedNodes();
            delNodes.map(item => {
                let toTree = this.$refs['to-tree'];
                let delNode = toTree.getNode(item);
                const parent = delNode && delNode.parent;
                toTree.remove(item);
                if (item.isParentNode) {
                    this.$emit('delete-group', item.id);
                    this._sortNode();
                } else if (parent && parent.data) {
                    let result = this._getGroupData(parent.data, 'edit');
                    this.$emit('save-group', JSON.parse(JSON.stringify(result)));
                }
                this.targetCheckAll = false;
                this.targetIsIndeterminate = false;
            });
        },

        /**
         * 点击分类节点删除事件
         */
        handleDeleteNodeClick(node, data) {
            const parentNode = node.parent;
            const children = parentNode.data.children || parentNode.data;
            const index = children.findIndex(d => d.id === data.id);
            children.splice(index, 1);
            if (node.level == 2) {
                let result = this._getGroupData(parentNode.data || parentNode, 'edit');
                this.$emit('save-group', JSON.parse(JSON.stringify(result)));
            } else {
                this.$emit('delete-group', node.key);
                this._sortNode();
            }
        },

        /**
         * 鼠标进入分类节点事件
         * 显示删除按钮
         */
        handleMouseenter(node, e) {
            if (node.disabled) {
                return;
            }
            let $node = e.currentTarget;
            if (node.data.isParentNode && !node.data.isEditing) {
                $node.getElementsByClassName('edit-btn')[0].classList.toggle('show-btn', true);
            }
            const delBtns = $node.getElementsByClassName('del-btn');
            if (delBtns.length > 0) {
                delBtns[0].classList.toggle('show-btn', true);
            }
        },

        /**
         * 鼠标移出分类节点事件
         * 隐藏删除按钮
         */
        handleMouseleave(node, e) {
            if (node.disabled) {
                return;
            }
            let $node = e.currentTarget;
            if (node.data.isParentNode && !node.data.isEditing) {
                $node.getElementsByClassName('edit-btn')[0].classList.toggle('show-btn', false);
            }
            const delBtns = $node.getElementsByClassName('del-btn');
            if (delBtns.length > 0) {
                delBtns[0].classList.toggle('show-btn', false);
            }
        },

        /**
         * 鼠标双击分类节点
         * 将分类节点变为文本框
         */
        handleDbclick(node, data, e) {
            if (!this.hasGroupEditing) {
                data.isEditing = true;
                this.hasGroupEditing = true;
            }
            event.stopPropagation();
        },

        /**
         * 错误提示
         */

        _showErrorMsg(msg) {
            if (!this.errorMessageHandle) {
                this.errorMessageHandle = true;
                this.$message.error(msg);
                setTimeout(() => {
                    this.errorMessageHandle = false;
                }, 500);
            }
        },

        /**
         * 输入框失去焦点
         */
        handleInputBlur(data, e) {
            let op = 'edit';
            const _this = this;
            const groupName = data[_this.labelName];
            if (!groupName.trim()) {
                e.currentTarget.focus();
                this._showErrorMsg('分组名字不能为空或空白字符');
                return;
            }
            if (_this.groupNames.filter(item => item == groupName).length > 1) {
                e.currentTarget.focus();
                this._showErrorMsg('分组名字重复');
                return;
            } else {
                if (_this.nodeStatus == '1') {
                    op = 'add';
                    data.order = _this.groupData.length - 1;
                }
                data.isEditing = false;
                _this.nodeStatus = '2';
                _this.hasGroupEditing = false;
                if (_this.targetCheckAll) {
                    _this.$nextTick(() => {
                        _this.targetIsIndeterminate = true;
                    });
                }
            }

            let result = _this._getGroupData(data, op);
            _this.$emit('save-group', JSON.parse(JSON.stringify(result)));
        },
        /**
         * 判断是否可以将节点放置到
         */
        judgAllowDrop(draggingNode, dropNode, type) {
            if (draggingNode.disabled || dropNode.disabled) {
                return false;
            }
            if (type == 'inner') {
                if (dropNode.level == 1 && draggingNode.level == 2) {
                    return true;
                } else {
                    return false;
                }
            } else if (type == 'prev' || type == 'next') {
                if (dropNode.level == draggingNode.level) {
                    return true;
                } else {
                    return false;
                }
            }
        },

        /**
         * 加入右侧穿梭框
         *
         */
        addToTarget() {
            const fromNodes = this.$refs['from-tree'].getCheckedNodes();
            const toNodes = this.$refs['to-tree'].getCheckedNodes().concat(this.$refs['to-tree'].getHalfCheckedNodes());
            const _this = this;
            const needToCheck = [];
            toNodes.map(item => {
                if (item.isParentNode) {
                    const ids = item.children.map(item => item.id.split('---')[1]);

                    fromNodes.map(fromNode => {
                        if (ids.indexOf(fromNode.id) < 0) {
                            item.children.push({
                                ...fromNode,
                                id: item.id + '---' + fromNode.id,
                                children: []
                            });
                            needToCheck.push(item.id + '---' + fromNode.id);
                        }
                    });
                    let result = _this._getGroupData(item, 'edit');
                    _this.$emit('save-group', JSON.parse(JSON.stringify(result)));
                } else {
                    needToCheck.push(item.id);
                }
            });
            _this.$nextTick(() => {
                Object.keys(_this.toTreeExpendNodes).map(item => {
                    _this.$refs['to-tree'].getNode(item).expanded = true;
                });
                _this.$refs['to-tree'].setCheckedKeys(needToCheck);
            });
        },

        /**
         * 源列表数据全选改变状态
         *
         * @param val
         */
        sourceAllBoxCheck(val) {
            // if (this.allTreeProps.lazy && val) {
            //     let data = Object.keys(this.$refs["from-tree"].store.nodesMap)
            //     this.sourceIsIndeterminate = false;
            //     this.$refs['from-tree'].setCheckedKeys(data);
            // } else {
            //     this.$refs['from-tree'].setCheckedKeys([]);
            // }
            // if (this.sourceData.length == 0) {
            //     return;
            // }
            // if (val) {
            //     this.sourceCheckKeys = this.sourceData;
            //     this.$refs['from-tree'].setCheckedNodes(this.sourceData);
            // } else {
            //     this.$refs['from-tree'].setCheckedNodes([]);
            //     this.sourceCheckKeys = [];
            // }

            let sourceCheckKeys;
            if (this.allTreeProps.lazy) {
                sourceCheckKeys = Object.keys(this.$refs['from-tree'].store.nodesMap);
                this.sourceIsIndeterminate = false;
            } else {
                sourceCheckKeys = this.sourceData;
            }

            this._changeFromTreeCheckStatus(val ? sourceCheckKeys : []);
        },

        /**
         * 改变元数据树节点勾选状态
         */

        _changeFromTreeCheckStatus(sourceCheckKeys) {
            this.sourceCheckKeys = sourceCheckKeys;
            this.$refs['from-tree'].setCheckedKeys(sourceCheckKeys);
        },

        /**
         * 目标列表数据全选改变状态
         *
         * @param val
         */
        targetAllBoxCheck(val) {
            if (this.targetData.length == 0) {
                return;
            }
            if (val) {
                this.targetCheckKeys = this.targetData;
                this.$refs['to-tree'].setCheckedNodes(this.innerGroupData);
            } else {
                this.$refs['to-tree'].setCheckedNodes([]);
                this.targetCheckKeys = [];
            }
        },
        /**
         * 源列表数据选中事件 - 是否禁用穿梭按钮
         *
         * @param nodeObj
         * @param treeObj
         */
        sourceTreeChecked(nodeObj, treeObj) {
            // 查找父节点
            let pids = treeObj.checkedNodes.map(p => p[this.pidName]);

            // 过滤后的元素
            let filterKeys = _.difference(treeObj.checkedKeys, pids);
            this.sourceCheckKeys = filterKeys;

            this.$emit('left-check-change', nodeObj, treeObj);
        },

        /**
         * 源列表数据 筛选
         *
         */
        filterNodeFrom(value, data) {
            // 支持自定义过滤事件
            if (this.$attrs['filter-node-from']) {
                return this.$attrs['filter-node-from'](value, data);
            }

            if (!value) return true;
            return data[this.treeProps.label].indexOf(value) !== -1;
        },
        /**
         * 目标列表数据 筛选
         *
         * @param value
         * @param data
         */
        filterNodeTo(value, data) {
            // 支持自定义过滤事件
            if (this.$attrs['filter-node-to']) {
                return this.$attrs['filter-node-to'](value, data);
            }

            if (!value) return true;
            return data[this.treeProps.label].indexOf(value) !== -1;
        },
        // 目标树选中事件 - 是否禁用穿梭按钮
        toTreeChecked(nodeObj, treeObj) {
            this.targetCheckKeys = treeObj.checkedNodes;
            this.$emit('right-check-change', nodeObj, treeObj);
        },
        /**
         * 递归函数 获取目标树结构数据
         *
         * @param value
         * @param data
         * @return {*}
         */
        constructTreeBox(value, data) {
            // 初始化数据
            let self = this;

            // 检测数据数组
            if (data.length === 0 || value.length === 0) return data;

            // 遍历数据结构
            let _data = data.map(base => {
                // 检测子节点数据是否存在
                if (base[self.childrenName] && base[self.childrenName].length > 0) {
                    // 若存在，则进行递归，获取子节点
                    base[self.childrenName] = self.constructTreeBox(value, base[self.childrenName]);
                }

                return base;
            });

            // 过滤数据
            value.forEach(item => {
                _data = _data.filter(base => base[self.valueName] !== item);
            });

            return _data;
        },
        /**
         * 查找所有的 key 值
         *
         * @param val [Boolean] true/false
         * @param val [Array] data
         */
        allKeyValue(val, data) {
            // 初始化
            let _treeData = data ? _.cloneDeep(data) : _.cloneDeep(this.dataSource);
            let _treeAllKey = [];
            let self = this;

            // 递归获取所有的 key 值
            function getAllKeyValue(data) {
                // 初始化数据
                let _treeData = _.cloneDeep(data);

                _treeData.map(base => {
                    // 检测子节点数据是否存在
                    if (base[self.childrenName] && base[self.childrenName].length > 0) {
                        // 若存在，则进行递归，获取子节点
                        getAllKeyValue(base[self.childrenName]);
                    }

                    return base;
                });

                data.forEach(item => {
                    if (val) {
                        if (item[self.childrenName] && item[self.childrenName].length === 0) {
                            _treeAllKey.push(item[self.valueName]);
                        }
                    } else {
                        _treeAllKey.push(item[self.valueName]);
                    }
                });
            }

            // 执行方法
            getAllKeyValue(_treeData);

            return _treeAllKey;
        },
        /**
         * 构建目标列表数据
         *
         * @param value
         * @param data
         * @return {*}
         */
        constructListBox(value, data, selectedList) {
            // 初始化数据
            let self = this;

            // 检测数据数组
            if (data.length === 0 || value.length === 0) return [];

            // 遍历数据结构
            let _data = data.map(base => {
                // 检测子节点数据是否存在
                if (base[self.childrenName] && base[self.childrenName].length > 0) {
                    // 若存在，则进行递归，获取子节点
                    base[self.childrenName] = self.constructListBox(value, base[self.childrenName], selectedList);
                }

                return base;
            });

            // 过滤数据
            value.forEach(item => {
                _data.forEach(base => {
                    if (base[self.valueName] === item) {
                        selectedList.push(base);
                    }
                });
            });

            return _data;
        },
        _initInnerGroupData(data) {
            const _this = this;
            _this.innerGroupData = _.cloneDeep(data || _this.groupData);
            _this.innerGroupData.map(item => {
                item.isParentNode = true;
                item.disabled = item.originDisabled;
                item.children.map(child => {
                    child.disabledBak = child.disabled;
                    child.disabled = item.disabled;
                });
                _this.$set(item, 'isEditing', false);
            });
            _this.$nextTick(() => {
                const keys = this.targetCheckKeys.map(item => item.id);
                _this.initOver = true;
                _this.$refs['to-tree'].setCheckedKeys(keys);
                Object.keys(_this.toTreeExpendNodes).map(item => {
                    _this.$refs['to-tree'].getNode(item).expanded = true;
                });
            });
        }
    },

    created() {
        const _this = this;
        this._initInnerGroupData();

        _this.sourceCheckKeys = _this.leftDefaultChecked;
        _this.targetCheckKeys = _this.rightDefaultChecked;
    }
};
</script>
