<script>
import { Tag as ElTag } from 'element-ui';
import objectAssign from 'main/utils/merge';

export default {
    name: 'DgTag',

    mixins: [ElTag],

    props: {
        // 自定 icon 样式
        iconClass: String,
        iconStyle: {
            type: Object,
            default() {
                return {};
            }
        },
        // 是否带边框
        isBorder: {
            type: Boolean,
            default: true
        },
        // 是否禁用
        disabled: {
            type: Boolean,
            default: false
        },
        // 是否当前选中 
        isSelect: Boolean,
        // 当前选中的样式
        selectClass: String,
        selectStyle: {
            type: Object,
            default() {
                return {};
            }
        },
        // 自定义颜色
        customColor: Boolean,
        // 自定义样式
        customStyle: {
            type: Object,
            default() {
                return {};
            }
        }
    },

    methods: {
        handleClose(event) {
            // disabled 状态
            if (this.disabled) {
                return;
            }
            event.stopPropagation();
            this.$emit('close', event);
        },
        handleClick(event) {
            // disabled 状态
            if (this.disabled) {
                return;
            }
            this.$emit('click', event);
        },
        toRgba(plainColor) {
            const a = 0.08;
            const hexReg = /^\#[a-fA-f0-9]{6}$/;
            const rgbReg = /^rgb\((\s*[1-2]?[0-9]?[0-9]{1}\,)(\s*[1-2]?[0-9]?[0-9]{1}\,)(\s*[1-2]?[0-9]?[0-9]{1})\)$/;
            // 将 16 进制转换成 rgba
            if (hexReg.test(plainColor)) {
                let rgbaColor = 'rgba(';
                for (let i = 1; i < plainColor.length; i += 2) {
                    const str = plainColor[i] + plainColor[i + 1];
                    if (i < 5) {
                        rgbaColor += parseInt(str, 16) + ',';
                    } else {
                        rgbaColor += parseInt(str, 16) + `,${a})`;
                    }
                }
                return rgbaColor;
            } else if (rgbReg.test(plainColor)) {
                // 'rgb(222,33,44)'.slice(0,-1) => "rgb(222,33,44" + `,${a})`
                return plainColor.slice(0, -1) + `,${a})`;
            }
            return plainColor;
        }
    },

    render(h) {
        const {
            type,
            color,
            tagSize,
            hit,
            effect,
            disabled,
            isSelect,
            selectClass,
            selectStyle,
            isBorder,
            customColor,
            customStyle,
            iconClass
        } = this;
        const classes = [
            'el-tag',
            'dg-tag',
            type ? `el-tag--${type}` : '',
            tagSize ? `el-tag--${tagSize}` : '',
            effect ? `el-tag--${effect}` : '',
            hit && 'is-hit',
            iconClass ? 'dg-tag--icon' : '',
            isBorder && 'is-border',
            disabled && 'is-disabled',
            isSelect && selectClass ? selectClass : ''
        ];
        const sty = !disabled ? { backgroundColor: color } : {};
        // If effect === 'plain' && color && !diabled; 将 color 转变成 color 和 border-color 的样式结构
        if (customColor && color && !disabled) {
            if (effect === 'plain') {
                sty.color = color;
                sty.borderColor = color;
                sty.backgroundColor = 'white';
            } else if (effect === 'light') {
                sty.color = color;
                sty.borderColor = color;
                sty.backgroundColor = this.toRgba(color);
            } else if (effect === 'dark') {
                sty.color = 'white';
                sty.borderColor = 'transparent';
                sty.backgroundColor = color;
            }
        }
        const selectes = isSelect && selectStyle ? objectAssign(sty, selectStyle) : sty;
        // 自定义 style, 优先级低于 select
        const styles = objectAssign(customStyle, selectes);
        const tagEl = (
            <span class={classes} style={isSelect ? styles : sty} on-click={this.handleClick}>
                {this.iconClass ? <i class={['dg-tag__icon', this.iconClass]} style={this.iconStyle}></i> : null}
                {this.$slots.default}
                {this.closable && <i class="el-tag__close el-icon-close" on-click={this.handleClose}></i>}
            </span>
        );

        return this.disableTransitions ? tagEl : <transition name="el-zoom-in-center">{tagEl}</transition>;
    }
};
</script>
