<!--
    表格组件
    @Author: tangDM
    @Date: 2019-03-06
-->
<template>
    <div class="dg-table">
        <!-- 表格区域 -->
        <div class="dg-table__content">
            <el-table ref="grid" :class="[ renderData.length === 0 && !$attrs.border ? 'is-hidden-border-bottom': '' ]"
                v-bind="attrs" v-on="$listeners" v-loading="loadding" :data="renderData" :row-key="rowKey" :prop="prop"
                :border="border" @selection-change="handleSelectItem" @sort-change="handleSortChange">
                <slot></slot>
                <!-- 拓传插槽 -->
                <template slot="empty">
                    <slot name="empty"></slot>
                </template>
                <slot name="append"></slot>
            </el-table>
        </div>

        <!-- 分页区域 -->
        <template v-if="pagination && renderData.length > 0">
            <el-pagination class="dg-table__pagination" v-bind="paginationOptions" @size-change="handleSizeChange"
                @current-change="handleCurrentChange" @prev-click="handlePrevClick" @next-click="handleNextClick">
            </el-pagination>
        </template>
        <template v-else>
            <slot name="pagination"></slot>
        </template>
    </div>
</template>

<script>
    import _ from 'lodash';
    // info views by https://github.com/SortableJS/Sortable
    import Sortable from 'sortablejs';
    import { Table, Pagination } from 'element-ui';
    import getAutoPageSize from './autoPageSize';
    import objectAssign from 'main/utils/merge';
    import getChildrenRefs from 'main/dg-utils/children.refs.js';
    import { getCmpProps } from 'main/dg-utils/shear.js';

    let TableRefs = getChildrenRefs(Table, 'grid');

    export default {
        name: 'DgTable',

        provide() {
            return {
                overflow: this.overflow,
                paginationOptions: this.paginationOptions
            };
        },

        props: {
            // 透传属性
            // ElTable.ElTableBody 使用<DgTableSelect :prop="defaultProp" />
            prop: Object,
            // 默认数据
            data: {
                type: Array,
                default: () => []
            },
            // 分页类型 client | server
            pagingType: {
                type: String,
                default: 'server',
                validator: function (val) {
                    return ['client', 'server'].indexOf(val) !== -1;
                }
            },
            // 是否可拖拽
            draggable: {
                type: Boolean,
                default: false
            },
            // 拖拽配置项
            dragProps: {
                type: Object,
                default: () => { }
            },
            // 是否开启分页
            pagination: {
                type: Boolean,
                default: true
            },
            // 分页配置参数
            paginationProps: {
                type: Object,
                default: () => { }
            },
            // 总条数
            paginationTotal: {
                type: Number,
                default: 10
            },
            // 开启是否自动计算分页条数
            autoPage: {
                type: [String, Function]
            },
            border: {
                type: Boolean,
                default: false
            },
            // 行 ID 名称
            rowKey: {
                type: [Function, String],
                default: 'id'
            },
            loading: {
                type: Boolean,
                default: false
            },
            overflow: {
                // tooltip、wrap、origin
                type: String,
                default: 'tooltip'
            },
            // 复选框默认选中值
            selectDefault: {
                type: [Number, String, Array]
            },
            // 若 selectDefault为String时的分隔符
            seq: {
                type: String,
                default: ','
            },
            tableDraggable: {
                type: Boolean,
                default: false
            }
        },

        data() {
            return {
                orignData: [],
                sortColumn: {},
                loadding: this.loading,
                // 默认数据
                dataSource: this.data,
                dataClient: this.data,
                // 拖拽对象
                sortable: null,
                // 分页参数配置
                paginationOptions: {
                    currentPage: 1,
                    pageSizes: [10, 20, 30],
                    pageSize: 10,
                    layout: 'total, sizes, prev, pager, next, jumper',
                    total: this.paginationTotal
                },
                // 当前分页选中值
                currentSelected: []
            };
        },

        computed: {
            renderData() {
                if (this.pagination == true && this.pagingType === 'client') {
                    const column = this.sortColumn;
                    const { pageSize, currentPage } = this.paginationOptions;
                    const start = (currentPage - 1) * pageSize;

                    let tmpData = [];
                    if (!column.order) {
                        tmpData = this.dataClient;
                    } else if (column.order === 'ascending') {
                        tmpData = _.sortBy(this.dataClient, item => item[column.property]);
                    } else if (column.order === 'descending') {
                        tmpData = _.sortBy(this.dataClient, item => -item[column.property]);
                    }

                    this.dataSource = tmpData.slice(start, start + pageSize);
                } else if (this.pagination == false && this.pagingType === 'client') {
                    this.dataSource = this.dataClient;
                }
                return this.dataSource;
            },

            // 拖拽参数配置
            dragOptions() {
                return objectAssign(
                    {
                        ghostClass: 'dg-table__placeholder',
                        dragClass: 'dg-table__placeholder',
                        chosenClass: 'dg-table__placeholder',
                        setData: this.handleDragSetData,
                        onEnd: this.handleDragOnEnd
                    },
                    this.dragProps
                );
            },

            attrs() {
                return { ...getCmpProps(Table, this), draggable: this.tableDraggable };

            }
        },

        watch: {
            selectDefault: {
                deep: true,
                immediate: true,
                handler(val = []) {
                    const { seq } = this;
                    let check = val;
                    if (_.isString(val)) {
                        // isString
                        check = val.split(seq);
                    } else if (_.isNumber(val)) {
                        // isNumber
                        check = [val];
                    }
                    this.currentSelected = _.uniq(check);
                }
            },
            // 监听数据
            data: {
                deep: true,
                immediate: true,
                handler(data, oldData) {
                    if (this.pagingType == 'client') {
                        this.orignData = data;
                        this.dataClient = data;
                        let totalPage = Math.ceil(data.length / this.paginationOptions.pageSize);
                        if (totalPage < this.paginationOptions.currentPage) {
                            this.paginationOptions.currentPage = totalPage || 1;
                        }
                        this.paginationOptions.total = data.length;
                    } else {
                        this.dataSource = data;
                    }
                    // 客户端数据且没有分页
                    if (!this.pagination && this.pagingType === 'client') {
                        this.dataSource = this.dataClient;
                    }
                }
            },
            paginationTotal: {
                handler: function handler(val) {
                    this.paginationOptions.total = val;
                }
            },
            paginationProps: {
                deep: true,
                immediate: true,
                handler(val) {
                    let total = this.paginationOptions.total;
                    this.pagingType === 'client' && (total = this.dataClient.length)
                    if (this.autoPage) {
                        let _pageSizes = getAutoPageSize(this.autoPage, total);
                        this.paginationOptions = objectAssign({
                            currentPage: 1,
                            pageSizes: _pageSizes,
                            pageSize: _pageSizes[0],
                            layout: 'total, sizes, prev, pager, next, jumper',
                            total: total
                        });
                    } else {
                        this.paginationOptions = objectAssign(
                            {
                                currentPage: 1,
                                pageSizes: [10, 20, 30],
                                pageSize: 10,
                                layout: 'total, sizes, prev, pager, next, jumper',
                                total: total
                            }, val);
                    }
                    if (!this.paginationOptions.pageSizes.includes(this.paginationOptions.pageSize)) {
                        this.paginationOptions.pageSizes.unshift(this.paginationOptions.pageSize)
                    }
                }
            },
            // 监听服务端数据
            dataSource: {
                immediate: true,
                deep: true,
                handler(val) {
                    // 选中
                    this.handleDefCheck();
                    this.$emit('change-data', val);
                }
            }
        },

        components: {
            ElTable: Table,
            ElPagination: Pagination
        },

        methods: {
            changeLoading() {
                this.loadding = !this.loadding;
            },

            /**
             * 拖拽操作
             *
             */
            handleSortTable() {
                const el = this.$refs.grid.$el.querySelectorAll('.el-table__body-wrapper > table > tbody')[0];
                this.sortable = Sortable.create(el, this.dragOptions);
            },

            /**
             * 拖拽配置参数
             * @param dataTransfer
             */
            handleDragSetData(dataTransfer) {
                dataTransfer.setData('Text', '');
            },

            /**
             * 拖拽显示排序
             * @param evt
             */
            handleDragOnEnd(evt) {
                let data = this.pagingType === 'client' ? this.dataClient : this.dataSource;
                const targetRow = data.splice(evt.oldIndex, 1)[0];
                data.splice(evt.newIndex, 0, targetRow);

                // 拖拽回传数据
                this.$emit('drag-end', data);
            },

            /**
             * 页数值改变方法
             *
             * @param evt
             */
            handleSizeChange(val) {
                this.paginationOptions.pageSize = val;
                this.paginationOptions.currentPage = 1;
                this.$emit('change-size', val);
            },

            /**
             * 当前页改变方法
             *
             * @param evt
             */
            handleCurrentChange(val) {
                this.paginationOptions.currentPage = val;
                this.$emit('change-current', val);
            },

            /**
             * 排序改变方法
             */
            handleSortChange({ column, prop, order }) {
                column && (this.sortColumn = column);
                // this.$emit('sort-change', { column, prop, order });
                this._handleSortChange({ column, prop, order });
            },

            _handleSortChange() { },

            /**
             * 点击上一页
             *
             * @param evt
             */
            handlePrevClick(val) {
                this.$emit('click-prev', val);
            },

            /**
             * 点击下一页
             *
             * @param evt
             */
            handleNextClick(val) {
                this.$emit('click-next', val);
            },

            // /**
            //  * 选择选项值
            //  */
            // handleSelectItem(val) {
            //     // 当前页选中值
            //     this.currentSelected = val;
            // },
            /* type="selection" start */
            // 复选框操作
            handleSelectItem(val) {
                const { currentSelected, dataSource, rowKey } = this;
                const key = _.isString(rowKey) ? rowKey : 'id';
                const check = val.map(item => item[key]);
                // 当前页面 key 集合
                const dataId = dataSource.map(item => item[key]);
                // 展示页面中不存在，但却选中的 key
                const beforeSelect = currentSelected.filter(item => !_.includes(dataId, item)) || [];
                // 当前页选中值
                this.currentSelected = _.uniq([...check, ...beforeSelect]);
            },

            // 动态变化多次需要用时间获取
            getCheck() {
                return this.currentSelected;
            },

            // 勾选值(当前显示页、其他显示页)
            setCheck(rows) {
                const { rowKey, dataSource, currentSelected } = this;
                const key = _.isString(rowKey) ? rowKey : 'id';
                // 去除已经选中的，若没有此代码选中状态会被取消
                rows = _.difference(rows, currentSelected);
                // 当前页面需要勾选的
                const currentCheck = dataSource.filter(item => _.includes(rows, item[key]));
                if (currentCheck && currentCheck.length) {
                    currentCheck.forEach(row => this.$refs.grid.toggleRowSelection(row, true));
                }
                // 其他显示页
                const otherCheck = _.difference(rows, currentCheck);
                this.currentSelected = _.uniq([...currentSelected, ...otherCheck]);
            },

            // 清空所有选中
            clearAll() {
                this.$refs.grid.clearSelection();
                this.currentSelected = [];
            },

            // 默认选中
            handleDefCheck() {
                if (this.selectDefault === void 0) {
                    return;
                }

                const { currentSelected, rowKey, dataSource, typeSelect } = this;
                const key = _.isString(rowKey) ? rowKey : 'id';

                // 兼容 reserve-selection 属性
                if (typeSelect) {
                    this.$nextTick(() => {
                        const { dataClient } = this;
                        const client = dataClient.filter(item => _.includes(currentSelected, item[key]));
                        client.forEach(row => this.$refs.grid.toggleRowSelection(row, true));
                    });
                    return;
                }

                if (currentSelected && currentSelected.length) {
                    // IF _.isFunction => 'id'
                    this.$nextTick(() => {
                        const currentSelect = dataSource.filter(item => _.includes(currentSelected, item[key]));
                        currentSelect.forEach(row => this.$refs.grid.toggleRowSelection(row, true));
                    });
                }
            },
            /* type="selection" end */
            ...TableRefs
        },

        created() {
            // 初始化执行
            if (this.draggable) {
                this.$nextTick(() => {
                    // 拖拽操作
                    this.handleSortTable();
                });
            }

            // 分页配置
            if (!this.pagination) {
                return;
            }

        }
    };
</script>