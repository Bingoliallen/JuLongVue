<template>
    <el-radio-group class="dg-radio-group" v-model="val" :disabled="disabled" v-bind="$attrs" v-on="listeners">
        <template v-if="type === 'button'">
            <dg-radio-button
                v-for="(item, index) in itemsWithDisabled"
                :key="index"
                :call-of="callOff"
                :label="item[defaultProp.value]"
                :class="{ 'is-lace': isLace && !disabled }"
                :disabled="item[defaultProp.disabled]"
                >{{ item[defaultProp.label] }}</dg-radio-button
            >
        </template>
        <template v-else>
            <dg-radio
                :class="{ 'dg-radio-group__vertical': vertical }"
                v-for="(item, index) in itemsWithDisabled"
                :call-of="callOff"
                :key="index"
                :label="item[defaultProp.value]"
                :disabled="item[defaultProp.disabled]"
                >{{ item[defaultProp.label] }}</dg-radio
            >
        </template>
    </el-radio-group>
</template>

<script>
import DgRadio from 'packages/radio';
import DgRadioButton from 'packages/radio-button';
import { RadioGroup as ElRadioGroup } from 'element-ui';
import { filterObj } from 'main/dg-utils/shear.js';
import { data2type } from 'main/dg-utils/data-convert.js';
import itemsWithDisabled from 'main/dg-mixins/itemsWithDisabled.js';
import _ from 'lodash';

export default {
    name: 'DgRadioGroup',

    componentName: 'DgRadioGroup',

    mixins: [itemsWithDisabled],

    components: {
        ElRadioGroup,
        DgRadioButton,
        DgRadio
    },

    props: {
        // 默认选中值
        value: {
            required: true
        },
        disabled: Boolean,
        // 显示类型，默认为 radio 类型，可选项为 按钮类型
        type: {
            type: String,
            default: ''
        },
        // 是否垂直排列，按钮样式下无效
        vertical: {
            type: Boolean,
            default: false
        },
        // dg-radio callOff
        callOff: Boolean,
        // 是否花边展示
        isLace: {
            type: Boolean,
            default: false
        }
    },

    computed: {
        val: {
            get() {
                const { value, seq } = this;
                return data2type(value, 'String', seq);
            },
            set(val) {
                this.hookData(val);
            }
        },

        /* 创建原因：
          input 触发两次且值与 output-format 不同
          change 触发两次
        */
        listeners() {
            return filterObj(this.$listeners, ['input', 'change']);
        }
    },

    methods: {
        // 触发 input、change 事件
        hookData(val) {
            const { outputFormat, seq, getLable } = this;
            this.$emit('input', data2type(val, outputFormat, seq), getLable(val));
            this.$emit('change', val, getLable(val));
        },
        // 用于获取当前选中的对象 { label, value }
        getLable(val) {
            const { itemsWithDisabled, defaultProp } = this;
            return _.find(itemsWithDisabled, item => val === item[defaultProp.value]);
        }
    },

    created() {
        this.$on('handleChange', val => {
            const { outputFormat, seq, value, callOff, getLable } = this;
            // call-off 关闭

            if (callOff) {
                return;
            }
            // 需要触发置空的 input、change 事件
            if (value !== '' && val === '') {
                this.$emit('input', data2type(val, outputFormat, seq), getLable(val));
                this.$emit('change', val, getLable(val));
            }
        });
        this.$on('handleClick', val => {
            this.$emit('has-click', val);
        });
    }
};
</script>
