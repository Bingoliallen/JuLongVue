<template>
    <el-select
        class="dg-select"
        v-model="model"
        v-bind="$attrs"
        v-on="$listeners"
        :group="group"
        :multiple="multiple"
        :data="itemsWithDisabled"
        :default-prop="defaultProp"
    >
      <template slot="prefix">
        <slot name="prefix"></slot>
      </template>
        <template v-if="hasSlots">
            <slot></slot>
        </template>
        <template v-else-if="group">
            <el-option-group v-for="item in groupItems" :key="item.label" :label="item.label">
                <el-option
                    v-for="child in item.options"
                    :key="child[defaultProp.value]"
                    :label="child[defaultProp.label]"
                    :value="child[defaultProp.value]"
                    :disabled="child[defaultProp.disabled]"
                ></el-option>
            </el-option-group>
        </template>
        <template v-else>
            <el-option
                v-for="item in itemsWithDisabled"
                :key="item[defaultProp.value]"
                :label="item[defaultProp.label]"
                :value="item[defaultProp.value]"
                :disabled="item[defaultProp.disabled]"
            ></el-option>
        </template>
    </el-select>
</template>

<script>
import { OptionGroup as ElOptionGroup, Option as ElOption } from 'element-ui';
import ElSelect from './select';
import ItemsWithDisabled from 'main/dg-mixins/itemsWithDisabled.js';
import { str2arr, data2type } from 'main/dg-utils/data-convert.js';

export default {
    name: 'DgSelect',

    mixins: [ItemsWithDisabled],

    components: {
        ElSelect,
        ElOptionGroup,
        ElOption
    },

    props: {
        // 默认选中值
        value: {
            required: true
        },
        // 是否分组
        group: {
            type: Boolean,
            default: false
        },
        // 分组字段名称
        groupName: {
            type: String,
            default: 'group'
        },
        // 多选
        multiple: {
            type: Boolean,
            default: false
        }
    },

    computed: {
        hasSlots() {
            return this.$slots && this.$slots.default && this.$slots.default.length > 0;
        },
        model: {
            get() {
                // 数据转换 mulitiple ? <Array> : <String>
                const { value, seq, multiple } = this;
                return multiple ? str2arr(value, seq) : data2type(value, 'String', seq);
            },
            set(val) {
                const { outputFormat, seq } = this;
                // this.$emit('input', data2type(val, outputFormat, seq));
            }
        },

        // 组装分组数据项
        // 例子：[{value：'1', label:'11', group:'A'}, {value：'2', label:'22', group:'A'}]
        //       => { label:'A', options：[{value:'1', label:'11'}, {value: '2', lable: '22'}]}
        groupItems() {
            const { groupName } = this;
            let groupObject = {},
                groupArray = [];
            this.itemsWithDisabled.forEach(item => {
                const groupVal = item[groupName];
                if (!groupObject[groupVal]) {
                    groupObject[groupVal] = { label: groupVal, options: [] };
                }
                groupObject[groupVal].options.push(item);
            });
            // 将对象转数组
            for (let key in groupObject) {
                groupArray.push(groupObject[key]);
            }
            return groupArray;
        }
    }
};
</script>
