<template>
  <div
    class="el-select"
    :class="[selectSize ? 'el-select--' + selectSize : '']"
    @click.stop="toggleMenu"
    v-clickoutside="handleClose"
  >
    <!-- update author: tangdm descript: add overflow: 'hidden' -->
    <div
      class="el-select__tags"
      v-if="multiple"
      ref="tags"
      :style="{ 'max-width': inputWidth - 32 + 'px', width: '100%', overflow: 'hidden' }"
    >
      <span v-if="collapseTags && selected.length">
        <el-tag
          :closable="!selectDisabled"
          :size="collapseTagSize"
          :hit="selected[0].hitState"
          @close="deleteTag($event, selected[0])"
          disable-transitions
        >
          <span class="el-select__tags-text" :title="selected[0].currentLabel">{{ selected[0].currentLabel }}</span>
        </el-tag>
        <el-tag
          v-if="selected.length > 1"
          :closable="false"
          :size="collapseTagSize"
          disable-transitions
        >
          <span class="el-select__tags-text">+ {{ selected.length - 1 }}</span>
        </el-tag>
      </span>
      <!-- update author: tangdm descript: add dragTags -->
      <transition-group
        @after-leave="resetInputHeight"
        v-if="!collapseTags && !dragTags"
      >
        <el-tag
          v-for="item in selected"
          :key="getValueKey(item)"
          :closable="!selectDisabled"
          :size="collapseTagSize"
          :hit="item.hitState"
          @close="deleteTag($event, item)"
          disable-transitions
        >
          <span class="el-select__tags-text" :title="item.currentLabel">{{ item.currentLabel }}</span>
        </el-tag>
      </transition-group>
      <!-- add author: tangdm descript: drag-tags content -->
      <transition
        @after-leave="resetInputHeight"
        v-if="!collapseTags && dragTags"
      >
        <div
          class="dg-drag-tags__content"
          ref="tagContent"
          :style="[{ width: tagItemLength + 'px' }]"
          @mousedown.stop="handleDragStart($event)"
        >
          <el-tag
            v-for="item in selected"
            :key="getValueKey(item)"
            :closable="!selectDisabled"
            :size="collapseTagSize"
            :hit="item.hitState"
            ref="tagItem"
            @close="deleteTag($event, item)"
            disable-transitions
          >
            <span class="el-select__tags-text" :title="item.currentLabel">{{ item.currentLabel }}</span>
          </el-tag>
        </div>
      </transition>
      <input
        type="text"
        class="el-select__input"
        :class="[selectSize ? `is-${selectSize}` : '']"
        :disabled="selectDisabled"
        :autocomplete="autoComplete || autocomplete"
        @focus="handleFocus"
        @blur="softFocus = false"
        @click.stop
        @keyup="managePlaceholder"
        @keydown="resetInputState"
        @keydown.down.prevent="navigateOptions('next')"
        @keydown.up.prevent="navigateOptions('prev')"
        @keydown.enter.prevent="selectOption"
        @keydown.esc.stop.prevent="visible = false"
        @keydown.delete="deletePrevTag"
        @compositionstart="handleComposition"
        @compositionupdate="handleComposition"
        @compositionend="handleComposition"
        v-model="query"
        @input="debouncedQueryChange"
        v-if="filterable"
        :style="{
                    'flex-grow': '1',
                    width: inputLength / (inputWidth - 32) + '%',
                    'max-width': inputWidth - 42 + 'px'
                }"
        ref="input"
      />
    </div>
    <el-input
      ref="reference"
      v-model="selectedLabel"
      type="text"
      :placeholder="currentPlaceholder"
      :name="name"
      :id="id"
      :autocomplete="autoComplete || autocomplete"
      :size="selectSize"
      :disabled="selectDisabled"
      :readonly="readonly"
      :validate-event="false"
      :class="{ 'is-focus': visible }"
      @focus="handleFocus"
      @blur="handleBlur"
      @keyup.native="debouncedOnInputChange"
      @keydown.native.down.stop.prevent="navigateOptions('next')"
      @keydown.native.up.stop.prevent="navigateOptions('prev')"
      @keydown.native.enter.prevent="selectOption"
      @keydown.native.esc.stop.prevent="visible = false"
      @keydown.native.tab="visible = false"
      @paste.native="debouncedOnInputChange"
      @mouseenter.native="inputHovering = true"
      @mouseleave.native="inputHovering = false"
    >
      <template
        slot="prefix"
        v-if="$slots.prefix"
      >
        <slot name="prefix"></slot>
      </template>
      <template slot="suffix">
        <i
          v-show="!showClose"
          :class="['el-select__caret', 'el-input__icon', 'el-icon-' + iconClass]"
        ></i>
        <i
          v-if="showClose"
          class="el-select__caret el-input__icon el-icon-circle-close"
          @click="handleClearClick"
        ></i>
      </template>
    </el-input>
    <transition
      name="el-zoom-in-top"
      @before-enter="handleMenuEnter"
      @after-leave="doDestroy"
    >
      <el-select-menu
        ref="popper"
        :append-to-body="popperAppendToBody"
        v-show="visible && emptyText !== false"
      >
        <el-scrollbar
          tag="ul"
          wrap-class="el-select-dropdown__wrap"
          view-class="el-select-dropdown__list"
          ref="scrollbar"
          :class="{ 'is-empty': !allowCreate && query && filteredOptionsCount === 0 }"
          v-show="options.length > 0 && !loading"
        >
          <el-option
            :value="query"
            created
            v-if="showNewOption"
          > </el-option>
          <slot></slot>
        </el-scrollbar>
        <template v-if="emptyText && (!allowCreate || loading || (allowCreate && options.length === 0))">
          <slot
            name="empty"
            v-if="$slots.empty"
          ></slot>
          <p
            class="el-select-dropdown__empty"
            v-else
          >
            {{ emptyText }}
          </p>
        </template>
      </el-select-menu>
    </transition>
  </div>
</template>

<script type="text/babel">
import { Select as ElSelect } from 'element-ui';
import debounce from 'throttle-debounce/debounce';
import { addResizeListener } from 'main/utils/resize-event.js';
import { complex } from 'main/dg-utils/shear.js';
import { valueEquals } from 'main/utils/util';
import _ from 'lodash';

// add author: tangdm descript: overwrite SelectMenu 's minWidth
ElSelect.components.ElSelectMenu.watch['$parent.inputWidth'] = function() {
    this.minWidth = Math.max(this.$parent.$el.getBoundingClientRect().width, this.$parent.$el.clientWidth) + 'px';
};

const Select = complex(ElSelect, ['created', 'mounted']);

export default {
    mixins: [Select],

    props: {
        // add author: tangdm
        dragTags: Boolean,
        defaultProp: Object
    },

    data() {
        return {
            // add author: tangdm descript: drag status for flag
            dragStatus: false,
            // add author: tangdm descript: count tag's item length
            tagItemLength: 0
        };
    },

    watch: {
        selectDisabled() {
            // create author:lutz describe:!multiple不渲染
            if (!this.multiple) {
                return;
            }
            this.$nextTick(() => {
                this.resetInputHeight();
            });
        },

        // add author: tangdm
        selected() {
            this.$nextTick(() => {
                // 检测判断标签值是否存在
                if (this.$refs.tagContent) {
                    this.$refs.tagContent.style.transform = 'translateX(0px)';
                }

                // 计算标签数量值的长度
                let count = 0;
                let tagItem = this.$refs.tagItem;
                if (tagItem) {
                    tagItem.forEach(item => {
                        count += item.$el.offsetWidth + 8;
                    });
                }
                this.tagItemLength = count;
            });
        }
    },

    methods: {
        resetInputHeight() {
            if (this.collapseTags && !this.filterable) return;
            this.$nextTick(() => {
                if (!this.$refs.reference) return;
                let inputChildNodes = this.$refs.reference.$el.childNodes;
                let input = [].filter.call(inputChildNodes, item => item.tagName === 'INPUT')[0];
                const tags = this.$refs.tags;
                const sizeInMap = this.initialInputHeight || 40;

                // update author: tangdm descript: 不同分辨率兼容高度问题
                // [code] input.style.height = this.selected.length === 0
                //        ? sizeInMap + 'px'
                //        : Math.max(
                //        tags ? (tags.clientHeight + (tags.clientHeight > sizeInMap ? 6 : 0)) : 0,
                //        sizeInMap
                // ) + 'px';

                input.style.height =
                    this.selected.length === 0
                        ? sizeInMap + 'px'
                        : Math.max(tags ? tags.clientHeight : 0, sizeInMap) + 'px';
                if (this.visible && this.emptyText !== false) {
                    this.broadcast('ElSelectDropdown', 'updatePopper');
                }
            });
        },

        toggleMenu() {
            // update author: tangdm descript: 拖拽状态判断
            if (this.dragStatus) {
                this.dragStatus = false;
                return false;
            }

            if (!this.selectDisabled) {
                if (this.menuVisibleOnFocus) {
                    this.menuVisibleOnFocus = false;
                } else {
                    this.visible = !this.visible;
                }
                if (this.visible) {
                    (this.$refs.input || this.$refs.reference).focus();
                }
            }
        },

        // @update @author:lutz @descript:添加 change 事件参数
        emitChange(val) {
            const { getLabel } = this;
            if (!valueEquals(this.value, val)) {
                this.$emit('change', val, getLabel(val));
            }
        },

        // @add @author:lutz @descript:获取过滤值
        getLabel(val) {
            const { data } = this.$attrs;
            const { value } = this.defaultProp;
            return _.isArray(val)
                ? _.intersectionBy(data, val.map(item => ({ [value]: item })), value)
                : _.find(data, item => val === item[value]);
        },

        resetInputWidth() {
            // update author: tangdm [code] this.inputWidth = this.$refs.reference.$el.getBoundingClientRect().width;
            // descript: element count item's width for error in layers.
            this.inputWidth = Math.max(
                this.$refs.reference.$el.getBoundingClientRect().width,
                this.$refs.reference.$el.clientWidth
            );
        },

        /**
         * 拖拽标签移动位置
         *
         * @param evt 事件
         * add author: tangdm
         */
        handleDragStart(evt) {
            // 初始化位置
            let disX = evt.clientX - this.$refs.tagContent.offsetLeft;

            // transform 当前的位置
            let transform = this.$refs.tagContent.style.transform;
            let position = transform.match(/-[0-9]+|[0-9]+/g);
            let positionValue = position ? Number(position[0]) : 0;

            // 移动位置变化
            document.onmousemove = e => {
                // 拖动的位置距离 支持正负值
                let dragWidth = Number(positionValue) + e.clientX - disX;
                let wrapWidth = this.inputWidth - 42;

                // 可拖动的区域宽度 185 为视图的可视宽度
                let dragAreaWidth = this.tagItemLength > wrapWidth ? wrapWidth - this.tagItemLength : 0;

                // 判断拖拽状态
                if (dragWidth) this.dragStatus = true;

                // 调整后拖动的位置距离
                dragWidth = dragWidth > 0 ? 0 : dragWidth < dragAreaWidth ? dragAreaWidth : dragWidth;

                // 更新 transfrom 的值
                this.$refs.tagContent.style.transform = 'translateX(' + dragWidth + 'px)';
            };

            // 鼠标上移，移除监听
            document.onmouseup = e => {
                document.onmousemove = null;
                document.onmouseup = null;
            };
        }
    },

    created() {
        this.cachedPlaceHolder = this.currentPlaceholder = this.placeholder;
        if (this.multiple && !Array.isArray(this.value)) {
            this.$emit('input', []);
        }
        if (!this.multiple && Array.isArray(this.value)) {
            this.$emit('input', '');
        }

        this.debouncedOnInputChange = debounce(this.debounce, () => {
            this.onInputChange();
        });

        this.debouncedQueryChange = debounce(this.debounce, e => {
            this.handleQueryChange(e.target.value);
        });

        this.$on('handleOptionClick', this.handleOptionSelect);
        this.$on('setSelected', this.setSelected);
    },

    mounted() {
        if (this.multiple && Array.isArray(this.value) && this.value.length > 0) {
            this.currentPlaceholder = '';
        }
        addResizeListener(this.$el, this.handleResize);

        const reference = this.$refs.reference;
        if (reference && reference.$el) {
            const sizeMap = {
                medium: 36,
                small: 32,
                mini: 28
            };
            const input = reference.$el.querySelector('input');

            // add author: tangdm descript: 增加分辨率识别
            const clientBodyWidth = document.body.clientWidth;
            const autoFixedHeight = clientBodyWidth < 1366 ? 24 : clientBodyWidth < 1681 ? 28 : 32;

            // update author: tangdm [code] this.initialInputHeight = input.getBoundingClientRect().height || sizeMap[this.selectSize];
            this.initialInputHeight = sizeMap[this.selectSize] || autoFixedHeight;
        }
        if (this.remote && this.multiple) {
            this.resetInputHeight();
        }
        this.$nextTick(() => {
            if (reference && reference.$el) {
                // update author: tangdm [code] this.inputWidth = reference.$el.getBoundingClientRect().width;
                this.inputWidth = Math.max(reference.$el.getBoundingClientRect().width, reference.$el.clientWidth);
            }
        });
        this.setSelected();
    }
};
</script>
