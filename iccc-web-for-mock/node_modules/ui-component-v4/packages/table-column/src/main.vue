<!--
    表格列：
    1、按照类型提供相应模板
    2、提供自定义列组件
    3、表码翻译
    4、属性、事件、插槽透传
    5、文本超出：停浮提示、停浮换行、换行
    @Author: tangDM
    @Date: 2019-03-07
    @Update: yangjy
    @Date: 2019-06-07
-->
<template>
    <!-- 1、type为'selection','index','expand' -->
    <el-table-column v-bind="attrs" :index="indexMethod" v-if="isOriginalType">
        <!-- 头部作用域插槽 -->
        <template v-slot:header="scope" v-if="isHeaderSlot">
            <slot name="header" v-bind="scope">{{ scope.column.label }} </slot>
        </template>

        <!-- expand为作用域插槽 -->
        <template v-slot="scope" v-if="'expand' == attrs.type">
            <slot v-bind="scope"></slot>
        </template>
    </el-table-column>

    <!--2、type为其他模板组件列 -->
    <el-table-column v-bind="attrs" v-else>
        <!-- 头部作用域插槽 -->
        <template v-slot:header="scope" v-if="isHeaderSlot">
            <slot name="header" v-bind="scope">{{ scope.column.label }} </slot>
        </template>
        <!-- 组件作插槽 -->
        <template v-if="$slots.default">
            <slot></slot>
        </template>
        <!-- 组件作作用域插槽 -->
        <template v-slot="scope" v-if="!$slots.default">
            <component
                :is="cmpType"
                v-bind="getCmpProps(scope)"
                v-on="getCmpEvents(scope)"
                :table-column-overflow="tableColumnOverflow || overflow"
                :value="formatValue(scope)"
                @input="val => handleCmpInput(val, scope)"
            >
                <template v-for="(val, key) in $scopedSlots">
                    <slot :name="key" v-bind="scope" :format-value="formatValue(scope)" v-if="key != 'header'"></slot>
                </template>
            </component>
        </template>
    </el-table-column>
</template>

<script>
import _ from 'lodash';
import template from './template';
import TableColumn from './column';
import { getCmpProps, getCmpType, getCmpPropsFromAttrs } from 'main/dg-utils/shear.js';

export default {
    name: 'DgTableColumn',

    mixins: [template],

    props: {
        // 组件属性
        cmpProps: [Object, Array],
        // 组件事件
        cmpEvents: Object,
        tableColumnOverflow: String,
        // 字典数据
        dictData: {
            type: Array,
            default() {
                return [];
            }
        }
    },

    data() {
        // 表码翻译数据对象
        let codeObj = {};
        _.forEach(this.dictData, item => {
            codeObj[item.value] = item.label;
        });
        return {
            codeObj
        };
    },

    watch: {
        // 监控字典数据变化，相应this.codeObj变化
        dictData(data) {
            _.forEach(data, item => {
                this.codeObj[item.value] = item.label;
            });
        }
    },

    computed: {
        // 动态组件类型转换，主要是require和import引入组件
        cmpType() {
            let type = getCmpType(this.$attrs.type);
            return type ? type : 'default-tpl';
        },
        // el-table-column组件的属性
        attrs() {
            const isTooltip = this.tableColumnOverflow || this.overflow;
            let filterObj = {
                type: (p, type) => {
                    return _.isString(type) ? type : undefined;
                },
                showOverflowTooltip: (p, val) => {
                    return isTooltip === 'tooltip' ? true : val;
                }
            };
            let result = getCmpProps(TableColumn, this, filterObj);
            this._getCmpPropsCallback(result);
            return result;
        },
        // 是否表头插槽
        isHeaderSlot() {
            return this.$slots['header'] || this.$scopedSlots['header'];
        },
        // 原来的类型"selection", "index", "expand"
        isOriginalType() {
            return _.isString(this.attrs.type) && _.includes(['selection', 'index', 'expand'], this.attrs.type);
        }
    },

    inject: ['overflow', 'paginationOptions'],

    components: {
        ElTableColumn: TableColumn
    },

    methods: {
        _getCmpPropsCallback() {},
        /**
         * 获取组件绑定对象
         * @param scope
         * @param cmpProps
         */
        getCmpProps(scope, reg) {
            let cmpProps = _.assign({ scope }, this.cmpProps, getCmpPropsFromAttrs(this, /^cmp-props-/));
            if (reg) {
                cmpProps = _.assign(cmpProps, getCmpPropsFromAttrs(this, reg));
            }

            // 如果是函数则传入scope，返回属性值
            let bindProps = _.mapValues(cmpProps, val => {
                return _.isFunction(val) ? val.apply([null], [scope]) : val;
            });
            this._getCmpProps(bindProps);
            return bindProps;
        },
        _getCmpProps() {},
        /**
         * 获取事件对象
         * @param scope
         * @param cmpEvents
         * @returns {object}
         */
        getCmpEvents(scope, reg) {
            let cmpEventsOther = getCmpPropsFromAttrs(this, reg || /^cmp-events-/);
            let cmpEvents = _.assign({}, this.cmpEvents, cmpEventsOther);
            // 增加scope参数到末尾
            const bindEvents = _.mapValues(cmpEvents, cb => _.bind(cb, null, [scope]));
            return bindEvents;
        },
        /**
         * 值格式化
         * @param scope
         * @returns {any}
         */
        formatValue(scope) {
            let value = _.get(scope.row, scope.column.property, '');
            if (this.attrs.formatter) {
                value = this.attrs.formatter(scope.row, scope.column, value, scope.$index);
            } else if (value != null && value !== "" && !_.isEmpty(this.codeObj)) {
                // 表码翻译
                let valueArr = [];
                const val = String(value);
                val.split(',').forEach(item => {
                    valueArr.push(this.codeObj[item] || item);
                });
                value = valueArr.join(',');
            }
            value = this._formatValue(value, scope);
            return value;
        },
        _formatValue(value) {
            return value;
        },
        /**
         * 获取真实值
         * @param scope
         * @returns {String}
         */
        getValue(scope) {
            let value = _.get(scope.row, scope.column.property, '');
            return value;
        },
        /**
         * 获取input事件处理函数
         * @param scope
         * @returns {Function}
         */
        handleCmpInput(val, scope) {
            scope.row[scope.column.property] = val;
        },
        /**
         * 默认索引方法重写
         *
         * @param index [Number] 默认索引值
         * @return 显示的索引值
         */
        indexMethod(index) {
            const { currentPage, pageSize } = this.paginationOptions;

            // 支持自定义索引
            if(this.$attrs.index) {
                return this.$attrs.index(index);
            }

            if(pageSize && currentPage) {
                return index + 1 + (currentPage -1) * pageSize;
            } else {
                return index + 1;
            }

        }
    }
};
</script>
