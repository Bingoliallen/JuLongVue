<!--
    类别模板
    @Author: tangDM
    @Date: 2019-03-07
-->
<template>
    <div class="dg-tpl__type" v-if="sourceData.name">
		<dg-tag custom-color effect="light" :color="sourceData.color" size="mini">{{ sourceData.name }}</dg-tag>
    </div>
</template>

<script>
import _ from 'lodash';

export default {
    name: 'DgTypeTpl',

    props: {
        // 模板配置
        value: [String, Number, Boolean],
        // 返回函数
        fn: {
            type: [String, Number, Boolean, Object, Function],
            default: val => val
        },
        // 作用域
        scope: Object,
        // 显示配置
        options: {
            type: Array,
            default() {
                return [];
            }
        },
        // 类别和颜色映射
        map: {
            type: Object,
            default() {
                return {};
            }
        },
        // 颜色范围
        range: {
            type: Array,
            default() {
                return ['#ff6d4a', '#ffa32c', '#4877e8', '#67c23a'];
            }
        }
    },

    created() {
        // 合并map和options
        let map = this.map;
        let options = this.options;
        options.forEach(item => {
            map[item.name] = item.color;
        });

        // 存储数据在表格全局store上
        let scope = this.scope;
        let store = scope.store;
        let id = scope.column.id;
        if (!store.typeColor) {
            store.typeColor = {};
            store.typeColor[id] = _.clone(map);
        } else if (!store.typeColor[id]) {
            store.typeColor[id] = _.clone(map);
        }
    },

    computed: {
        // 处理数据
        sourceData() {
            let typeColor = this.scope.store.typeColor[this.scope.column.id];
            let colorType = this.getColorType(typeColor);
            let name = this.value;
            if (_.isFunction(this.fn)) {
                this.fn(this.scope);
            } else if (this.fn) {
                name = this.fn;
            }

            let color = typeColor[name];
            if (!color) {
                // 颜色不存在，先从范围取，不存在随机生成
                let newColor = this.getNewColorFromRange(colorType);
                if (!newColor) {
                    newColor = this.getRandomColor();
                    while (colorType[newColor]) {
                        newColor = this.getRandomColor();
                    }
                }
                color = newColor;
            }
            typeColor[name] = color;
            return { name: name, color: color };
        },
        styleColour() {
            return {
                border: '1px solid ' + this.sourceData.color,
                color: this.sourceData.color
            };
        }
    },

    methods: {
        /**
         * 获取随机颜色
         * @returns {string}
         */
        getRandomColor() {
            return '#' + ('00000' + ((Math.random() * 0x1000000) << 0).toString(16)).substr(-6);
        },
        /**
         * 获取颜色和类别的对象，如{"#33333":"类别1"}
         * @param typeColor
         */
        getColorType(typeColor) {
            let colorTypeObj = {};
            _.forOwn(typeColor, (val, key) => {
                colorTypeObj[val] = key;
            });
            return colorTypeObj;
        },
        getNewColorFromRange(colorType) {
            let newColor = '';
            this.range.forEach(color => {
                if (!colorType[color]) {
                    newColor = color;
                }
            });
            return newColor;
        }
    }
};
</script>
