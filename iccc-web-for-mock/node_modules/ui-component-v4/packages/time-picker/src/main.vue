<template>
    <div class="dg-time-picker" :class="{ 'dg-time-picker__btn--visible': shortBtns.length }">
        <!-- 快捷按钮 -->
        <dg-radio-group
            v-if="shortBtns.length"
            v-model="activeShortBtn"
            :data="shortBtns"
            value-name="text"
            label-name="text"
            :style="$attrs['radio-type'] ? 'display: flex; align-items: center;' : ''"
            :type="$attrs['radio-type'] || 'button'"
            :size="size"
            @change="handleShortBtnChange"
        >
        </dg-radio-group>

        <!-- 时间范围 -->
        <template v-if="isRangeTypeTwo">
            <div class="dg-range-editor">
                <el-time-select
                    ref="picker"
                    v-bind="$attrs"
                    v-model="startTime"
                    :placeholder="beginPlaceholder"
                    :size="size"
                    :picker-options="startPickOpt"
                    @pick="emitInput"
                    @blur="handleBlur"
                    @focus="handleFocus"
                    @change="handleStartChange"
                >
                </el-time-select>
                <span class="dg-time-picker__separator">{{ rangeSeparator }}</span>
                <el-time-select
                    v-bind="$attrs"
                    v-model="endTime"
                    :placeholder="endPlaceholder"
                    :size="size"
                    :picker-options="endPickOpt"
                    @pick="emitInput"
                    @blur="handleBlur"
                    @focus="handleFocus"
                    @change="handleEndChange"
                >
                </el-time-select>
            </div>
        </template>
        <!-- 单个时间类型 -->
        <template v-else>
            <el-time-select
                ref="picker"
                :size="size"
                v-model="singleTime"
                v-bind="$attrs"
                v-on="$listeners"
                @pick="emitInput"
            >
            </el-time-select>
        </template>
    </div>
</template>

<script>
import _ from 'lodash';
import { formatDate } from 'main/utils/date-util';
import objectAssign from 'main/utils/merge';
import DgRadioGroup from 'packages/radio-group';
import { TimeSelect as ElTimeSelect } from 'element-ui';

const parseTime = function(time) {
    const values = (time || '').split(':');
    if (values.length >= 2) {
        const hours = parseInt(values[0], 10);
        const minutes = parseInt(values[1], 10);

        return {
            hours,
            minutes
        };
    }
    /* istanbul ignore next */
    return null;
};

const compareTime = function(time1, time2) {
    const value1 = parseTime(time1);
    const value2 = parseTime(time2);

    const minutes1 = value1.minutes + value1.hours * 60;
    const minutes2 = value2.minutes + value2.hours * 60;

    if (minutes1 === minutes2) {
        return 0;
    }

    return minutes1 > minutes2 ? 1 : -1;
};

/*
 * Considers:
 *   1. Date object
 *   2. date string
 *   3. array of 1 or 2
 */
const valueEquals = function(a, b) {
    const aIsArray = a instanceof Array;
    const bIsArray = b instanceof Array;
    if (aIsArray && bIsArray) {
        if (a.length !== b.length) {
            return false;
        }
        return a.every((item, index) => compareTime(item, b[index]) === 0);
    }
    if (!aIsArray && !bIsArray) {
        return compareTime(a, b) === 0;
    }
    return false;
};

export default {
    name: 'DgTimePicker',
    // 去除将未识别属性绑定到外层的DOM上，详见：https://cn.vuejs.org/v2/api/index.html#inheritAttrs
    inheritAttrs: false,

    components: {
        DgRadioGroup,
        ElTimeSelect
    },

    props: {
        // 配置按钮数组
        shortBtns: {
            type: Array,
            default: () => []
        },
        // 开始时间
        startValue: String,
        // 结束时间
        endValue: String,
        // 尺寸大小
        size: {
            type: String
        },
        // 分割符
        rangeSeparator: {
            type: String,
            default: '-'
        },
        // 时间选择类型
        type: {
            type: String,
            default: 'select'
        },
        // 传入的数据值
        value: [String, Array],
        // 开始时间提示
        beginPlaceholder: String,
        // 结束时间提示
        endPlaceholder: String
    },

    data() {
        return {
            // 按钮选中的标识值
            activeShortBtn: '',
            // 单个时间选择值
            singleTime: '',
            // 开始时间选择值
            startTime: this.startValue,
            // 结束时间选择值
            endTime: this.endValue
        };
    },

    computed: {
        /**
         * 检测是否为范围型日期类型
         *
         */
        isRangeTypeTwo() {
            // 针对范围型控件，拆分成两个独立控件，通过模板拆分渲染
            return this.type.indexOf('range2') > -1;
        },
        startPickOpt() {
            // 设置开始时间可选择时间上限
            let opt = _.cloneDeep(this.$attrs['picker-options']) || {};

            // 检测是否为空对象
            if (!_.isPlainObject(opt)) return opt;

            // 检测重构的值
            let result = objectAssign(opt, {
                maxTime: opt.maxTime ? opt.maxTime : this.endTime
            });

            return result;
        },
        endPickOpt() {
            // 设置结束日期可选择日期范围
            let opt = _.cloneDeep(this.$attrs['picker-options']) || {};

            // 检测是否为空对象
            if (!_.isPlainObject(opt)) return opt;

            // 检测重构的值
            let result = objectAssign(opt, {
                minTime: opt.minTime ? opt.minTime : this.startTime
            });

            return result;
        }
    },

    watch: {
        value: {
            immediate: true,
            handler(newVal) {
                if (Array.isArray(newVal)) {
                    let [startTime, endTime] = newVal;
                    this.startTime = startTime;
                    this.endTime = endTime;
                } else {
                    // 选项检测 tangDM++
                    if (this.shortBtns.length) {
                        let isActive = this.shortBtns.find(item => item.text === newVal);

                        // 同步选项按钮
                        if (!isActive) this.activeShortBtn = '';
                        else this.activeShortBtn = newVal;
                    }
                    this.singleTime = newVal;
                }
            }
        }
    },

    methods: {
        /**
         * 按钮点击对应的事件触发
         *
         * @param text [String] 文本值
         */
        handleShortBtnChange(text) {
            let btn = this.shortBtns.find(o => o.text === text);

            // 触发相应的点击
            if (btn.onClick) {
                let picker = this.$refs.picker;
                btn.onClick(picker);
            }
        },
        /**
         * 格式化日期值
         *
         * @param value
         * @return {*}
         */
        formatToValue(value) {
            let format = this.$attrs['value-format'];
            if (format) {
                value = Array.isArray(value) ? value.map(date => formatDate(date, format)) : formatDate(value, format);
            }
            return value;
        },
        emitChange(val) {
            // determine user real change only
            if (!valueEquals(val, this.value)) {
                this.$emit('change', val);
                if (this.$attrs['validateEvent']) {
                    this.dispatch('ElFormItem', 'el.form.change', val);
                }
            }
        },
        emitInput(val) {
            // 检测当前类型
            if (!this.isRangeTypeTwo) {
                this.singleTime = val;
            }

            let format = this.formatToValue(val);
            this.$emit('input', format);
        },
        handleBlur() {
            this.$emit('blur', this);
        },
        handleFocus() {
            this.$emit('focus', this);
        },
        handleDateChange(value) {
            this.emitInput(value);
        },
        handleStartChange(value) {
            this.emitInput([value, this.endTime]);
        },
        handleEndChange(value) {
            this.emitInput([this.startTime, value]);
        }
    }
};
</script>
