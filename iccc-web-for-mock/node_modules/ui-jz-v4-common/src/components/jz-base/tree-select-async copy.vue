<template>
    <div class="async-tree-select">
        <!-- v-model="selectedDataLabel" -->
        <el-select
            :value="showLabel"
            :multiple="multiple"
            :collapse-tags="collapseTags"
            value-key="id"
            placeholder="请选择..."
            style="width: 16rem"
        >
            <el-option class="tree-options-wrap" :value="selectedDataValue" style="height: auto;background: white">
                <el-tree
                    ref="tree"
                    :node-key="valueName"
                    :default-checked-keys="selectedDataValue"
                    @node-click="handleNodeClick"
                    @check="handleNodeCheck"
                    @check-change="handleNodeCheckChange"
                    @node-expand="handleNodeExpand"
                    v-bind="innerTreeProps"
                />
            </el-option>
        </el-select>
    </div>
</template>
<script>
import _ from "lodash";
export default {
    name: "DgTreeSelectAsync",

    props: {
        code: {
            type: String,
            default: ""
        },
        treeProps: {
            type: Object,
            default: () => ({})
        },
        data: {
            type: Array,
            default: () => []
        },
        multiple: {
            type: Boolean,
            default: false
        },
        collapseTags: {
            type: Boolean,
            default: false
        },
        value: {
            type: [String, Array],
            default: ""
        },
        valueName: {
            type: String,
            default: "value"
        },
        labelName: {
            type: String,
            default: "label"
        },
        lazy: {
            type: Boolean,
            default: false
        },
        maxLevel: {
            type: Number,
            default: 100
        },
        checkStrictly: {
            type: Boolean,
            default: false
        },
        // 展开联动，收缩不联动，如果要使这个属性生效，则需要将checkStrictly设置为true
        isToggleContact: {
            type: Boolean,
            default: false
        }
    },

    model: {
        prop: "value",
        event: "change"
    },

    data() {
        return {
            selectedData: [],
            selectedDataLabel: this.value,
            selectedDataValue: this.value,
            dataSourceObj: {}
        };
    },

    watch: {
        selectedDataValue(val, old) {
            this.selectedDataLabel = this.selectedDataValue.map(item => this.dataSourceObj[item] || item);

            this.$emit("change", this.selectedDataValue);
        }
    },

    computed: {
        showLabel() {
            return this.selectedData.map(item => this.dataSourceObj[item]);
        },
        innerTreeProps() {
            const { data, multiple, labelName, valueName, lazyLoadFn, lazy } = this;

            let checkStrictly = this.checkStrictly;
            if (this.isToggleContact && this.multiple) {
                checkStrictly = true;
            }

            const result = Object.assign({}, this.treeProps, {
                data: data,
                showCheckbox: multiple,
                props: {
                    label: labelName,
                    value: valueName
                },
                load: lazyLoadFn,
                lazy: lazy,
                checkStrictly: checkStrictly
            });
            return result;
        }
    },

    methods: {
        updateCheckStatus() {
            this.$refs.tree.setCheckedKeys(this.value);
        },

        handleNodeClick(data, node, nodeData) {
            if (!this.multiple) {
                this.selectedData = [data];
                this.$emit("change", [data[this.valueName]]);
            }
        },

        _findChildKeys(curNode) {
            const childNodes = curNode.childNodes;
            let childKeys = [];
            if (childNodes) {
                childKeys = childNodes.map(item => item.key);
            }
            return childKeys;
        },

        handleNodeCheck(data, treeObj) {
            const curNode = this.$refs.tree.getNode(data);
            const childKeys = this._findChildKeys(curNode);
            let addKeysTmp = [];
            let checked = _.includes(treeObj.checkedKeys, data[this.valueName]);

            if ((this.isToggleContact && curNode.expanded) || (!this.checkStrictly && !this.isToggleContact)) {
                addKeysTmp = childKeys;
            }
            if (this.lazy) {
                if (checked) {
                    this.selectedDataValue = _.uniq([...this.selectedDataValue, data[this.valueName], ...addKeysTmp]);
                } else {
                    this.selectedDataValue = _.difference(this.selectedDataValue, [
                        data[this.valueName],
                        ...addKeysTmp
                    ]);
                }
            } else {
                const checkedNodes = this.$refs.tree.getCheckedNodes();
                let labelResult = [];
                let valueResult = [];
                checkedNodes.map(item => {
                    labelResult.push(item[this.labelName]);
                    valueResult.push(item[this.valueName]);
                });
                this.selectedDataLabel = labelResult;
            }
            this.$refs.tree.setCheckedKeys(this.selectedDataValue);
        },

        // 节点展开事件
        handleNodeExpand(data, node, treeNode) {
            // this.$nextTick(() => {
            //     const { checkStrictly } = this;
            //     const childKeys = this._findChildKeys(node);
            //     if (node.checked && !checkStrictly) {
            //         this.selectedDataValue = _.uniq([...this.selectedDataValue, data[this.valueName], ...childKeys]);
            //     }
            // });
        },

        handleNodeCheckChange(data, checked, hasChildChecked) {},

        lazyLoadFn(node, resolve) {
            if (this.maxLevel && node.level >= this.maxLevel) {
                return resolve([]);
            } else {
                let curNodeId = node.key ? node.key : "";
                if ((curNodeId && curNodeId != " ") || node.level < 1) {
                    let params = {
                        code: this.code || "",
                        pid: curNodeId || this.curNodeId,
                        keyword: ""
                    };
                    this.loadData(Object.assign(params), resolve).then(data => {
                        const { checkStrictly } = this;
                        const childKeys = this._findChildKeys(node);
                        if (node.checked && !checkStrictly) {
                            this.selectedDataValue = _.uniq([
                                ...this.selectedDataValue,
                                data[this.valueName],
                                ...childKeys
                            ]);
                        }
                    });
                } else {
                    return resolve([]);
                }
            }
        },

        async loadData(params, resolve) {
            const { data } = await this.$req.get("api/test/tree1", params);
            data.data.map(item => {
                this.dataSourceObj[item[this.valueName]] = item[this.labelName];
            });
            resolve(data.data);
            this.$nextTick(this.updateCheckStatus);
            return data;
        }
    },

    created() {
        // if(this.value && this.multiple){
        //     this.$refs.tree.setCheckedKeys(this.value)
        // }
        // this.loadData();
    }
};
</script>
<style scoped lang="scss">
.tree-options-wrap {
    padding: 0;
}
</style>
