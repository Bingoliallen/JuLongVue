/**
 * 数据表格
 * @Author: huangjq
 * @Date:   2019-03-05
 * @Project jz
 */

import { Table } from "ui-component-v4";
import DataOp from "../../utils/zt-data";

export default {
    name: "DgTable",

    props: {
        url: {
            type: String,
            default: "",
            required: false
        },
        pagination: {
            type: Boolean,
            default: true,
            required: false
        },
        lazyLoad: {
            type: Boolean,
            default: false,
            required: false
        },
        vLoading: {
            type: Boolean,
            default: true
        },
        border: {
            type: Boolean,
            default: true,
            required: false
        },
        condition: {
            type: [Array, Object],
            default: () => {}
        },
        sortProps: {
            type: Object,
            default: () => {}
        },
        defaultSort: {
            type: Object,
            default: () => {}
        },
        module: {
            type: String,
            default: "BASE_API"
        },
        customCondition: {
            type: Function
        },
        paginationProps: {
            type: Object,
            default: function() {
                return {
                    currentPage: 1,
                    pageSizes: [10, 20, 30, 40, 50],
                    pageSize: 10,
                    layout: "total, sizes, prev, pager, next, jumper"
                };
            }
        }
    },

    data() {
        return {
            _sort: {}
        };
    },

    computed: {},
    methods: {
        /**
         * 获取请求条件
         * @returns {{size: number | default.props.pageSize | {default, type} | default.watch.pageSize | {handler, immediate} | pagination.props.pageSize | *, searchCondition: string, page: number, sort: ({}|*)}}
         */
        getReqSearchCondition() {
            let finalConditions = {};
            if (this.customCondition) {
                finalConditions = this.customCondition(this.condition);
            } else {
                let conditions;
                conditions = this._getConditions();
                let reqSearchCondition = {
                    sort: JSON.stringify(this._sort),
                    searchCondition: JSON.stringify(conditions)
                };
                if (this.pagingType !== "client") {
                    let pageSize = this.paginationOptions.pageSize;
                    if (!this.pagination) {
                        pageSize = 10000;
                    }
                    reqSearchCondition.page = this.paginationOptions.currentPage - 1;
                    reqSearchCondition.size = pageSize;
                }
                finalConditions = reqSearchCondition;
            }
            return finalConditions;
        },
        /**
         * 获取查询表单条件
         */
        _getConditions() {
            let searchCondition = this.condition;
            let conditions = [];
            const isConArr = searchCondition instanceof Array;
            let name = "";
            for (let key in searchCondition) {
                if (searchCondition[key].value || searchCondition[key].value === 0) {
                    name = isConArr ? searchCondition[key].name : key;
                    conditions.push({
                        name: name,
                        op: searchCondition[key].op || "=",
                        value: searchCondition[key].value,
                        type: searchCondition[key].type || "",
                        format: searchCondition[key].format || ""
                    });
                }
            }
            return conditions;
        },
        /**
         * 当前页改变方法
         * @param val 当前页数
         */
        handleCurrentChange(val) {
            this.paginationOptions.currentPage = val;
            this.loadData();
            this.$emit("change-current", val);
        },

        /**
         * 每页记录数改变方法
         * @param val 每页记录数
         */
        handleSizeChange(val) {
            this.paginationOptions.pageSize = val;
            this.loadData();
            this.$emit("change-size", val);
        },
        /**
         * 排序方法
         * @param column 用户当前选择的列
         */
        _handleSortChange(column) {
            if (this.pagingType === "client") {
            } else {
                let columnName = column.prop;
                let order = column.order;
                this._sort = {};

                if ("descending" === order) {
                    order = "desc";
                } else if ("ascending" === order) {
                    order = "asc";
                } else {
                    order = null;
                }
                if (order) {
                    this._sort[columnName] = order;
                }
                this.loadData();
            }
        },

        /**
         * 客户端分页排序
         * @private
         */
        _filterData() {
            let conditions = this._getConditions();
            let oldDataLength = this.dataClient.length;
            if (this.orignData.length === 0) {
                this.orignData = this.dataClient;
            }
            let data = this.orignData.filter(item => {
                let flag = true;
                conditions.map(function(condition) {
                    let { name, value, op } = condition;
                    if (op === "=") {
                        if (item[name] != value) {
                            flag = false;
                        }
                    } else if (op === "!=") {
                        if (!(item[name] != value)) {
                            flag = false;
                        }
                    } else if (op === ">") {
                        if (!(item[name] > value)) {
                            flag = false;
                        }
                    } else if (op === "<=") {
                        if (!(item[name] <= value)) {
                            flag = false;
                        }
                    } else if (op === ">=") {
                        if (!(item[name] >= value)) {
                            flag = false;
                        }
                    } else if (op === "like") {
                        if (item[name].indexOf(value) < 0) {
                            flag = false;
                        }
                    } else if (op === "between") {
                        if (item[name] <= value[0] || item[name] >= value[1]) {
                            flag = false;
                        }
                    }
                });
                return flag;
            });
            !data && (data = []);
            this.paginationOptions.total = data.length;
            this.dataClient = data;
            let { total, pageSize, currentPage } = this.paginationOptions;
            // if (currentPage > Math.ceil(total / pageSize) || currentPage === 0) {
            // this.paginationOptions.currentPage = Math.ceil(total / pageSize);
            if (oldDataLength !== total || total === 0) {
                this.paginationOptions.currentPage = 1;
            }
            // }
        },

        /**
         * 加载数据
         * @param params 请求参数
         */
        loadData(params) {
            if (
                "client" === this.pagingType &&
                this.orignData &&
                this.orignData.length > 0 &&
                (!params || (!params.isInit && !params.url))
            ) {
                this._filterData();
                return Promise.resolve();
            }

            this.loadding = true;

            if (params && params.url) {
                this.url = params.url;
            }

            return DataOp.reqTableData(this.$props, this.getReqSearchCondition()).then(({ data }) => {
                setTimeout(() => {
                    this.loadding = false;
                }, 200);

                const isArray = param => Object.prototype.toString.call(param) === "[object Array]";
                let total = 0;
                // let total = isArray(data) ? data.length : isArray(data.content) ? data.content.length : 0;
                //                 // if (!this.pagination) {
                //                 //     this.dataSource = isArray(data) ? data : data.content;
                //                 // } else
                if (this.pagingType === "client" && isArray(data)) {
                    this.dataClient = data;
                    this.orignData = data;
                    total = data.length;
                } else {
                    this.dataSource = data.content;
                    total = data.totalElements;
                }
                this.paginationOptions.total = total;
            });
        },
        searchForm(params = {}) {
            this.paginationOptions.currentPage = params.currentPage || 1;
            return this.loadData(params);
        },
        reload() {
            return this.loadData();
        },
        getDataStroe() {
            let data = [];
            if ("client" === this.pagingType) {
                data = this.dataClient;
            } else {
                data = this.dataSource;
            }
            return data;
        }
    },

    watch: {
        url(val) {
            this.searchForm({ url: val });
        }
    },
    mixins: [Table],

    mounted() {},

    created() {
        this.paginationOptions = Object.assign({}, this.paginationOptions, this.paginationProps);
        if (this.defaultSort) {
            this._sort = {};
            this._sort[this.defaultSort["prop"]] = this.defaultSort["order"];
        }
        if ("client" === this.pagingType && this.dataClient && this.dataClient.length > 0) {
            this.loadData({ isInit: true });
        } else if (!this.lazyLoad && this.dataSource.length <= 0) {
            this.loadData();
        }
    }
};
