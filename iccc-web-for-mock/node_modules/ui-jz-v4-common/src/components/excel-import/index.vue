<template>
    <div class="excel-import-page">
        <div class="excel-import-bar">
            <span>
            <dg-upload action="#"
                       ref="fileUploader"
                       :multiple="true"
                       :http-request="uploadFile"
                       :show-file-list="false"
                       :accept="supportType" style="display: inline-block;margin-right: 10px;">
                <slot name="upload-btn">
                    <dg-button icon="el-icon-upload2">文件上传</dg-button>
                </slot>
            </dg-upload>
            <span @click="handleDownloadTemplate">
                <slot name="template-btn">
                    <dg-button type="text" icon="el-icon-download">下载模板</dg-button>
                </slot>
            </span>
            </span>
            <span>
                <slot name="file-upload-tip" :total="uploadInfo.total" :success="uploadInfo.success" :error="uploadInfo.error">
                    <span>上传附件共 <span class="file-tip file-total">{{uploadInfo.total}}</span>个，
                        其中成功 <span class="file-tip file-success">{{uploadInfo.success}}</span>个，
                        失败 <span class="file-tip file-error">{{uploadInfo.error}}</span>个</span>
                </slot>
            </span>
        </div>
        <div class="excel-import-file-list">
            <dg-table ref="fileGrid" class="excel-import-file-table" :loading="false" :border="border" :data="fileList"
                      paging-type="client" :paginationProps="{pageSize:5}" size="mini">
                <dg-table-column width="80" align="center" label="序号">
                    <template slot-scope="scope">
                        {{getFileIndex(scope.$index)}}
                    </template>
                </dg-table-column>
                <dg-table-column prop="fileName" align="center" label="文件名"></dg-table-column>
                <dg-table-column width="250" align="center" label="上传进度">
                    <template slot-scope="scope">
                        <el-progress :text-inside="true" :stroke-width="16" :percentage="scope.row.percentage"
                                     status="success"></el-progress>
                    </template>
                </dg-table-column>
                <dg-table-column width="250" align="center" label="说明">
                    <template slot-scope="scope">
                        <slot name="file-remark" :row="scope.row">
                            <span v-if="!scope.row.id" class="file-unupload">待上传</span>
                            <span v-else-if="scope.row.uploadStatus==0" class="file-uploading">上传中</span>
                            <span v-else-if="scope.row.uploadStatus==2"><span class="file-tip file-error">上传失败：</span><span class="file-upload-error">{{scope.row.errMsg}}</span></span>
                            <span v-else>
                                共 <span class="file-tip file-total">{{scope.row.total}}</span>条，
                                异常 <span class="file-tip file-error">{{scope.row.errCount}}</span>条
                            </span>
                        </slot>
                    </template>
                </dg-table-column>
                <dg-table-column width="100" align="center" label="文件大小">
                    <template slot-scope="scope">
                        {{parseFileSize(scope.row.fileSize)}}
                    </template>
                </dg-table-column>
                <dg-table-column prop="uploadTime" width="180" align="center" label="上传时间">
                    <template slot-scope="scope">
                        <template v-if="scope.row.id">{{parseUploadTime(scope.row.uploadTime)}}</template>
                        <template v-else>-</template>
                    </template>
                </dg-table-column>
                <dg-table-column width="70" align="center" label="操作">
                    <template slot-scope="scope">
                        <dg-button size="mini" type="danger" icon="el-icon-delete" disabled circle v-if="scope.row.id && scope.row.uploadStatus==0" title="上传中，不能删除"></dg-button>
                        <dg-button size="mini" type="danger" icon="el-icon-delete" circle v-else @click="handleDeleteFile(scope.row)"></dg-button>
                    </template>

                </dg-table-column>
            </dg-table>
        </div>
        <div class="excel-import-data-list">
            <div class="excel-import-data-tab">
                <el-tabs type="card" v-model="activeStatus" @tab-click="search">
                    <el-tab-pane name="all">
                        <span slot="label">
                            <slot name="tab-all">
                                <i class="el-icon-s-grid"></i>全部
                            </slot>
                        </span>
                    </el-tab-pane>
                    <el-tab-pane name="success">
                        <span slot="label">
                            <slot name="tab-success">
                                <i class="el-icon-success"></i>正常
                            </slot>
                        </span>
                    </el-tab-pane>
                    <el-tab-pane name="error">
                        <span slot="label">
                            <slot name="tab-error">
                                <i class="el-icon-error"></i>异常
                            </slot>
                        </span>
                    </el-tab-pane>
                </el-tabs>
                <div class="import-data-toolbar">
                    <span>
                        <slot name="result-tip" :fileCount="resultInfo.fileCount" :total="resultInfo.total"
                              :error="resultInfo.error">
                            <span>共关联 <span class="file-tip file-total">{{resultInfo.fileCount}}</span>个文件，共有 <span
                                    class="file-tip file-success">{{resultInfo.total}}</span>条导入信息，异常信息 <span
                                    class="file-tip file-error">{{resultInfo.error}}</span>条</span>
                        </slot>
                    </span>
                    <span>
                        <span @click="handleDelete">
                            <slot name="delete-btn">
                                <dg-button type="warning" icon="el-icon-delete">批量删除</dg-button>
                            </slot>
                         </span>
                        <span @click="handleClear">
                            <slot name="clear-btn">
                                <dg-button type="danger" icon="el-icon-brush">清空错误数据</dg-button>
                            </slot>
                        </span>
                        <span @click="handleExport">
                            <slot name="export-btn">
                                <dg-button type="primary" icon="el-icon-download" plain>导出错误数据</dg-button>
                            </slot>
                        </span>
                    </span>
                </div>
            </div>
            <dg-table  ref="dataGrid"
                       v-clickoutside="handleOutsideClick"
                       @header-click="handleOutsideClick"
                       class="excel-import-data-table"
                       :border="border"
                       overflow="origin"
                       :url="'/excel-imports/'+id+'/list'"
                       :module="module"
                       :lazyLoad="true"
                       :condition="gridCondition"
                       :defaultSort="gridOrder"
                       @row-click="handleRowClick">
                <dg-table-column align="center" reserve-selection type="selection" prop="id"></dg-table-column>
                <dg-table-column width="60" align="center" label="序号">
                    <template slot-scope="scope">
                        {{getDataIndex(scope.$index)}}
                    </template>
                </dg-table-column>
                <dg-table-column align="center" width="45" label="状态">
                    <template slot-scope="scope">
                        <el-tooltip
                                content="验证成功"
                                effect="dark"
                                class="tooltip"
                                placement="top"
                                v-if="scope.row.validateStatus==1"
                        >
                            <i class="el-icon-success validate-status status-success"></i>
                        </el-tooltip>
                        <el-tooltip
                                content="验证失败"
                                effect="dark"
                                class="tooltip"
                                placement="top"
                                v-else
                        >   <div slot="content" v-html="getErrorList(scope.row.validateResult)"></div>
                            <i class="el-icon-error validate-status status-error"></i>
                        </el-tooltip>
                    </template>
                </dg-table-column>
                <dg-table-column width="70" align="center" label="操作">
                    <template slot-scope="scope">
                        <dg-button size="mini" type="text" v-if="scope.row.validateStatus==1" title="导入" @click="handleImportData([scope.row])">
                            <i class="ctr-btn el-icon-s-claim"></i>
                        </dg-button>
                        <dg-button size="mini" type="text" disabled title="验证失败，不能导入" v-else>
                            <i class="ctr-btn el-icon-s-claim"></i>
                        </dg-button>
                        <dg-button size="mini" type="text" title="删除" @click="handleDeleteData([scope.row])">
                            <i class="ctr-btn el-icon-delete"></i>
                        </dg-button>
                    </template>
                </dg-table-column>
                <dg-table-column width="260" align="center" label="对应文件" v-if="showFileName">
                    <template slot-scope="scope">
                        <el-tooltip
                                :content="fileMapper[scope.row.uploadId] ? fileMapper[scope.row.uploadId].fileName : '未知文件'"
                                effect="dark"
                                class="tooltip"
                                placement="top"
                        >
                            <span class="tooltip-wrap">{{fileMapper[scope.row.uploadId] ? fileMapper[scope.row.uploadId].fileName : "未知文件"}}</span>
                        </el-tooltip>
                    </template>
                </dg-table-column>

                <dg-table-column :width="column.width ? column.width : (column.type=='date' && column.format.length>12) ? 240 : defaultColumnWidth" :key="column.name" :prop="column.name" align="center" :label="column.display" v-for="column in scheme.metadata">
                    <template slot-scope="scope">
                        <el-tooltip
                                :content="scope.row.validateResult[column.name] ? scope.row.validateResult[column.name] : scope.row['_'+column.name] ? (scope.row['_'+column.name]||'').toString() : (scope.row[column.name]||'').toString()"
                                effect="dark"
                                class="tooltip"
                                placement="top"
                                :disabled="tooltipDisabled"
                        >
                            <span class="tooltip-wrap" :class="{'error-column':scope.row.validateResult[column.name]}" @mouseenter="visibilityChange($event,scope.row,column)">
                                <slot :name="'column_'+column.name+'_label'" :row="scope.row" v-if="!scope.row._input">
                                   {{scope.row["_"+column.name] ? scope.row["_"+column.name] : scope.row[column.name]}}
                                </slot>
                                <slot :name="'column_'+column.name+'_input'" :row="scope.row" v-if="scope.row._input">
                                    <el-input v-model="scope.row[column.name]" :placeholder="'请输入'+column.display" :maxlength="column.maxLength" v-if="column.type=='char' && column.maxLength>0"></el-input>
                                    <el-input v-model="scope.row[column.name]" :placeholder="'请输入'+column.display" v-if="column.type=='char' && column.maxLength<=0"></el-input>
                                     <dg-tree-drop v-model="scope.row[column.name]"
                                                   :data="treeData[column.format] ? treeData[column.format] : []"
                                                   :multiple="column.multiple"
                                                   :placeholder="'请选择'+column.display"
                                                   value-name="id"
                                                   clearable
                                                   filterable
                                                   v-if="column.isTree">
                                    </dg-tree-drop>
                                    <dg-select
                                            v-model="scope.row[column.name]"
                                            :code="column.type=='code' ? column.format : ''"
                                            :enum="column.type=='enum' ? column.format : ''"
                                            :multiple="column.multiple"
                                            :placeholder="'请选择'+column.display"
                                            clearable
                                            filterable
                                            collapse-tags
                                            v-if="!column.isTree && (column.type=='code' || column.type=='enum')">
                                    </dg-select>
                                    <el-input-number v-model="scope.row[column.name]" :controls="false" :precision="column.precision" :min="column.min" :max="column.max" v-if="column.type=='number'"></el-input-number>
                                    <dg-date-picker v-model="scope.row[column.name]" type="datetime" :placeholder="'请选择'+column.display" :value-format="column.format" :format="column.format" v-if="column.type=='date' && column.format.length>12"></dg-date-picker>
                                    <dg-date-picker v-model="scope.row[column.name]" type="date" :placeholder="'请选择'+column.display" :value-format="column.format" :format="column.format" v-if="column.type=='date' && column.format.length<=12"></dg-date-picker>
                                </slot>
                            </span>
                        </el-tooltip>
                    </template>
                </dg-table-column>
            </dg-table>
        </div>
        <div class="excel-import-footer">
            <span @click="handleImport">
            <slot name="import-select-btn">
                <dg-button type="primary" icon="el-icon-check">选择导入</dg-button>
            </slot>
            </span>
            <span @click="handleImportAll">
            <slot name="import-all-btn">
                <dg-button type="primary" icon="el-icon-finished">全部导入</dg-button>
            </slot>
            </span>
            <slot name="footer-btn">

            </slot>
        </div>
    </div>
</template>
<script>
    import ExcelImportApi from "../../api/jz-base/excelImportApi";
    import dateUtils from "../../utils/date-utils";
    // import clickoutside from 'ui-component-v4/lib/dg-directives/clickoutside';
    import clickoutside from 'raw-loader!babel-loader!ui-component-v4/lib/dg-directives/clickoutside';
    import _ from "../../utils/zt-lodash";
    import base64 from "js-base64";

    export default {
        name: "DgExcelImport",
        props: {
            id: {  //导入方案id
                type: String,
                required: true
            },
            name: {  //导入方案名称，可以覆盖后台的配置
                type: String,
                default: ""
            },
            module:{//请求api所属module
                type: String,
                default: "IMPORT_API"
            },
            params: { //导入业务参数，用于将一些特定参数传递给后台处理接口
                type: Object,
                default() {
                    return {};
                }
            },
            fileLimitSize: { //上传文件大小限制，单位：MB
                type: Number,
                default: 30
            },
            border: {  //表格是否显示边框
                type: Boolean,
                default: true
            },
            showLast:{  //是否显示上一次导入信息
                type: Boolean,
                default: true
            },
            showFileName:{  //数据列表是否显示文件名称
                type: Boolean,
                default: true
            },
            /**
             *表格列自定义处理函数，
             *可用于屏蔽某些列或自定义列,用于扩展列信息，会传入后台配置的列信息，前端可加列宽等
             */
            columnProcess:Function,
            columnWidths:{//用于快速配置列宽，不配默认defaultColumnWidth：200
                type: Object,
                default() {
                    return {};
                }
            }
        },
        data() {
            return {
                supportType: ".xls,.xlsx",
                scheme: {}, //导入方案信息
                importSeq:-1,
                lastImportSeq:-1,
                fileList: [],//导入文件列表
                uploadFiels: [],//正在上传文件列表，分批次上传，不能全部上传，不然服务器压力过大
                parallelNum: 3, //同时上传文件数量，同时上传三个文件，防止一次上传过多文件服务器崩掉
                uploadingNum: 0,//正在上传中的数量
                loadingProcess: false,
                defaultColumnWidth:200,//列默认宽度
                editingRow:{},//正在编辑的行
                oriRow:{},//编辑前的原始行数据
                resultInfo: {
                    fileCount: 0,
                    total: 0,
                    error: 0
                },
                fileResultMapper:{},
                gridCondition:{},
                gridOrder:{prop:"id",order:"ascending"},
                treeData:{},
                fieldMapper:{},
                tooltipDisabled:false,
                activeStatus:"all",
                loadingBox:null,
                excelImportApi:new ExcelImportApi(this.module)
            };
        },
        computed: {
            uploadInfo() {
                let total = this.fileList.length;
                let success = 0;
                let error = 0;
                this.fileList.forEach(item => {
                    if (item.uploadStatus === 1) {
                        success++;
                    }
                    if (item.uploadStatus == 2) {
                        error++;
                    }
                });

                return {
                    total:total,
                    success:success,
                    error:error
                };
            },
            fileMapper(){
                let mapper = {};
                this.fileList.forEach(item => {
                    if(item.id){
                        mapper[item.id] = item;
                    }
                });
                return mapper;
            },
            requestParams(){
                return {
                    data:base64.Base64.encode(JSON.stringify(this.params))
                }
            }
        },
        created() {
            if (this.id) {
                this.fetchImportScheme();
            } else {
                throw new Error('缺失id参数，excel导入方案id不能为空！');
            }
            //加载进度条函数加入防抖功能
            this.loadFileProcess = _.debounce(this.loadFileProcess, 50);
            //上传文件函数加入防抖功能，防止同时选择多个文件多次执行
            this.uploadFiles = _.debounce(this.doUploadFiles, 500);
            this.search = _.debounce(this.search, 500);
        },
        methods: {
            /**
             * 表格查询
             */
            search(){
                this.gridCondition = {
                    importSeq: { value: this.getCurrentImportSeq(), op: "=" }
                };
                if(this.activeStatus=="success"){
                    this.gridCondition.validateStatus={value:1,op:"="};
                }
                if(this.activeStatus=="error"){
                    this.gridCondition.validateStatus={value:0,op:"="};
                }
                this.$nextTick(()=>{
                    this.$refs.dataGrid.searchForm();
                });
                this.getImportStat();
            },

            /**
             * 获取导入方案信息
             */
            fetchImportScheme() {
                this.excelImportApi.getImportConfig(this.id).then(res => {
                    this.getImportSeq();
                    this.scheme = res.data;
                    if (this.name) {
                        this.scheme.name = this.name;
                    }
                    let metadata = this.scheme.metadata;
                    if(this.columnProcess){
                        let metadata = this.columnProcess(metadata);
                        metadata = metadata ? metadata : this.scheme.metadata;
                    }
                    this.scheme.metadata = metadata;

                    this.scheme.metadata.forEach(meta=>{
                        this.$set(this.fieldMapper,meta.name,meta);
                        if(this.columnWidths[meta.name]){//设置宽度
                            this.$set(meta,"width",this.columnWidths[meta.name]);
                        }
                    });

                    this.loadTreeData();
                    if(this.showLast){
                        this.queryLastUploadInfo();
                    }
                }).catch(this.onException);
            },

            /**
             *获取树形选择数据
             */
            loadTreeData(){
                this.scheme.metadata.forEach(item=>{
                   if(item.isTree){
                       let codeId = item.format;
                       this.treeData[codeId] = [];
                       this.excelImportApi.listTreeData(item.type,codeId).then(res=>{
                           this.treeData[codeId] = res.data;
                       });
                   }
                });
            },

            /**
             * 获取导入序列号
             */
            getImportSeq() {
                this.excelImportApi.nextSequence().then(resp => {
                    this.importSeq = resp.data;
                    if(!this.showLast){
                        this.search();
                    }
                }).catch(this.onException);
            },

            /**
             * 获取导入统计信息
             */
            getImportStat(){
                this.excelImportApi.getImportStat(this.id,this.getCurrentImportSeq()).then(resp=>{
                    let data = resp.data || [];
                    let dataStat = {
                        fileCount:0,
                        total:0,
                        error:0
                    };
                    let fileMapper = {};
                    data.forEach(item=>{
                        dataStat.total += item.total;
                        dataStat.fileCount++;
                        dataStat.error += item.total-item.success;
                        fileMapper[item.uploadId] = {
                            total:item.total,
                            errCount:item.total-item.success
                        };
                    });
                    this.fileResultMapper = fileMapper;
                    this.fileList.forEach(fileInfo=>{
                        let statInfo = fileMapper[fileInfo.id];
                        this.$set(fileInfo,"total",statInfo ? statInfo.total : 0);
                        this.$set(fileInfo,"errCount",statInfo ? statInfo.errCount : 0);
                    });
                    this.resultInfo = dataStat;
                }).catch(this.onException);
            },

            /**
             *获取当前使用的序列号
             */
            getCurrentImportSeq(){
                return this.importSeq==this.lastImportSeq ? this.importSeq : this.lastImportSeq;
            },

            /**
             * 获取最后一次导入信息
             */
            queryLastUploadInfo(){
                this.excelImportApi.getLastImportSeq(this.id).then(resp => {
                    this.lastImportSeq = resp.data;
                    this.fetchLastFileList();
                }).catch(this.onException);
            },

            /**
             * 获取最后一次导入文件列表
             */
            fetchLastFileList(){
                this.excelImportApi.fetchLastFileList(this.lastImportSeq).then(resp => {
                    this.fileList = resp.data;
                    this.search();
                    if (this.fileList.some(item => {
                        return item.uploadStatus == 0;
                    })){
                        this.loadFileProcess();
                    }
                }).catch(this.onException);
            },

            /**
             *列表单元格点击事件，启用编辑功能
             */
            handleRowClick(row, column, event){
                if(!column || !column.property){
                    return;
                }
                //行被点击，保存上一行，启用当前行
                this.tooltipDisabled = true;
                if(this.editingRow.id!=row.id){
                    this.updateData();
                    this.$set(row,'_input',true);
                    this.editingRow = row;
                    this.oriRow = {...row};
                }
            },

            /**
             * 页面点击如果没在表格内取消编辑
             */
            handleOutsideClick(e){
                this.updateData();
                this.editingRow = {};
                this.oriRow = {};
                this.tooltipDisabled = false;
            },

            /**
             * 更新数据
             */
            updateData(){
                this.$set(this.editingRow,'_input',false);
                if(this.editingRow.id){
                    //保存
                    let rowData = {};
                    let updated = false;
                    for(var p in this.editingRow){
                        if(!_.startsWith(p,"_") && p!="validateResult"){
                            let value = this.editingRow[p];
                            if(value instanceof Array){//数组，说明是多选
                                rowData[p] = value.join(",");
                            }else{
                                rowData[p] = value;
                            }
                            if(this.oriRow[p]!=value){
                                updated = true;
                            }
                        }
                    }
                    if(updated==false){
                        return;
                    }
                    this.excelImportApi.update(this.id,this.getCurrentImportSeq(),[rowData],this.requestParams).then(resp=>{
                        let result = resp.data;
                        if (result.statusCode === "200") {
                            this.getImportStat();
                            let data = result.result || [];
                            let dataMapper = {};
                            let count = 0;
                            data.forEach(row=>{
                                dataMapper[row.id] = row;
                                count++;
                            });

                            let dataSource = this.$refs.dataGrid.dataSource || [];
                            let coverCount = 0;
                            for(var i=0,len=dataSource.length;i<len;i++){
                                let row = dataSource[i];
                                if(dataMapper[row.id]){
                                    this.$set(dataSource,i,dataMapper[row.id]);
                                    coverCount++;
                                    if(coverCount>=count){
                                        break;
                                    }
                                }
                            }
                        } else {
                            this.$message.error("修改数据出错："+result.message);
                        }
                    }).catch(this.onException);
                }
            },

            /**
             * 下载导入模板
             */
            handleDownloadTemplate() {
                let fileName = this.scheme.name + "-导入模板-" + dateUtils.format(new Date(), "yyyyMMddHHmmss") + "." + this.scheme.fileType;
                this.excelImportApi.downloadTemplate(this.scheme.id, fileName);
            },

            /**
             * 选择删除
             */
            handleDelete() {
               let selects = this.$refs.dataGrid.currentSelected;
               if(selects.length==0){
                   this.$message.warning("请选择数据后在进行删除！");
                   return;
               }
               this.handleDeleteData(selects);
            },

            /**
             * 删除数据
             */
            handleDeleteData(selects){
                this.$dgConfirm(`确定删除选择的数据?`, '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.showLoading("删除中，请稍后...");
                    let idArr = [];
                    selects.forEach(row=>{
                        idArr.push(row.id);
                    });
                    this.excelImportApi.delete(this.scheme.id,this.getCurrentImportSeq(),idArr,this.requestParams).then(resp=>{
                        this.hideLoading();
                        let res = resp.data;
                        if (res.statusCode == "200") {
                            this.$message.success("删除成功！");
                            this.search();
                        }else{
                            this.$message.error("删除失败："+res.message);
                        }
                    }).catch(this.onException)
                }).catch(() => {});
            },

            /**
             * 清空错误数据
             */
            handleClear() {
                this.$dgConfirm(`确定删除所有错误数据?`, '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.showLoading("删除中，请稍后...");
                    this.excelImportApi.cleanErrorData(this.scheme.id,this.getCurrentImportSeq(),this.requestParams).then(resp=>{
                        this.hideLoading();
                        let res = resp.data;
                        if (res.statusCode == "200") {
                            this.$message.success("删除成功！");
                            this.search();
                        }else{
                            this.$message.error("删除失败："+res.message);
                        }
                    }).catch(this.onException)
                }).catch(() => {});
            },

            /**
             * 导出错误数据
             */
            handleExport() {
                let fileName = "错误数据(" + this.scheme.name + ")-" + dateUtils.format(new Date(), "yyyyMMddHHmmss") + "-" + this.getCurrentImportSeq() + "." + this.scheme.fileType;
                this.excelImportApi.exportErrorData(this.scheme.id, this.getCurrentImportSeq(), fileName)
            },

            /**
             * 选择导入
             */
            handleImport() {
                let selects = this.$refs.dataGrid.currentSelected;
                if(selects.length==0){
                    this.$message.warning("请选择数据后在进行导入！");
                    return;
                }
                this.handleImportData(selects);
            },

            handleImportData(selects){
                let idArr = [];
                selects.forEach(item=>{
                    if(item.validateStatus==1){
                        idArr.push(item.id);
                    }
                });
                if(idArr.length==0){
                    this.$message.warning("您选择的数据均为无效数据，无法导入！");
                    return;
                }
                this.$dgConfirm(`确定导入选择的数据?`, '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.showLoading("导入中，请稍后...");
                    this.excelImportApi.importSelect(this.scheme.id,this.getCurrentImportSeq(),idArr,this.requestParams).then(resp=>{
                        this.hideLoading();
                        let res = resp.data;
                        if (res.statusCode == "200") {
                            this.$message.success(res.message);
                            this.search();
                        }else{
                            this.$message.error("导入失败："+res.message);
                        }
                    }).catch(this.onException)
                }).catch(() => {});
            },

            /**
             * 导入全部
             */
            handleImportAll() {
                if(this.resultInfo.total==this.resultInfo.error){
                    this.$message.warning("当前不存在可以导入的数据！");
                    return;
                }
                this.$dgConfirm(`确定导入全部有效数据?`, '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.showLoading("导入中，请稍后...");
                    this.excelImportApi.importAll(this.scheme.id,this.getCurrentImportSeq(),this.requestParams).then(resp=>{
                        this.hideLoading();
                        let res = resp.data;
                        if (res.statusCode == "200") {
                            this.$message.success(res.message);
                            this.search();
                        }else{
                            this.$message.error("导入失败："+res.message);
                        }
                    }).catch(this.onException)
                }).catch(() => {});
            },

            /**
             * 删除附件
             */
            handleDeleteFile(fileInfo) {
                //还未开始上传，直接从文件列表移除
                if(!fileInfo.id){
                  let index = _.findIndex(this.uploadFiels,item=>{return item.clientId==fileInfo.clientId});
                  if(index>-1){
                      this.uploadFiels.splice(index,1);
                      index = _.findIndex(this.fileList,item=>{return item.clientId==fileInfo.clientId});
                      index>-1 && this.fileList.splice(index,1);
                  }
                }else{
                    this.$dgConfirm(`确定删除该文件[${fileInfo.fileName}]，并清空此文件的缓存数据?`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.showLoading("删除中，请稍后...");
                        this.excelImportApi.deleteFile(this.scheme.id,this.getCurrentImportSeq(),fileInfo.id,this.requestParams).then(resp=>{
                            this.hideLoading();
                            let res = resp.data;
                            if (res.statusCode == "200") {
                                this.$message.success("删除成功！");
                                let index =  _.findIndex(this.fileList,item=>{return item.id==fileInfo.id});
                                this.fileList.splice(index,1);
                                this.search();
                            }else{
                                this.$message.error("删除失败："+res.message);
                            }
                        }).catch(this.onException)
                    }).catch(() => {});
                }
            },

            /**
             * 文件导入
             * @param param
             * @returns {boolean}
             */
            uploadFile(param) {
                let file = param.file;
                let size = file.size;
                const {scheme, importSeq, fileLimitSize, supportType} = this;
                if (size > fileLimitSize * 1024 * 1024) {
                    this.$message({message: `文件[${file.name}]上传失败，最大支持上传不大于(${fileLimitSize}M)的文件`, type: "warning"});
                    return false;
                }
                if (!supportType.split(",").includes(file.name.substring(file.name.lastIndexOf(".")))) {
                    this.$message({message: `文件[${file.name}]上传失败，仅支持上传(${supportType})后缀的文件`, type: "warning"});
                    return false;
                }
                if(this.importSeq!=this.lastImportSeq){
                    this.lastImportSeq = this.importSeq;
                    this.fileList = [];
                    this.search();
                }
                let fileInfo = {
                    index: 1,
                    clientId: this.generateUUID(),
                    fileName: file.name,
                    fileSize: size,
                    uploadStatus: 0,
                    percentage: 0,
                    uploadTime: "",
                    file: file
                }
                this.fileList.unshift(fileInfo);
                this.uploadFiels.unshift({clientId: fileInfo.clientId, file: file});
                this.doUploadFiles();
            },

            /**
             * 上传文件
             */
            doUploadFiles() {
                //找到最后面的三个文件进行上传
                while (this.uploadingNum < this.parallelNum && this.uploadFiels.length > 0) {
                    let fileInfo = this.uploadFiels.pop();
                    if (fileInfo) {
                        this.excelImportApi.importExcel(this.scheme.id, this.importSeq, fileInfo.clientId, fileInfo.file, this.requestParams).then(resp => {
                            let result = resp.data;
                            if (result.statusCode != "200") {
                                this.$message.error(result.message);
                            }
                            this.uploadingNum--;
                            if (this.uploadFiels.length > 0) {
                                this.doUploadFiles();
                            }
                        }).catch(e => {
                            this.$message.error("网络出现异常！");
                        });
                        this.uploadingNum++;
                    }
                }
                if (this.uploadingNum > 0) {
                    this.loadFileProcess();
                }
            },

            /**
             * 加载文件上传进度条
             */
            loadFileProcess() {
                if (this.loadingProcess) {
                    return;
                }
                this.loadingProcess = true;
                this.loadUploadProcess();
            },

            /**
             * 循环获取上传进度
             */
            loadUploadProcess(processVo) {
                this.excelImportApi.loadUploadProcess(this.scheme.id, this.getCurrentImportSeq()).then(resp => {
                    let res = resp.data;
                    let clientMap = {};
                    for (var i = 0, len = this.fileList.length; i < len; i++) {
                        let fileInfo = this.fileList[i];
                        clientMap[fileInfo.clientId] = i;
                    }

                    let hasFinish = false;
                    for (var clientId in res) {
                        let fileInfo = res[clientId];
                        if(this.fileResultMapper[fileInfo.id]){
                            fileInfo.total = this.fileResultMapper[fileInfo.id].total;
                            fileInfo.errCount = this.fileResultMapper[fileInfo.id].errCount;
                        }
                        this.$set(this.fileList, clientMap[clientId], fileInfo);
                        if(fileInfo.uploadStatus!=0){
                            hasFinish = true;
                        }
                    }

                    if(hasFinish){
                        this.search();
                    }

                    if (this.fileList.some(item => {
                        return item.uploadStatus == 0;
                    })) {
                        //还有没上传完的，继续刷新
                        let timer = setTimeout(() => {
                            clearTimeout(timer);
                            this.loadUploadProcess();
                        }, 1000);
                    } else {
                        //上传完成
                        this.loadingProcess = false;
                    }
                }).catch(e => {
                    //错误了重新请求
                    let timer = setTimeout(() => {
                        clearTimeout(timer);
                        this.loadUploadProcess();
                    }, 200);
                });
            },

            /**
             * 生成文件列表序号
             */
            getFileIndex(index) {
                let pagination = this.$refs.fileGrid.paginationOptions;
                return (pagination.currentPage - 1) * pagination.pageSize + index + 1;
            },

            getDataIndex(index) {
                let pagination = this.$refs.dataGrid.paginationOptions;
                return (pagination.currentPage - 1) * pagination.pageSize + index + 1;
            },

            /**
             * 格式化文件大小
             */
            parseFileSize(size) {
                var result = "";
                var sizeM = parseInt(size / (1024 * 1024));
                var sizeK = parseInt(size / 1024);
                if (sizeM > 0) {
                    result = (size / (1024 * 1024)).toFixed(2) + "MB";
                } else if (sizeK > 0) {
                    result = (size / 1024).toFixed(2) + "KB";
                } else {
                    result = size + "byte";
                }
                return result;
            },

            /**
             * 格式化上传时间
             */
            parseUploadTime(uploadTime){
                return dateUtils.strToDate(uploadTime,"yyyyMMddHHmmss","yyyy-MM-dd HH-mm-ss",false);
            },

            /**
             * 格式化错误列表
             */
            getErrorList(validateResult){
                let errs = [];
                for(var p in validateResult){
                    errs.push("<span>"+this.fieldMapper[p].display+"：</span><span style='color: #F56C6C'>"+validateResult[p]+"</span>");
                }
                return errs.join("<br/>");
            },

            /**
             *生成uuid
             * @returns {string}
             */
            generateUUID() {
                var d = new Date().getTime();
                if (window.performance && typeof window.performance.now === "function") {
                    d += performance.now();
                }
                var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = (d + Math.random() * 16) % 16 | 0;
                    d = Math.floor(d / 16);
                    return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
                return uuid;
            },
            /**
             * 处理异常信息
             */
            onException(e) {
                this.hideLoading();
                this.$message.error("网络出现异常！");
            },

            // tooltip的可控
            visibilityChange(event,row,column) {
                if(row._input){
                    this.tooltipDisabled = true;
                    return;
                }
                if(row.validateResult[column.name]){
                    this.tooltipDisabled = false;
                }else{
                    const ev = event.target|| event.srcElement;
                    const ev_height = ev.offsetHeight // 文本的实际高度
                    const content_height = ev.scrollHeight; // 文本容器高度
                    if (content_height <= ev_height) {
                        this.tooltipDisabled = true;
                    } else {
                        this.tooltipDisabled = false;
                    }
                }
            },

            /**
             * 显示遮罩
             */
            showLoading(text){
                this.loadingBox = this.$loading({
                    lock: true,
                    spinner: "el-icon-loading",
                    background: "rgba(0, 0, 0, 0.8)",
                    text: text
                });
            },

            hideLoading(){
                this.loadingBox && this.loadingBox.close();
            }

        },
        directives: {
            clickoutside
        },
        components: {}
    };
</script>

<style lang='scss'>
    .excel-import-page {
        .excel-import-bar {
            margin-bottom: 5px;
            justify-content: space-between;
            display: flex;
        }

        .file-tip {
            font-weight: bold;
            font-size: 14px;
        }

        .file-total {
            color: #409EFF;
        }

        .file-success {
            color: #67C23A;
        }

        .file-error {
            color: #F56C6C;
        }

        .excel-import-file-list {
            .excel-import-file-table {
                td {
                    font-size: 14px;
                    padding: 5px 0px;
                }

                th {
                    padding: 5px 0px;
                }

                .el-table .cell{
                    line-height: 30px;
                }
            }

            .dg-table__pagination {
                padding: 5px;

                .el-pagination__total {
                    float: left;
                }
            }
            .file-unupload{
                color: #409EFF;
            }
            .file-uploading{
                color: #67C23A;
            }
            .file-upload-error{
                color: #F56C6C;
            }
        }

        .excel-import-data-list {
            margin-top: 5px;

            .excel-import-data-tab {
                line-height: 40px;

                .el-tabs {
                    float: left;
                }

                .el-tabs__header {
                    margin: 0px 0px 5px;
                }

                .import-data-toolbar {
                    display: flex;
                    justify-content: space-between;
                    padding: 0px 0px 0px 10px;
                }
            }

            .excel-import-data-table {
                td {
                    padding: 0px 0px;
                }

                th {
                    padding: 5px 0px;
                }
            }

            .dg-table__pagination {
                padding: 5px;

                .el-pagination__total {
                    float: left;
                }
            }

            .el-table .cell{
                padding: 0px;
                line-height: 30px;
            }


            .error-column{
                color: #F56C6C;
                border: 1px solid #F56C6C;
            }

            .tooltip-wrap {
                height: 32px; // 必须要有高度设置，因为tooltip的显示条件是通过高度来判断的
                line-height: 32px;
                display: -webkit-box;
                -webkit-line-clamp: 1; // 因为通过高度所以只显示一行，溢出显示省略号
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                word-break: break-all;//英文数字折行
                margin: 1px;
                padding: 0px 5px;
            }

            .validate-status{
                font-size: 22px;
                line-height: 35px;
                &.status-success{
                    color:#67C23A;
                }
                &.status-error{
                    color:#F5222D;
                }
            }
            .ctr-btn{
                font-size: 20px;
                line-height: 35px;
            }
        }

        .excel-import-footer {
            margin-top: 10px;
            text-align: center;
        }
    }

    .slide-fade-enter-active {
        transition: all .0s ease;
    }
    .slide-fade-leave-active {
        transition: all .0s cubic-bezier(1.0, 0.5, 0.8, 1.0);
    }
    .slide-fade-enter, .slide-fade-leave-to
        /* .slide-fade-leave-active for below version 2.1.8 */ {
        transform: translateX(10px);
        opacity: 0;
    }
</style>
